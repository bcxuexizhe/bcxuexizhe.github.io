<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>轻量化的yolov8部署到安卓Android手机端 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/371758eeca465eaf7465d0dda81f7946/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="轻量化的yolov8部署到安卓Android手机端">
  <meta property="og:description" content="一、pytorch环境配置和yolov8源码安装 首先在电脑上需要配置好pytorch环境，和yolov8源码的下载
然后针对yolov8做自己的轻量化改进
二、下载Android Studio和ncnn-android-yolov8 1. Android Studio官网链接： 下载 Android Studio 和应用工具 - Android 开发者 | Android Developers
自行配置AS环境和JDK
我参考了下面这两个：
Android Studio 安装配置教程 - Windows(详细版)-CSDN博客Android Studio 开发环境快速搭建（超详细）_配置android 开发环境-CSDN博客
Android Studio 安装配置教程 - Windows(详细版)-CSDN博客 （1）JDK下载： 官网站：https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html
同意协议后，下载相应版本的JDK
（2）配置JDK及JAVA的环境 打开系统环境
打开计算机的属性/高级设置/环境变量/, 配置JAVA_HOME:
变量名：JAVA_HOME
变量值：JDK安装目录（复制jdk的路径，也就是我们前面安装JDK时设置的路径）
具体见那个链接
（3）安装cmake 注意安装的是cmake3.10版本。
手机安卓版本选择相应的安卓版本，我的是荣耀70，直接下载sdk,对应的是安卓14。
（4）出现的问题： 老项目导入可能遇到的问题 Unsupported Java. Your build is currently configured to use Java 17.0.7 and Gradle 5.4.1.
原本这个项目执行不是Java17，本地使用了更高的Java版本，因此同步需要更新gradle。
当然，可以更新gradle,但，这意味着后面有很多需要跟着改的问题。但是只是想运行下项目看下效果，结果还要改一通内容，最终很可能还不知道能否跑起来。
于是，根据条件，可以进行一下操作。
解决方案
可以设置较低的Java版本，以此来迎合Gradle 5.4.1。
——&gt;File——&gt;Project Structure——&gt;SDK location——&gt;Gradle Setting——&gt;Gradle SDK——&gt;选择个1.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-28T14:51:23+08:00">
    <meta property="article:modified_time" content="2024-01-28T14:51:23+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">轻量化的yolov8部署到安卓Android手机端</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4><strong>一、pytorch环境配置和yolov8源码安装</strong></h4> 
<p>首先在电脑上需要配置好pytorch环境，和yolov8源码的下载</p> 
<p>然后针对yolov8做自己的轻量化改进</p> 
<h4>二、下载Android Studio和ncnn-android-yolov8</h4> 
<h5><strong>1. Android Studio官网链接：</strong></h5> 
<p><a href="https://developer.android.google.cn/studio?hl=zh-cn" rel="nofollow" title="下载 Android Studio 和应用工具 - Android 开发者  |  Android Developers">下载 Android Studio 和应用工具 - Android 开发者  |  Android Developers</a></p> 
<p>自行配置AS环境和JDK</p> 
<p>我参考了下面这两个：</p> 
<p><a href="https://blog.csdn.net/qq_38436214/article/details/105073213" title="Android Studio 安装配置教程 - Windows(详细版)-CSDN博客">Android Studio 安装配置教程 - Windows(详细版)-CSDN博客</a><a href="https://blog.csdn.net/u014720022/article/details/93320488#:~:text=Android%20Studio%20%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%201.%E4%B8%8B%E8%BD%BDJDK%E3%80%81AS1.1%20JDK%E4%B8%8B%E8%BD%BD1.2%20AS%E4%B8%8B%E8%BD%BD1.3%20%E7%99%BE%E5%BA%A6%E4%BA%91%E8%B5%84%E6%BA%90%E7%BB%9F%E4%B8%80%E4%B8%8B%E8%BD%BD2.%E5%AE%89%E8%A3%85JDK3.%E9%85%8D%E7%BD%AEJDK%E5%8F%8AJAVA%E7%9A%84%E7%8E%AF%E5%A2%833.1,%E6%89%93%E5%BC%80%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%833.2%20%E9%85%8D%E7%BD%AEJAVA_HOME3.3%20%E9%85%8D%E7%BD%AECLASSPATH3.4%20%E7%BC%96%E8%BE%91path3.5%20%E6%A3%80%E6%9F%A5Java%E7%8E%AF%E5%A2%834.%E5%AE%89%E8%A3%85Android%20Studio1.%E4%B8%8B%E8%BD%BDJDK%E3%80%81AS1.1..._%E9%85%8D%E7%BD%AEandroid%20%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83" title="Android Studio 开发环境快速搭建（超详细）_配置android 开发环境-CSDN博客">Android Studio 开发环境快速搭建（超详细）_配置android 开发环境-CSDN博客</a></p> 
<h6><a href="https://blog.csdn.net/qq_38436214/article/details/105073213" title=" Android Studio 安装配置教程 - Windows(详细版)-CSDN博客"> Android Studio 安装配置教程 - Windows(详细版)-CSDN博客</a></h6> 
<h6>（1）JDK下载：</h6> 
<p>官网站：https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</p> 
<p>同意协议后，下载相应版本的JDK<img alt="" height="610" src="https://images2.imgbox.com/20/a7/2JuGNzbr_o.png" width="1200"></p> 
<p>   </p> 
<h6>（2）配置JDK及JAVA的环境</h6> 
<p><a id="31__58"></a>打开系统环境</p> 
<p>打开计算机的属性/高级设置/环境变量/,   </p> 
<p><img alt="" height="588" src="https://images2.imgbox.com/66/5d/5YGsCBQm_o.png" width="479"></p> 
<p></p> 
<p>配置JAVA_HOME:</p> 
<p>变量名：JAVA_HOME<br> 变量值：JDK安装目录（复制jdk的路径，也就是我们前面安装JDK时设置的路径）</p> 
<p>具体见那个链接</p> 
<p><img alt="" height="260" src="https://images2.imgbox.com/21/4c/xSyA4k63_o.png" width="717"></p> 
<p><img alt="" height="293" src="https://images2.imgbox.com/1e/9d/ZT9IIzCK_o.png" width="618"></p> 
<h6><strong>（3）安装cmake</strong></h6> 
<p>注意安装的是cmake3.10版本。</p> 
<p><img alt="" height="522" src="https://images2.imgbox.com/23/b4/CiVhlGZa_o.png" width="736"></p> 
<p>   手机安卓版本选择相应的安卓版本，我的是荣耀70，直接下载sdk,对应的是安卓14。</p> 
<p><img alt="" height="412" src="https://images2.imgbox.com/0d/05/sCshZhiU_o.png" width="875"></p> 
<h6>（4）出现的问题：</h6> 
<p id="articleContentId">老项目导入可能遇到的问题 Unsupported Java. <br> Your build is currently configured to use Java 17.0.7 and Gradle 5.4.1.</p> 
<p>原本这个项目执行不是Java17，本地使用了更高的Java版本，因此同步需要更新gradle。</p> 
<p>当然，可以更新gradle,但，这意味着后面有很多需要跟着改的问题。但是只是想运行下项目看下效果，结果还要改一通内容，最终很可能还不知道能否跑起来。</p> 
<p>于是，根据条件，可以进行一下操作。</p> 
<p>解决方案<br> 可以设置较低的Java版本，以此来迎合Gradle 5.4.1。</p> 
<p><img alt="" height="505" src="https://images2.imgbox.com/06/ee/3II9uuHE_o.png" width="915"><br> ——&gt;File——&gt;Project Structure——&gt;SDK location——&gt;Gradle Setting——&gt;Gradle SDK——&gt;选择个1.8的版本下载并运行吧。<br><img alt="" height="351" src="https://images2.imgbox.com/e2/54/MN9f58Ff_o.png" width="991"></p> 
<p><span style="color:#fe2c24;"><strong>或者直接在第四部分后面修改build.gradle</strong></span></p> 
<p>安装之后在android studio\bin\studio64.exe打开</p> 
<h5><strong>2. 下载ncnn-android-yolov8项目：</strong></h5> 
<p>https://github.com/FeiGeChuanShu/ncnn-android-yolov8 </p> 
<h5><strong>3. 下载opencv-mobile和ncnn-android-vulkan </strong></h5> 
<ul><li>opencv-mobile：<a href="https://gitee.com/atari/opencv-mobile" title="https://github.com/nihui/opencv-mobile">https://github.com/nihui/opencv-mobile</a></li><li>ncnn-android-vulkan：<a href="https://github.com/Tencent/ncnn/releases" title="Releases · Tencent/ncnn · GitHub">Releases · Tencent/ncnn · GitHub</a></li></ul> 
<p>将上面下载好的两个压缩包解压后放入该位置：ncnn-android-yolov8\app\src\main\jni\ 下</p> 
<p><img alt="" height="477" src="https://images2.imgbox.com/8f/78/Mwf6IOoP_o.png" width="762"></p> 
<p><strong>4.配置CMakeLists.txt文件</strong><br> 位置：ncnn-android-yolov8\app\src\main\jni\ ，</p> 
<p>利用Android Studio打开CMakeLists.txt.，然后把下面的路径更改为自己下载的：</p> 
<p><img alt="" height="294" src="https://images2.imgbox.com/f4/84/IvmzTJD8_o.png" width="886"></p> 
<h4></h4> 
<h4></h4> 
<h4>三、将自定义的数据集和改进后的模型windows训练好的pt文件转为onnx文件</h4> 
<p>具体在Ultralytics/demo.py 代码里面也有体现</p> 
<pre><code># 将模型导出为 ONNX 格式

from ultralytics import YOLO

model = YOLO("best.pt")

success = model.export(format="onnx", simplify=True, opset=12)   </code></pre> 
<p><span style="color:#fe2c24;"><strong>注意：</strong></span></p> 
<p>在安卓端使用demo项目在转换前需要对项目源码作出一些修改，修改具体见下面步骤。</p> 
<p>待修改的内容在ncnn-android-yolov8-main/doc/中有显示，如使用检测任务则修改c2f.jpg和Detect.jpg两张图片上的内容。</p> 
<p><img alt="" height="320" src="https://images2.imgbox.com/a4/03/suvIxGea_o.png" width="581"></p> 
<p>也即在<strong>windows</strong>把ultralytics项目中的下列函数修改为：</p> 
<p>文件路径：<strong>ultralytics/ultralytics/nn/modules/block.py</strong></p> 
<pre><code>class C2f(nn.Module): 
    # ...
    def forward(self, x):
        # 全部替换为
        x = self.cv1(x)
        x = [x, x[:, self.c:, ...]]
        x.extend(m(x[-1]) for m in self.m)
        x.pop(1)
        return self.cv2(torch.cat(x, 1))</code></pre> 
<p>文件路径：<strong>ultralytics/ultralytics/nn/modules/head.py</strong></p> 
<pre><code>class Detect(nn.Module):
    # ...
    def forward(self, x):
        """Concatenates and returns predicted bounding boxes and class probabilities."""
        shape = x[0].shape  # BCHW
        for i in range(self.nl):
            x[i] = torch.cat((self.cv2[i](x[i]), self.cv3[i](x[i])), 1)
        if self.training:
            return x
        elif self.dynamic or self.shape != shape:
            self.anchors, self.strides = (x.transpose(0, 1) for x in make_anchors(x, self.stride, 0.5))
            self.shape = shape
        # 中间部分注释掉，return语句替换为
        return torch.cat([xi.view(shape[0], self.no, -1) for xi in x], 2).permute(0, 2, 1)</code></pre> 
<p><span style="color:#fe2c24;">！记得保留原本的代码，这两处修改仅在格式转换时进行，如果想要重新训练，需要使用原本的代码。修改完成再执行模型格式转换的代码。</span></p> 
<p></p> 
<p>得到的文件类型为onnx格式，还需进一步转换为ncnn格式。使用<a href="https://convertmodel.com/" rel="nofollow" title="一键转换 Caffe, ONNX, TensorFlow 到 NCNN, MNN, Tengine">一键转换 Caffe, ONNX, TensorFlow 到 NCNN, MNN, Tengine</a> 即可</p> 
<p>转换后会得到两个文件，分别以bin和param做后缀。使用yolov8模型已不再需要对param文件修改。两个文件即最终集成到android端的模型文件,</p> 
<p>放到\ncnn-android-yolov8-main\ncnn-android-yolov8\app\src\main\assets</p> 
<p><img alt="" height="181" src="https://images2.imgbox.com/55/d1/VAiWMQnX_o.png" width="723"></p> 
<h4></h4> 
<h4>四 准备部署Android Studio项目</h4> 
<p>demo项目解读：</p> 
<p>yolo.cpp和yolo.h：负责加载模型，执行预测任务，返回数据结果。<br> ndkcamera.cpp和ndkcamera.h：负责摄像头相关以及实时绘制预测矩形框。<br> yolov8ncnn.cpp：JNI方法直接对应的C++文件，负责整合上述两部分。</p> 
<p>目前修改的部分均在yolo.cpp和yolov8ncnn.cpp两个文件中，可以以实时摄像的方式使用模型。<br>  </p> 
<h5><strong>1. 修改yolo.cpp文件</strong></h5> 
<p>在ncnn-android-yolov8\app\src\main\jni\ 下，修改为你自己数据集的类别数量</p> 
<p><img alt="" height="180" src="https://images2.imgbox.com/83/3e/yY9DGUTP_o.png" width="575"></p> 
<p>修改调用的模型名格式 ：</p> 
<p><img alt="" height="252" src="https://images2.imgbox.com/18/c8/0Egtl6Ha_o.png" width="627"></p> 
<p>修改节点名称：</p> 
<p>先查看自己onnx的节点名称，网站查看： https://netron.app/ </p> 
<p><img alt="" height="125" src="https://images2.imgbox.com/5c/5a/sr3QjZFN_o.png" width="180"><img alt="" height="101" src="https://images2.imgbox.com/2c/43/LApuheZs_o.png" width="280"></p> 
<p>修改文件，对应上图中的输入和输出的名称</p> 
<p><img alt="" height="248" src="https://images2.imgbox.com/38/36/5EOCtCaO_o.png" width="509"></p> 
<p>修改为自己的类别名称：</p> 
<p><img alt="" height="397" src="https://images2.imgbox.com/53/de/hmML3BFI_o.png" width="927"></p> 
<p></p> 
<h5><strong>2 修改strings.xml文件</strong></h5> 
<p>增加item,添加移动端模型选择文件：</p> 
<p>&lt;item&gt;bestXXX&lt;/item&gt;</p> 
<p>bestXXX是你训练出来的模型的名称</p> 
<p><img alt="" height="409" src="https://images2.imgbox.com/25/a4/J4vggbj0_o.png" width="667"></p> 
<p></p> 
<h5>3 修改yolov8ncnn.cpp文件</h5> 
<p>对应修改如下：</p> 
<p><img alt="" height="830" src="https://images2.imgbox.com/1f/8a/VLBdgudF_o.png" width="705"></p> 
<p>上图红框中的名称要和你导出来的bin和param中的文件名称对应 ，有多个模型，可以多放几个</p> 
<p></p> 
<h5>4.修改build.gradle</h5> 
<p>在build.gradle 修改依赖的gradle插件版本为7.2.0</p> 
<p><img alt="" height="425" src="https://images2.imgbox.com/b5/6c/7rPufdsF_o.png" width="597"></p> 
<p>在ncnn-android-yolov8-main\ncnn-android-yolov8\gradle\wrapper\<strong>gradle-wrapper.properties</strong>中：</p> 
<p>修改使用的gradle版本为7.4-all版本。</p> 
<p><img alt="" height="306" src="https://images2.imgbox.com/7e/1b/paxfp3IN_o.png" width="810"></p> 
<p><strong>重新sync项目</strong></p> 
<p></p> 
<h5>5.部署效果</h5> 
<p>找到Google USB Driver并下载，流程为点击File -&gt; Settings -&gt;Languages &amp; Frameworks -&gt; Android SDK -&gt; SDK Tools -&gt; Google USB Driver。</p> 
<p><img alt="" height="428" src="https://images2.imgbox.com/c7/0d/DQ1qTnee_o.png" width="698"></p> 
<p>手机打开-&gt;开发者模式，开启USB调试权限，手机和电脑用USB连接，允许调试</p> 
<p>通过USB将手机和电脑连接，然后选择传文件模式，不要选择仅充电。</p> 
<p>这个时候Android Studio的设备选择器中一般就有了已经连接的手机。</p> 
<p><strong><span style="color:#fe2c24;">注意荣耀和华为手机在usb配置选“以太网”，这个搞了我还几天都搞不出来</span></strong></p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/13/08/aMJwe0vG_o.jpg" width="1080"></p> 
<p>运行Android Studio项目到手机上</p> 
<p>另外app默认先打开的是前置摄像头，通过分析代码，可以知道，将MainActivity.java的40的facing的初始值从0改成1可以让app默认先打开后置摄像头。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0148bb602229e47f78f92500ad792e84/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">zookeeper未授权访问（CVE-2014-0085）漏洞修复建议</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/396e843eacb96e6691c20ef7b0313808/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AI决策的解构与实践：初探可解释性技术（XAI）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>