<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python 数据持久层ORM框架 TorToise模块（异步） - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/b671805a7ba0193a390807e3bbcdd778/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="Python 数据持久层ORM框架 TorToise模块（异步）">
  <meta property="og:description" content="文章目录 Tortoise ORM 简介Tortoise ORM 特性Tortoise ORM 安装Tortoise ORM 数据库支持Tortoise ORM 创建模型aerich 迁移工具简介aerich 迁移工具安装aerich 迁移工具使用Trotoise ORM 查询数据Trotoise ORM 修改数据Trotoise ORM 删除数据Trotoise ORM 新增数据 Tortoise ORM 简介 Tortoise ORM 是一个为异步Python应用设计的ORM（对象关系映射）库；
它允许开发者以面向对象的方式与关系型数据库进行交互，同时充分利用异步编程的优势来提高应用的性能和响应速度；
Tortoise ORM 支持多种数据库后端，如PostgreSQL、MySQL和SQLite等。
核心概念
模型（Models）：Tortoise ORM 使用Python类来定义数据库中的表结构。每个类代表一个数据库表，类的属性对应表中的列。字段（Fields）：在模型中定义字段，这些字段映射到数据库表的列。Tortoise ORM 提供了多种字段类型，如整型、字符串型、日期型等。关系（Relations）：Tortoise ORM 支持定义模型之间的关系，如一对一、一对多、多对多等。异步操作：所有数据库操作都是异步的，使用async和await关键字来执行。 应用场景
构建高性能的异步Web应用，如使用FastAPI、Sanic或Starlette的应用；需要面向对象方式操作数据库的项目。需要异步数据库访问以提高应用性能的场景。 核心功能
模型定义：通过Python类定义数据库表结构。数据查询：支持复杂的查询构建和执行。数据操作：支持创建、更新、删除数据库记录。关系管理：支持定义和查询模型之间的关系。迁移和同步：提供数据库迁移工具，用于管理数据库模式的变更。 Tortoise ORM 特性 异步特性：Tortoise ORM 的所有数据库操作都是异步的，这意味着它们可以在单线程中同时处理多个数据库请求，而不会阻塞彼此。这大大提高了应用的并发性和性能。模型定义：在Tortoise ORM 中，开发者使用Python类来定义数据库表结构。这些类中的属性对应于数据库表中的列，这使得数据库操作更加直观和易于理解。查询构建：Tortoise ORM 提供了强大的查询构建功能，允许开发者构建复杂的查询条件，以检索所需的数据。这包括使用链式调用、比较运算符、逻辑运算符等。关系映射：Tortoise ORM 支持定义模型之间的关系，如一对一、一对多、多对多等。这使得开发者可以轻松地处理复杂的数据关系，并在代码中以直观的方式表示它们。迁移和同步：Tortoise ORM 还提供了数据库迁移工具，用于管理数据库模式的变更。这使得在应用开发过程中，可以轻松地添加、修改或删除表结构，而无需手动编写SQL语句。 Tortoise ORM 安装 Tortoise ORM 属于Python的第三方库，需要额外下载安装，命令如下：
pip install tortoise-orm Tortoise ORM 数据库支持 SQLite">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-19T18:30:00+08:00">
    <meta property="article:modified_time" content="2024-03-19T18:30:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python 数据持久层ORM框架 TorToise模块（异步）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#Tortoise_ORM__4" rel="nofollow">Tortoise ORM 简介</a></li><li><a href="#Tortoise_ORM__35" rel="nofollow">Tortoise ORM 特性</a></li><li><a href="#Tortoise_ORM__45" rel="nofollow">Tortoise ORM 安装</a></li><li><a href="#Tortoise_ORM__55" rel="nofollow">Tortoise ORM 数据库支持</a></li><li><a href="#Tortoise_ORM__172" rel="nofollow">Tortoise ORM 创建模型</a></li><li><a href="#aerich__285" rel="nofollow">aerich 迁移工具简介</a></li><li><a href="#aerich__309" rel="nofollow">aerich 迁移工具安装</a></li><li><a href="#aerich__317" rel="nofollow">aerich 迁移工具使用</a></li><li><a href="#Trotoise_ORM__414" rel="nofollow">Trotoise ORM 查询数据</a></li><li><a href="#Trotoise_ORM__666" rel="nofollow">Trotoise ORM 修改数据</a></li><li><a href="#Trotoise_ORM__681" rel="nofollow">Trotoise ORM 删除数据</a></li><li><a href="#Trotoise_ORM__688" rel="nofollow">Trotoise ORM 新增数据</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h4><a id="Tortoise_ORM__4"></a>Tortoise ORM 简介</h4> 
<blockquote> 
 <p>Tortoise ORM 是一个为<strong>异步</strong>Python应用设计的ORM（对象关系映射）库；</p> 
 <p>它允许开发者<strong>以面向对象的方式与关系型数据库进行交互，同时充分利用异步编程的优势来提高应用的性能和响应速度；</strong></p> 
 <p>Tortoise ORM 支持多种数据库后端，如PostgreSQL、MySQL和SQLite等。</p> 
 <p><strong>核心概念</strong></p> 
 <ol><li><strong>模型（Models）</strong>：Tortoise ORM 使用Python类来定义数据库中的表结构。每个类代表一个数据库表，类的属性对应表中的列。</li><li><strong>字段（Fields）</strong>：在模型中定义字段，这些字段映射到数据库表的列。Tortoise ORM 提供了多种字段类型，如整型、字符串型、日期型等。</li><li><strong>关系（Relations）</strong>：Tortoise ORM 支持定义模型之间的关系，如一对一、一对多、多对多等。</li><li><strong>异步操作</strong>：所有数据库操作都是异步的，使用<code>async</code>和<code>await</code>关键字来执行。</li></ol> 
 <p><strong>应用场景</strong></p> 
 <ul><li>构建<strong>高性能的异步Web应用，如使用FastAPI、Sanic或Starlette的应用；</strong></li><li>需要面向对象方式操作数据库的项目。</li><li>需要异步数据库访问以提高应用性能的场景。</li></ul> 
 <p><strong>核心功能</strong></p> 
 <ol><li><strong>模型定义</strong>：通过Python类定义数据库表结构。</li><li><strong>数据查询</strong>：支持复杂的查询构建和执行。</li><li><strong>数据操作</strong>：支持创建、更新、删除数据库记录。</li><li><strong>关系管理</strong>：支持定义和查询模型之间的关系。</li><li><strong>迁移和同步</strong>：提供数据库迁移工具，用于管理数据库模式的变更。</li></ol> 
</blockquote> 
<hr> 
<h4><a id="Tortoise_ORM__35"></a>Tortoise ORM 特性</h4> 
<blockquote> 
 <ol><li><strong>异步特性</strong>：Tortoise ORM 的所有数据库操作都是<strong>异步</strong>的，这意味着它们<strong>可以在单线程中同时处理多个数据库请求，而不会阻塞彼此</strong>。这大大提高了应用的并发性和性能。</li><li><strong>模型定义</strong>：在Tortoise ORM 中，开发者<strong>使用Python类来定义数据库表结构</strong>。这些类中的属性对应于数据库表中的列，这使得数据库操作更加直观和易于理解。</li><li><strong>查询构建</strong>：Tortoise ORM 提供了强大的查询构建功能，允许开发者构建复杂的查询条件，以检索所需的数据。这包括使用<strong>链式调用、比较运算符、逻辑运算符等</strong>。</li><li><strong>关系映射</strong>：Tortoise ORM 支持定义模型之间的关系，<strong>如一对一、一对多、多对多等</strong>。这使得开发者可以轻松地处理复杂的数据关系，并在代码中以直观的方式表示它们。</li><li><strong>迁移和同步</strong>：Tortoise ORM 还<strong>提供了数据库迁移工具</strong>，用于管理数据库模式的变更。这使得在应用开发过程中，可以轻松地添加、修改或删除表结构，而无需手动编写SQL语句。</li></ol> 
</blockquote> 
<hr> 
<h4><a id="Tortoise_ORM__45"></a>Tortoise ORM 安装</h4> 
<blockquote> 
 <p>Tortoise ORM 属于Python的<strong>第三方库</strong>，需要额外下载安装，命令如下：</p> 
</blockquote> 
<pre><code class="prism language-python">pip install tortoise<span class="token operator">-</span>orm
</code></pre> 
<hr> 
<h4><a id="Tortoise_ORM__55"></a>Tortoise ORM 数据库支持</h4> 
<hr> 
<blockquote> 
 <p><strong>SQLite</strong></p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tortoise <span class="token keyword">import</span> Tortoise

<span class="token comment"># 配置 SQLite 数据库</span>
config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'db_url'</span><span class="token punctuation">:</span> <span class="token string">'sqlite://:memory:'</span><span class="token punctuation">,</span>  <span class="token comment"># 使用内存中的 SQLite 数据库，也可以指定文件路径</span>
    <span class="token string">'modules'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'tortoise.backends.sqlite'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'_fk'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 开启外键支持</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'generate_schemas'</span><span class="token punctuation">:</span> <span class="token boolean">True</span>  <span class="token comment"># 自动创建表结构</span>
<span class="token punctuation">}</span>

<span class="token comment"># 初始化 Tortoise ORM</span>
Tortoise<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token operator">**</span>config<span class="token punctuation">)</span>

<span class="token comment"># 创建表</span>
Tortoise<span class="token punctuation">.</span>generate_schemas<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><strong>PostgreSQL</strong></p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tortoise <span class="token keyword">import</span> Tortoise

<span class="token comment"># 配置 PostgreSQL 数据库</span>
config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'db_url'</span><span class="token punctuation">:</span> <span class="token string">'postgres://user:password@localhost/dbname'</span><span class="token punctuation">,</span>  <span class="token comment"># 替换为你的 PostgreSQL 连接信息</span>
    <span class="token string">'modules'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'tortoise.backends.postgres'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'sslmode'</span><span class="token punctuation">:</span> <span class="token string">'disable'</span>  <span class="token comment"># 可选的，根据你的 PostgreSQL 配置调整</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'generate_schemas'</span><span class="token punctuation">:</span> <span class="token boolean">True</span>  <span class="token comment"># 自动创建表结构</span>
<span class="token punctuation">}</span>

<span class="token comment"># 初始化 Tortoise ORM</span>
Tortoise<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token operator">**</span>config<span class="token punctuation">)</span>

<span class="token comment"># 创建表</span>
Tortoise<span class="token punctuation">.</span>generate_schemas<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><strong>MySQL</strong></p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tortoise <span class="token keyword">import</span> Tortoise

<span class="token comment"># 配置 MySQL 数据库</span>
TORTOISE_ORM <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"connections"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment"># "engine": "tortoise.backends.asyncpg",   # 数据库引擎 PostgresQL</span>
            <span class="token string">"engine"</span><span class="token punctuation">:</span> <span class="token string">"tortoise.backends.mysql"</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库引擎 Mysql or Mariadb</span>
            <span class="token string">"credentials"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>    <span class="token comment"># 地址</span>
                <span class="token string">"port"</span><span class="token punctuation">:</span> <span class="token string">"3306"</span><span class="token punctuation">,</span>         <span class="token comment"># 端口</span>
                <span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>         <span class="token comment"># 用户名</span>
                <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>     <span class="token comment"># 密码</span>
                <span class="token string">"database"</span><span class="token punctuation">:</span> <span class="token string">"fastapi"</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库名称（需要提前创建数据库）</span>
                <span class="token string">"minsize"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>           <span class="token comment"># 最少连接</span>
                <span class="token string">"maxsize"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>           <span class="token comment"># 最大连接</span>
                <span class="token string">"charset"</span><span class="token punctuation">:</span> <span class="token string">"utf8mb4"</span><span class="token punctuation">,</span>   <span class="token comment"># 编码</span>
                <span class="token string">"echo"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>            <span class="token comment"># 是否反馈SQL语句</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"apps"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"models"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"models"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"models"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment"># models数据模型迁移</span>
            <span class="token string">"default_connection"</span><span class="token punctuation">:</span> <span class="token string">"default"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"use_tz"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token string">"timezone"</span><span class="token punctuation">:</span> <span class="token string">"Asia/Shanghai"</span>
<span class="token punctuation">}</span>

<span class="token comment"># 初始化 Tortoise ORM</span>
Tortoise<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token operator">**</span>config<span class="token punctuation">)</span>

<span class="token comment"># 创建表</span>
Tortoise<span class="token punctuation">.</span>generate_schemas<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><strong>Oracle</strong></p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tortoise <span class="token keyword">import</span> Tortoise

config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'db_url'</span><span class="token punctuation">:</span> <span class="token string">'oracle://username:password@host:port/service_name'</span><span class="token punctuation">,</span>  <span class="token comment"># 替换为你的 Oracle 连接信息</span>
    <span class="token string">'modules'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'tortoise.backends.oracle'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment"># 这里可以配置其他 Oracle 特定的设置，如使用钱包等</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'generate_schemas'</span><span class="token punctuation">:</span> <span class="token boolean">True</span>  <span class="token comment"># 如果需要自动创建表结构，设置为 True</span>
<span class="token punctuation">}</span>

Tortoise<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token operator">**</span>config<span class="token punctuation">)</span>
</code></pre> 
<hr> 
<h4><a id="Tortoise_ORM__172"></a>Tortoise ORM 创建模型</h4> 
<blockquote> 
 <p><strong>CharField字符串类型字段</strong></p> 
 <ul><li>**max_length (int)：**字符串的最大长度。</li><li>**default (Any)：**字段的默认值。</li><li>**null (bool)：**是否允许字段为NULL。默认为False。</li><li>**unique (bool)：**字段值是否必须在数据库中唯一。默认为False。</li><li>**index (bool)：**是否为该字段创建索引。默认为False。</li><li>**description (str)：**字段的描述信息，主要用于文档和生成的SQL schema。</li><li>**pk (bool)：**是否将此字段设置为主键。默认为False。</li><li>**generated (bool)：**是否为自动生成的字段（如自增主键）。默认为False。</li></ul> 
</blockquote> 
<hr> 
<blockquote> 
 <p><strong>FloatField浮点类型字段</strong></p> 
 <ul><li><strong>default, null, unique, index, description, pk, generated：</strong> 与CharField相同。</li><li>**gt, lt, ge, le (int)：**用于设置字段值的范围限制（大于、小于、大于等于、小于等于）。</li></ul> 
</blockquote> 
<hr> 
<blockquote> 
 <p><strong>IntegerField整数类型字段</strong></p> 
 <ul><li>**default, null, unique, index, description, pk, generated：**与CharField相同。</li><li>**gt, lt, ge, le (int)：**用于设置字段值的范围限制（大于、小于、大于等于、小于等于）。</li></ul> 
</blockquote> 
<hr> 
<blockquote> 
 <p><strong>BooleanField布尔类型字段</strong></p> 
 <ul><li>**default, null, description：**与CharField相同。</li></ul> 
</blockquote> 
<hr> 
<blockquote> 
 <p><strong>DateField和DateTimeField日期时间类型字段</strong></p> 
 <ul><li>**auto_now (bool)：**如果设置为True，则在对象保存时自动设置为当前日期/时间。默认为False。</li><li>**auto_now_add (bool)：**如果设置为True，则在对象第一次保存时自动设置为当前日期/时间。默认为False。</li><li>**default, null, unique, index, description, pk：**与CharField相同。</li></ul> 
</blockquote> 
<hr> 
<blockquote> 
 <p><strong>ForeignKeyField关系型字段</strong></p> 
 <ul><li>**to (str or Type[Model])：**指定外键关联的模型。</li><li>**related_name (str)：**在关联模型上创建反向关系的名称。</li><li>**on_delete (str)：**当关联的对象被删除时的行为（如CASCADE、SET_NULL等）。</li><li>**default, null, description, pk, index：**与CharField相同。</li></ul> 
</blockquote> 
<hr> 
<blockquote> 
 <p><strong>ManyToManyField关系型字段</strong></p> 
 <ul><li><strong>through</strong>: 用于定义多对多关系的中间表。如果不指定，Tortoise ORM将自动创建一个中间表。</li><li><strong>related_name</strong>: 与ForeignKeyField中的用法相同，用于反向查询。</li><li>**default, null, description, pk, index：**与CharField相同。</li></ul> 
</blockquote> 
<hr> 
<blockquote> 
 <p><strong>TextField文本类型字段</strong></p> 
 <ul><li>**default, null, description：**与CharField相同。通常用于存储大量文本。</li></ul> 
</blockquote> 
<hr> 
<blockquote> 
 <p><strong>JSONField序列话类型字段</strong></p> 
 <ul><li>**default, null, description：**与CharField相同。用于存储JSON格式的数据。</li></ul> 
</blockquote> 
<hr> 
<blockquote> 
 <p>以选课系统为例，创建<strong>models.py</strong>文件，代码如下所示：</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tortoise<span class="token punctuation">.</span>models <span class="token keyword">import</span> Model
<span class="token keyword">from</span> tortoise <span class="token keyword">import</span> fields


<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> fields<span class="token punctuation">.</span>IntField<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> fields<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"学生姓名"</span><span class="token punctuation">)</span>
    pwd <span class="token operator">=</span> fields<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"学生密码"</span><span class="token punctuation">)</span>
    sno <span class="token operator">=</span> fields<span class="token punctuation">.</span>IntField<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"学生学号"</span><span class="token punctuation">)</span>

    <span class="token comment"># 一对多的关系</span>
    clazzs <span class="token operator">=</span> fields<span class="token punctuation">.</span>ForeignKeyField<span class="token punctuation">(</span><span class="token string">"models.Clazz"</span><span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">"students"</span><span class="token punctuation">)</span>

    <span class="token comment"># 多对多的关系</span>
    courses <span class="token operator">=</span> fields<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span><span class="token string">"models.Course"</span><span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">"students"</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Course</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> fields<span class="token punctuation">.</span>IntField<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> fields<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"课程名称"</span><span class="token punctuation">)</span>
    teacher <span class="token operator">=</span> fields<span class="token punctuation">.</span>ForeignKeyField<span class="token punctuation">(</span><span class="token string">"models.Teacher"</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Clazz</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> fields<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"班级名称"</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Teacher</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> fields<span class="token punctuation">.</span>IntField<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    tno <span class="token operator">=</span> fields<span class="token punctuation">.</span>IntField<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"教师编号"</span><span class="token punctuation">)</span>
    pwd <span class="token operator">=</span> fields<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"教师密码"</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> fields<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"教师名称"</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<h4><a id="aerich__285"></a>aerich 迁移工具简介</h4> 
<blockquote> 
 <p><code>Aerich</code> 是 <code>Tortoise ORM</code> 框架的一个插件，它负责为数据库模型生成迁移脚本。</p> 
 <p>在数据库开发中，<strong>迁移是一种管理数据库模式（即表结构）更改的方式</strong>；</p> 
 <p>当更改了模型类（例如，添加了一个新字段或更改了现有字段的类型），需要将这些更改应用到数据库中。</p> 
 <p>迁移工具允许你生成一个或多个脚本，这些脚本描述了如何将数据库从旧模式迁移到新模式。</p> 
 <p><code>Aerich</code> 的使用通常遵循以下步骤：</p> 
 <ol><li><strong>定义模型</strong>：首先，你需要在 Python 代码中定义你的数据库模型类，使用 <code>Tortoise ORM</code> 的字段类型。</li><li><strong>生成迁移</strong>：当你对模型做出更改后，你可以使用 <code>Aerich</code> 生成迁移脚本。这通常通过命令行工具完成，例如运行 <code>aerich migrate --name your_migration_name</code>。这个命令会检查模型类与当前数据库模式之间的差异，并生成一个或多个迁移脚本。</li><li><strong>应用迁移</strong>：一旦你有了迁移脚本，你可以使用 <code>Aerich</code> 将其应用到数据库中。这通常通过运行 <code>aerich upgrade</code> 命令完成。这个命令会按照定义的顺序执行迁移脚本，将数据库更新到最新的模式。</li></ol> 
 <p><code>Aerich</code> 还提供了其他功能，如<strong>回滚迁移</strong>（<code>aerich downgrade</code>）和<strong>列出所有迁移</strong>（<code>aerich show</code>）等。</p> 
 <p>使用 <code>Aerich</code> 的好处是，它允许你以一种<strong>可控制和可追踪</strong>的方式管理数据库模式的更改。</p> 
 <p>通过查看迁移脚本，可以清楚地看到每次更改的内容和顺序，这有助于在团队中协作和调试数据库问题。</p> 
</blockquote> 
<hr> 
<h4><a id="aerich__309"></a>aerich 迁移工具安装</h4> 
<pre><code class="prism language-python">pip install aerich
</code></pre> 
<hr> 
<h4><a id="aerich__317"></a>aerich 迁移工具使用</h4> 
<hr> 
<blockquote> 
 <p>初始化配置（只需要使用一次）</p> 
</blockquote> 
<pre><code class="prism language-python">aerich init <span class="token operator">-</span>t settings<span class="token punctuation">.</span>TORTOISE_ORM <span class="token comment"># TORTOISE_ORM配置的位置</span>
</code></pre> 
<blockquote> 
 <p>初始化完成会在当前目录下生成一个文件：pyproject.toml和一个文件夹：migrations</p> 
 <ul><li>pyproject.toml：<strong>保存配置文件路径</strong>，低版本可能是aerich.ini</li><li>migrations：<strong>存放迁移文件的目录</strong></li></ul> 
</blockquote> 
<p><img src="https://images2.imgbox.com/84/47/9g8Ijx7Z_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<blockquote> 
 <p>初始化数据库（一般情况下只需要使用一次，更新数据库表字段）</p> 
</blockquote> 
<pre><code class="prism language-python">aerich init<span class="token operator">-</span>db
</code></pre> 
<blockquote> 
 <p><strong>此时数据库中就会有对应数据模型的数据表格</strong><br> 如果<strong>TORTOISE_ORM</strong>配置文件中的models改了名字，则执行这条命令时需要增加**–app**参数，来指定修改的名称</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/1c/32/LhvJ2Aog_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<blockquote> 
 <p>数据迁移</p> 
</blockquote> 
<p><code>修改models类，重新生成迁移文件，比如添加一个字段</code></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Course</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> fields<span class="token punctuation">.</span>IntField<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> fields<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"课程名称"</span><span class="token punctuation">)</span>
    teacher <span class="token operator">=</span> fields<span class="token punctuation">.</span>ForeignKeyField<span class="token punctuation">(</span><span class="token string">"models.Teacher"</span><span class="token punctuation">)</span>

    <span class="token comment"># 初始化数据库后新增字段</span>
    addr <span class="token operator">=</span> fields<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"教室地址"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>

</code></pre> 
<pre><code class="prism language-python">aerich migrate <span class="token punctuation">[</span><span class="token operator">-</span><span class="token operator">-</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span>标记修改操作<span class="token punctuation">)</span>	<span class="token comment"># aerich migrate --name add_column</span>
</code></pre> 
<blockquote> 
 <p>迁移文件名称的格式为：{version_num}{datetime}{namelupdate}.json</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/10/18/0rkXyCOL_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<blockquote> 
 <p>升级：更新数据模型版本</p> 
</blockquote> 
<p>aerich-更新数据模型-更新前</p> 
<p><img src="https://images2.imgbox.com/4b/a7/Quz5yDW4_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">aerich upgrade
</code></pre> 
<p><img src="https://images2.imgbox.com/89/c8/xWVwfIln_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<blockquote> 
 <p>降级：回退数据模型版本</p> 
</blockquote> 
<pre><code class="prism language-python">aerich downgrade
</code></pre> 
<p>aerich-更新数据模型-降级后<br> <img src="https://images2.imgbox.com/ca/89/brNe4ADJ_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<blockquote> 
 <p>查看历史迁移记录</p> 
</blockquote> 
<pre><code class="prism language-python">aerich history
</code></pre> 
<p><img src="https://images2.imgbox.com/70/e1/DjFCJhkM_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h4><a id="Trotoise_ORM__414"></a>Trotoise ORM 查询数据</h4> 
<blockquote> 
 <p><code>get()</code> 方法用于根据主键获取单条数据。</p> 
 <p>如果数据不存在，将返回 <code>None</code></p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 获取id为1的用户，如果数据不存在，则抛出错误</span>
student <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 获取id为100的用户，如果数据不存在，将返回 `None`</span>
student <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span>get_or_none<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> student<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"student not found"</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><code>all()</code> 方法用于查询所有数据，返回所有数据集（QuerySet对象）。</p> 
 <p>如果不加任何条件，它会返回表中的所有记录。</p> 
</blockquote> 
<pre><code class="prism language-python">students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Queryset: [Student(), Student(), Student(), ...]</span>
<span class="token comment"># 此时不加 await 就会出现异常（线程不安全）</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> students<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><code>filter()</code> 方法用于根据条件查询数据，返回满足条件的数据集（QuerySet对象）。</p> 
 <p>可以使用 <code>all()</code> 方法获取所有的查询结果，或者使用 <code>first()</code> 方法获取第一个结果。</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 获取所有名字为'赵德柱'的数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"赵德柱"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> students<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    

<span class="token comment"># 获取第一个名字为'赵德柱'的数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"赵德柱"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> students<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>students<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> students<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"No user found"</span><span class="token punctuation">)</span>    
</code></pre> 
<hr> 
<blockquote> 
 <p>比较运算符</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 获取id等于1的数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 获取id不等于1的数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__not<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 获取id大于1的数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__gt<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 获取id大于等于1的数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__gte<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 获取id小于5的数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__lt<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 获取id小于等于5的数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__lte<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p>成员运算符</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 获取姓名 在 指定列表中的数据</span>
names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'赵德柱'</span><span class="token punctuation">,</span> <span class="token string">'李铁柱'</span><span class="token punctuation">]</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name__in<span class="token operator">=</span>names<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> students<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>


<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment"># 获取姓名 不在 指定列表中的数据</span>
names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'赵德柱'</span><span class="token punctuation">,</span> <span class="token string">'李铁柱'</span><span class="token punctuation">]</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name__nin<span class="token operator">=</span>names<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> students<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p>模糊查询</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># Tortoise ORM 不直接支持SQL中的LIKE模糊查询，</span>
<span class="token comment"># 但可以使用`icontains`、`istartswith`、`iendswith`等操作符进行模糊查询。</span>

<span class="token comment"># 学号包含200</span>
student <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>sno__icontains<span class="token operator">=</span><span class="token string">'200'</span><span class="token punctuation">)</span>

<span class="token comment"># 学号是200开头</span>
student <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>sno__istartswith<span class="token operator">=</span><span class="token string">'200'</span><span class="token punctuation">)</span>

<span class="token comment"># 学号是200结尾</span>
student <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>sno__iendswith<span class="token operator">=</span><span class="token string">'200'</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><code>exclude()</code> 方法用于排除满足条件的数据，返回不满足条件的数据集。</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 获取名字不是'赵德柱'的所有数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'赵德柱'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> students<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><code>count()</code> 方法用于统计满足条件的数据数量。</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 统计名字为'赵德柱'的数量</span>
count <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'赵德柱'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Number of users named '赵德柱': </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>count<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><code>order_by()</code> 方法用于按照指定字段排序查询结果。</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 按id升序获取所有数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> students<span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token comment"># 按id降序获取所有数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">"-id"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> students<span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><code>__range</code>查询学号在指定范围之间</p> 
</blockquote> 
<pre><code class="prism language-python">students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>sno__range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2001</span><span class="token punctuation">,</span> <span class="token number">2003</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> students<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><code>__isnull：</code>是否为空（IS NULL）</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 查询学生姓名为空的数据</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name__isnull<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><code>__regex：</code>正则表达式匹配<br> （REGEXP 或 LIKE，取决于数据库）</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 查询名字匹配正则表达式的数据</span>
pattern <span class="token operator">=</span> <span class="token string">r'^赵.*'</span>  <span class="token comment"># 以 赵 开头的名字</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name__regex<span class="token operator">=</span>pattern<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<blockquote> 
 <p><code>__iregex：</code>不区分大小写的正则表达式匹配<br> （IREGEXP 或 ILIKE，取决于数据库）</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 查询名字不区分大小写匹配正则表达式的用户</span>
pattern <span class="token operator">=</span> <span class="token string">r'^a.*'</span>  <span class="token comment"># 以 a（不区分大小写）开头的名字</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name__iregex<span class="token operator">=</span>pattern<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<hr> 
<blockquote> 
 <p><code>一对多查询、多对多查询</code></p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># values 可过滤需要的字段</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>


 <span class="token comment"># 一个学生的一对多查询</span>
 students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"赵德柱@"</span><span class="token punctuation">)</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span>students<span class="token punctuation">.</span>sno<span class="token punctuation">)</span>     <span class="token comment"># 学号，2001</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span>students<span class="token punctuation">.</span>name<span class="token punctuation">)</span>    <span class="token comment"># 姓名，赵德柱@</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span>students<span class="token punctuation">.</span>clazzs_id<span class="token punctuation">)</span>   <span class="token comment"># 班级编号（外键），1</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> students<span class="token punctuation">.</span>clazzs<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 利用外键对象查询name字段，{'name': '计算机科学与技术'}</span>



<span class="token comment"># 多个学生的一多对查询</span>
<span class="token comment"># Student.all() 查询若干个学生对象</span>
<span class="token comment"># values() 查询字段</span>
<span class="token comment"># clazzs__name：clazzs是学生对象（班级）外键关联的对象，通过外键对象查找</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"clazzs__name"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>students<span class="token punctuation">)</span>	
<span class="token comment"># [{'name': '赵德柱@', 'clazzs__name': '计算机科学与技术'}, {'name': '吴鱼子@', 'clazzs__name': '计算机科学与技术'}, {'name': '史丹利@', 'clazzs__name': '计算机科学与技术'}, {'name': '李茂山@', 'clazzs__name': '计算机科学与技术'}, {'name': 'yangkai', 'clazzs__name': '计算机科学与技术'}, {'name': 'yangkai', 'clazzs__name': '计算机科学与技术'}, {'name': 'yangkai', 'clazzs__name': '计算机科学与技术'}, {'name': 'yangkai', 'clazzs__name': '计算机科学与技术'}, {'name': '李铁柱@', 'clazzs__name': '网络编程'}, {'name': '梁小龙@', 'clazzs__name': '网络编程'}, {'name': '百灵鸟@', 'clazzs__name': '信息技术'}, {'name': '吕小布@', 'clazzs__name': '信息技术'}]</span>



<span class="token comment"># 一个学生的所有课程（一对多）对应的所有教师（多对多）</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"赵德柱@"</span><span class="token punctuation">)</span>   <span class="token comment"># 赵德柱学生对象</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> students<span class="token punctuation">.</span>courses<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 赵德柱学生所有的课程（一对多）[&lt;Course: 1&gt;, &lt;Course: 2&gt;]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> students<span class="token punctuation">.</span>courses<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 赵德柱学生所有的课程的名称（一对多）[{'name': 'Python开发'}, {'name': 'Java开发'}]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> students<span class="token punctuation">.</span>courses<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"teacher__name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 赵德柱学生所有的课程对应的教师（多对多）[{'name': 'Python开发', 'teacher__name': '李建国'}, {'name': 'Java开发', 'teacher__name': '郑忠良'}]</span>



<span class="token comment"># 多个学生的所有课程（一对多）对应的所有的教师（多对多）</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"clazzs__name"</span><span class="token punctuation">,</span> <span class="token string">"courses__name"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>students<span class="token punctuation">)</span>
<span class="token comment"># [{'name': '赵德柱@', 'clazzs__name': '计算机科学与技术', 'courses__name': 'Python开发'}, {'name': '赵德柱@', 'clazzs__name': '计算机科学与技术', 'courses__name': 'Java开发'}, {'name': '吴鱼子@', 'clazzs__name': '计算机科学与技术', 'courses__name': 'Python开发'}, {'name': '史丹利@', 'clazzs__name': '计算机科学与技术', 'courses__name': 'Python开发'}, {'name': '李茂山@', 'clazzs__name': '计算机科学与技术', 'courses__name': 'Python开发'}, {'name': '李茂山@', 'clazzs__name': '计算机科学与技术', 'courses__name': 'Java开发'}, {'name': 'yangkai', 'clazzs__name': '计算机科学与技术', 'courses__name': None}, {'name': 'yangkai', 'clazzs__name': '计算机科学与技术', 'courses__name': None}, {'name': 'yangkai', 'clazzs__name': '计算机科学与技术', 'courses__name': None}, {'name': 'yangkai', 'clazzs__name': '计算机科学与技术', 'courses__name': 'Python开发'}, {'name': 'yangkai', 'clazzs__name': '计算机科学与技术', 'courses__name': 'Java开发'}, {'name': '李铁柱@', 'clazzs__name': '网络编程', 'courses__name': 'Python开发'}, {'name': '梁小龙@', 'clazzs__name': '网络编程', 'courses__name': 'Python开发'}, {'name': '百灵鸟@', 'clazzs__name': '信息技术', 'courses__name': 'Python开发'}, {'name': '吕小布@', 'clazzs__name': '信息技术', 'courses__name': 'Python开发'}]</span>

</code></pre> 
<hr> 
<blockquote> 
 <p>分页查询</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># limit 和 offset() 方法可以用于限制返回的结果数量和跳过指定数量的结果。</span>

<span class="token comment"># 获取前5个用户</span>
first_five_sutdents <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> first_five_sutdents<span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token comment"># 跳过前5个用户，再获取5个用户</span>
next_five_students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>offset<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> next_five_students<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> 
<hr> 
<h4><a id="Trotoise_ORM__666"></a>Trotoise ORM 修改数据</h4> 
<pre><code class="prism language-python"><span class="token comment"># 根据id修改学生数据</span>
update_num <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"赵不柱"</span><span class="token punctuation">)</span>

<span class="token comment"># 批量更新</span>
students <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> student <span class="token keyword">in</span> students<span class="token punctuation">:</span>
    student<span class="token punctuation">.</span>name <span class="token operator">+=</span> <span class="token string">"@"</span>

</code></pre> 
<hr> 
<h4><a id="Trotoise_ORM__681"></a>Trotoise ORM 删除数据</h4> 
<pre><code class="prism language-python">delete_num <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<h4><a id="Trotoise_ORM__688"></a>Trotoise ORM 新增数据</h4> 
<pre><code class="prism language-python"><span class="token comment"># 单条新增</span>
create_student_object <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"张无忌"</span><span class="token punctuation">,</span> pwd<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">,</span> sno<span class="token operator">=</span><span class="token number">2009</span><span class="token punctuation">,</span> clazzs_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token comment"># 批量新增</span>
create_student_object_list <span class="token operator">=</span> <span class="token keyword">await</span> Student<span class="token punctuation">.</span>bulk_create<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>Student<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"批量新增名称"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> pwd<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">,</span> sno<span class="token operator">=</span><span class="token number">2009</span><span class="token operator">+</span>i<span class="token punctuation">,</span> clazzs_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/47c8fcccd7ab94ddce8782e55be70749/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深入理解 package.json 文件与 package-lock.json 文件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/893dc15f48834e627eec80de210df9a2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">此应用与最新版Android不兼容。请检查是否有更新，或与应用开发者联系。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>