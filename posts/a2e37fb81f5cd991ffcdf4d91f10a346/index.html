<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>手把手教你使用VScode&#43;ESP-IDF在ESP32上搭建web server，并作为web socket server进行数据交互 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/a2e37fb81f5cd991ffcdf4d91f10a346/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="手把手教你使用VScode&#43;ESP-IDF在ESP32上搭建web server，并作为web socket server进行数据交互">
  <meta property="og:description" content="准备： 装好ESP-IDF插件的VScode；ESP32开发板（ESP32-S2、ESP32-S3都行）。 步骤： 打开VScode，按F1，输入Show Examples Projects后，搜索station，创建station例程。这是一个添加ssid和密码后就能连接无线网络的例程。
打开工程，修改要连接热点的SSID与PASS
点击menuconfig后搜索“websocket”，勾选“WebSocket server support”以启用web socket，保存，退出。
- 修改Max HTTP Request Header Length为2048，以保证HTTP的报头发出不报错。
编译，并烧录进ESP32开发板中，以验证基础工程的正确性。可以看到被路由器DHCP分配到的IP为192.168.31.117。
在左侧main目录下创建 web_server.c、web_server.h、web_client.html。添加这些文件到mian目录下“CMakeLists.txt”中，其中web_client.html的路径添加为EMBED_FILES，如果设计的页面有图片，图片路径也要添加其中，用空格隔开。
idf_component_register(SRCS &#34;station_example_main.c&#34; &#34;web_server.c&#34; INCLUDE_DIRS &#34;.&#34; EMBED_FILES &#34;web_client.html&#34; ) 在web_client.html中随便添些HTML代码，设计了一个简单的页面，寻到web_client.html文件存放目录，双击运行。若只是在修改页面效果，可将客户端连接的地址固定，在VScode修改保存后在浏览器中按F5刷新，能直接看到最新设计效果。用JavaScript语言，创建客户端套接字“ws_client”，JavaScript代码添加在HTML代码的下方。此处设计的功能为：将从web server收到的字符串数据打印log和显示在条框中，并回发给服务器。此脚本嵌入在ESP32的flash后，在使用时，将会在被HTTP客户端请求时发出去。 &lt;!DOCTYPE html&gt; &lt;html lang=&#34;en&#34;&gt; &lt;head&gt; &lt;meta charset=&#34;UTF-8&#34;&gt; &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1.0&#34;&gt; &lt;title&gt;HTTP Page&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;Web Client.&lt;/h1&gt; &lt;p style=&#34;display: inline;&#34;&gt;&lt;label for=&#34;textID&#34;&gt;收到数据:&lt;/label&gt;&lt;/p&gt; &lt;input type=&#34;text&#34; id=&#34;textID&#34; value=&#34;&#34;&gt; &lt;/body&gt; &lt;/html&gt; &lt;script&gt; //服务器地址 //烧录进ESP32时使用 &#34;ws://&#34;&#43;window.location.host&#43;&#34;/ws&#34; //调试html时直接写 &#34;ws://192.168.31.117/ws&#34; const ws_client = new WebSocket(&#34;ws://&#34;&#43;window.location.host&#43;&#34;/ws&#34;); /*ws_client连接成功事件*/ ws_client.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-28T14:30:13+08:00">
    <meta property="article:modified_time" content="2024-05-28T14:30:13+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">手把手教你使用VScode&#43;ESP-IDF在ESP32上搭建web server，并作为web socket server进行数据交互</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>准备：</h3> 
<ul><li>装好ESP-IDF插件的VScode；</li><li>ESP32开发板（ESP32-S2、ESP32-S3都行）。</li></ul> 
<h3><a id="_3"></a>步骤：</h3> 
<ul><li>打开VScode，按F1，输入Show Examples Projects后，搜索station，创建station例程。这是一个添加ssid和密码后就能连接无线网络的例程。<br> <img src="https://images2.imgbox.com/5e/fe/7yY1OYJY_o.png" alt="在这里插入图片描述"></li><li>打开工程，修改要连接热点的SSID与PASS<br> <img src="https://images2.imgbox.com/f1/dd/I6oz0X5i_o.png" alt="在这里插入图片描述"></li><li>点击menuconfig后搜索“websocket”，勾选“WebSocket server support”以启用web socket，保存，退出。<br> <img src="https://images2.imgbox.com/98/8a/T5iIqdc9_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/45/2a/j1filioD_o.png" alt="在这里插入图片描述"> - 修改Max HTTP Request Header Length为2048，以保证HTTP的报头发出不报错。<br> <img src="https://images2.imgbox.com/26/22/rgKxZsYD_o.png" alt="在这里插入图片描述"></li><li>编译，并烧录进ESP32开发板中，以验证基础工程的正确性。可以看到被路由器DHCP分配到的IP为192.168.31.117。<br> <img src="https://images2.imgbox.com/21/9b/Hhl8J4Sl_o.png" alt="在这里插入图片描述"></li><li>在左侧main目录下创建 web_server.c、web_server.h、web_client.html。添加这些文件到mian目录下“CMakeLists.txt”中，其中web_client.html的路径添加为EMBED_FILES，如果设计的页面有图片，图片路径也要添加其中，用空格隔开。<br> <img src="https://images2.imgbox.com/db/a5/eJphrzb0_o.png" alt="在这里插入图片描述"></li></ul> 
<pre><code class="prism language-clike"><span class="token function">idf_component_register</span><span class="token punctuation">(</span>SRCS <span class="token string">"station_example_main.c"</span> <span class="token string">"web_server.c"</span>
                    INCLUDE_DIRS <span class="token string">"."</span>
                    EMBED_FILES <span class="token string">"web_client.html"</span>
                    <span class="token punctuation">)</span>
</code></pre> 
<ul><li>在<strong>web_client.html</strong>中随便添些HTML代码，设计了一个简单的页面，寻到web_client.html文件存放目录，双击运行。若只是在修改页面效果，可将客户端连接的地址固定，在VScode修改保存后在浏览器中按F5刷新，能直接看到最新设计效果。</li><li>用JavaScript语言，创建客户端套接字“ws_client”，JavaScript代码添加在HTML代码的下方。此处设计的功能为：将从web server收到的字符串数据打印log和显示在条框中，并回发给服务器。</li><li>此脚本嵌入在ESP32的flash后，在使用时，将会在被HTTP客户端请求时发出去。</li></ul> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>HTTP Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Web Client.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span> inline<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>textID<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>收到数据:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>textID<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">//服务器地址    </span>
<span class="token comment">//烧录进ESP32时使用 "ws://"+window.location.host+"/ws" </span>
<span class="token comment">//调试html时直接写 "ws://192.168.31.117/ws"</span>
<span class="token keyword">const</span> ws_client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">"ws://"</span><span class="token operator">+</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token operator">+</span><span class="token string">"/ws"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*ws_client连接成功事件*/</span>
ws_client<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*ws_client错误事件*/</span>
ws_client<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*ws_client接收数据*/</span>
ws_client<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token function">data_processing</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取数据交给别的函数处理</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*数据处理*/</span>
<span class="token keyword">function</span> <span class="token function">data_processing</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//打印在调试框</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"textID"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> data<span class="token punctuation">;</span> <span class="token comment">//显示在ID为"textID"的条框中</span>
    ws_client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发给服务器</span>
<span class="token punctuation">}</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2e/5d/r6sXP5Ut_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bb/f9/EqxoPXNC_o.png" alt="在这里插入图片描述"></p> 
<ul><li>在<strong>web_server.h</strong>中添加web_server_init()的声明</li></ul> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_WEB_SERVER_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_WEB_SERVER_H_</span></span>

<span class="token keyword">void</span> <span class="token function">web_server_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<ul><li>在<strong>web_server.c</strong>中添加web server函数主体。函数主要包括web server初始化，websocket客户端管理，websocket数据接收回调函数，websocket数据接收处理任务，uri注册回调函数，http时间处理，websocket数据发送函数。说明全都在注释里。</li></ul> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"web_server.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/FreeRTOS.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/task.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/queue.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_http_server.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_LEN</span>  <span class="token expression"><span class="token number">1024</span>  </span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> data<span class="token punctuation">[</span>BUFFER_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token keyword">int</span> client_socket<span class="token punctuation">;</span>
<span class="token punctuation">}</span>DATA_PARCEL<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token class-name">httpd_handle_t</span> web_server_handle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//ws服务器唯一句柄</span>
<span class="token keyword">static</span> QueueHandle_t  ws_server_rece_queue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//收到的消息传给任务处理</span>
<span class="token keyword">static</span> QueueHandle_t  ws_server_send_queue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//异步发送队列</span>

<span class="token comment">/*此处只是管理ws socket server发送时的对象，以确保多客户端连接的时候都能收到数据，并不能限制HTTP请求*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WS_CLIENT_QUANTITY_ASTRICT</span> <span class="token expression"><span class="token number">5</span>    </span><span class="token comment">//客户端数量</span></span>
<span class="token keyword">static</span> <span class="token keyword">int</span> WS_CLIENT_LIST<span class="token punctuation">[</span>WS_CLIENT_QUANTITY_ASTRICT<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//客户端套接字列表</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> WS_CLIENT_NUM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//实际连接数量</span>

<span class="token comment">/*客户端列表 记录客户端套接字*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ws_client_list_add</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*检查是否超出限制*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>WS_CLIENT_NUM<span class="token operator">&gt;=</span>WS_CLIENT_QUANTITY_ASTRICT<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*检查是否重复*/</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> WS_CLIENT_QUANTITY_ASTRICT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>WS_CLIENT_LIST<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> socket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>

    <span class="token comment">/*添加套接字至列表中*/</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> WS_CLIENT_QUANTITY_ASTRICT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>WS_CLIENT_LIST<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            WS_CLIENT_LIST<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> socket<span class="token punctuation">;</span> <span class="token comment">//获取返回信息的客户端套接字</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ws_client_list_add:%d\r\n"</span><span class="token punctuation">,</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            WS_CLIENT_NUM<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*客户端列表 删除客户端套接字*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ws_client_list_delete</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> WS_CLIENT_QUANTITY_ASTRICT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>WS_CLIENT_LIST<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> socket<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            WS_CLIENT_LIST<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ws_client_list_delete:%d\r\n"</span><span class="token punctuation">,</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            WS_CLIENT_NUM<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>WS_CLIENT_NUM<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                WS_CLIENT_NUM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*ws服务器接收数据*/</span>
<span class="token keyword">static</span> DATA_PARCEL ws_rece_parcel<span class="token punctuation">;</span>  
<span class="token keyword">static</span> <span class="token class-name">esp_err_t</span> <span class="token function">ws_server_rece_data</span><span class="token punctuation">(</span><span class="token class-name">httpd_req_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>method <span class="token operator">==</span> HTTP_GET<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ws_client_list_add</span><span class="token punctuation">(</span><span class="token function">httpd_req_to_sockfd</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ESP_OK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">esp_err_t</span> ret <span class="token operator">=</span> ESP_FAIL<span class="token punctuation">;</span>
    <span class="token class-name">httpd_ws_frame_t</span> ws_pkt<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ws_pkt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">httpd_ws_frame_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ws_rece_parcel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DATA_PARCEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws_pkt<span class="token punctuation">.</span>type <span class="token operator">=</span> HTTPD_WS_TYPE_TEXT<span class="token punctuation">;</span>
    ws_pkt<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>ws_rece_parcel<span class="token punctuation">.</span>data<span class="token punctuation">;</span>   <span class="token comment">//指向缓存区</span>
    ret <span class="token operator">=</span> <span class="token function">httpd_ws_recv_frame</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ws_pkt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置参数max_len = 0来获取帧长度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> ESP_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ws_server_rece_data data receiving failure!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws_pkt<span class="token punctuation">.</span>len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">httpd_ws_recv_frame</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ws_pkt<span class="token punctuation">,</span> ws_pkt<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*设置参数max_len 为 ws_pkt.len以获取帧有效负载 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> ESP_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ws_server_rece_data data receiving failure!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ws_rece_parcel<span class="token punctuation">.</span>len <span class="token operator">=</span> ws_pkt<span class="token punctuation">.</span>len<span class="token punctuation">;</span>
        ws_rece_parcel<span class="token punctuation">.</span>client_socket <span class="token operator">=</span> <span class="token function">httpd_req_to_sockfd</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">xQueueSend</span><span class="token punctuation">(</span>ws_server_rece_queue <span class="token punctuation">,</span><span class="token operator">&amp;</span>ws_rece_parcel<span class="token punctuation">,</span><span class="token function">pdMS_TO_TICKS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> ESP_OK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ws_pkt.len&lt;=0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*WEB SOCKET*/</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">httpd_uri_t</span> ws <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>uri        <span class="token operator">=</span> <span class="token string">"/ws"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>method     <span class="token operator">=</span> HTTP_GET<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>handler    <span class="token operator">=</span> ws_server_rece_data<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>user_ctx   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>is_websocket <span class="token operator">=</span> true
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*首页HTML GET处理程序 */</span>
<span class="token keyword">static</span> <span class="token class-name">esp_err_t</span> <span class="token function">home_get_handler</span><span class="token punctuation">(</span><span class="token class-name">httpd_req_t</span> <span class="token operator">*</span>req<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/*获取脚本web_client.html的存放地址和大小，接受http请求时将脚本发出去*/</span>
    <span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> upload_script_start<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"_binary_web_client_html_start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*web_client.html文件在bin中的位置*/</span>
    <span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> upload_script_end<span class="token punctuation">[</span><span class="token punctuation">]</span>   <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"_binary_web_client_html_end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">size_t</span> upload_script_size <span class="token operator">=</span> <span class="token punctuation">(</span>upload_script_end <span class="token operator">-</span> upload_script_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">httpd_resp_send</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>upload_script_start<span class="token punctuation">,</span> upload_script_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ESP_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*首页HTML*/</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">httpd_uri_t</span> home <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>uri       <span class="token operator">=</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>method    <span class="token operator">=</span> HTTP_GET<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>handler   <span class="token operator">=</span> home_get_handler<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>user_ctx  <span class="token operator">=</span> <span class="token constant">NULL</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/*http事件处理*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ws_event_handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> <span class="token class-name">esp_event_base_t</span> event_base<span class="token punctuation">,</span><span class="token class-name">int32_t</span> event_id<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> event_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event_base <span class="token operator">==</span> ESP_HTTP_SERVER_EVENT <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>event_id<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> HTTP_SERVER_EVENT_ERROR <span class="token operator">:</span><span class="token comment">//当执行过程中出现错误时，将发生此事件</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HTTP_SERVER_EVENT_START  <span class="token operator">:</span><span class="token comment">//此事件在HTTP服务器启动时发生</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HTTP_SERVER_EVENT_ON_CONNECTED  <span class="token operator">:</span><span class="token comment">//一旦HTTP服务器连接到客户端，就不会执行任何数据交换</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HTTP_SERVER_EVENT_ON_HEADER  <span class="token operator">:</span><span class="token comment">//在接收从客户端发送的每个报头时发生</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HTTP_SERVER_EVENT_HEADERS_SENT  <span class="token operator">:</span><span class="token comment">//在将所有标头发送到客户端之后</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HTTP_SERVER_EVENT_ON_DATA  <span class="token operator">:</span><span class="token comment">//从客户端接收数据时发生</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HTTP_SERVER_EVENT_SENT_DATA <span class="token operator">:</span><span class="token comment">//当ESP HTTP服务器会话结束时发生</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HTTP_SERVER_EVENT_DISCONNECTED  <span class="token operator">:</span><span class="token comment">//连接已断开</span>
                esp_http_server_event_data<span class="token operator">*</span> event <span class="token operator">=</span> <span class="token punctuation">(</span>esp_http_server_event_data<span class="token operator">*</span><span class="token punctuation">)</span>event_data<span class="token punctuation">;</span>
                <span class="token function">ws_client_list_delete</span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HTTP_SERVER_EVENT_STOP   <span class="token operator">:</span><span class="token comment">//当HTTP服务器停止时发生此事件</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token comment">/*异步发送函数，将其放入HTTPD工作队列*/</span>
<span class="token keyword">static</span> DATA_PARCEL async_buffer<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ws_async_send</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">xQueueReceive</span><span class="token punctuation">(</span>ws_server_send_queue<span class="token punctuation">,</span><span class="token operator">&amp;</span>async_buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">httpd_ws_frame_t</span> ws_pkt <span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        ws_pkt<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>async_buffer<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        ws_pkt<span class="token punctuation">.</span>len <span class="token operator">=</span> async_buffer<span class="token punctuation">.</span>len<span class="token punctuation">;</span>
        ws_pkt<span class="token punctuation">.</span>type <span class="token operator">=</span> HTTPD_WS_TYPE_TEXT<span class="token punctuation">;</span>
        <span class="token function">httpd_ws_send_frame_async</span><span class="token punctuation">(</span>web_server_handle<span class="token punctuation">,</span> async_buffer<span class="token punctuation">.</span>client_socket<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ws_pkt<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*ws 发送函数*/</span>
<span class="token keyword">static</span> DATA_PARCEL send_buffer<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ws_server_send</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> data <span class="token punctuation">,</span><span class="token class-name">uint32_t</span> len <span class="token punctuation">,</span> <span class="token keyword">int</span> client_socket<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>send_buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>send_buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    send_buffer<span class="token punctuation">.</span>client_socket <span class="token operator">=</span> client_socket<span class="token punctuation">;</span>
    send_buffer<span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>send_buffer<span class="token punctuation">.</span>data<span class="token punctuation">,</span>data<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">xQueueSend</span><span class="token punctuation">(</span>ws_server_send_queue <span class="token punctuation">,</span><span class="token operator">&amp;</span>send_buffer<span class="token punctuation">,</span><span class="token function">pdMS_TO_TICKS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">httpd_queue_work</span><span class="token punctuation">(</span>web_server_handle<span class="token punctuation">,</span> ws_async_send<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进入排队</span>
<span class="token punctuation">}</span>


<span class="token comment">/*数据发送任务，每隔一秒发送一次*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ws_server_send_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> task_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"Hello World! %ld"</span><span class="token punctuation">,</span>task_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> WS_CLIENT_QUANTITY_ASTRICT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>WS_CLIENT_LIST<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">ws_server_send</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>WS_CLIENT_LIST<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span>
        task_count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token function">pdMS_TO_TICKS</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*数据接收处理任务*/</span>
<span class="token keyword">static</span> DATA_PARCEL rece_buffer<span class="token punctuation">;</span>   
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ws_server_rece_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">xQueueReceive</span><span class="token punctuation">(</span>ws_server_rece_queue<span class="token punctuation">,</span><span class="token operator">&amp;</span>rece_buffer<span class="token punctuation">,</span>portMAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"socket : %d\tdata len : %d\tpayload : %s\r\n"</span><span class="token punctuation">,</span>rece_buffer<span class="token punctuation">.</span>client_socket<span class="token punctuation">,</span>rece_buffer<span class="token punctuation">.</span>len<span class="token punctuation">,</span>rece_buffer<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/*web服务器初始化*/</span>
<span class="token keyword">void</span> <span class="token function">web_server_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">httpd_config_t</span> config <span class="token operator">=</span> <span class="token function">HTTPD_DEFAULT_CONFIG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动httpd服务器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">httpd_start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>web_server_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">)</span> <span class="token operator">==</span> ESP_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"web_server_start\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error starting ws server!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">esp_event_handler_instance_register</span><span class="token punctuation">(</span>ESP_HTTP_SERVER_EVENT<span class="token punctuation">,</span>ESP_EVENT_ANY_ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ws_event_handler<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册处理程序</span>
    <span class="token function">httpd_register_uri_handler</span><span class="token punctuation">(</span>web_server_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>home<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册uri处理程序</span>
    <span class="token function">httpd_register_uri_handler</span><span class="token punctuation">(</span>web_server_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册uri处理程序</span>

    <span class="token comment">/*创建接收队列*/</span>
    ws_server_rece_queue <span class="token operator">=</span> <span class="token function">xQueueCreate</span><span class="token punctuation">(</span>  <span class="token number">3</span> <span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DATA_PARCEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws_server_rece_queue <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ws_server_rece_queue ERROR\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*创建发送队列*/</span>
    ws_server_send_queue <span class="token operator">=</span> <span class="token function">xQueueCreate</span><span class="token punctuation">(</span>  <span class="token number">3</span> <span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DATA_PARCEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws_server_send_queue <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ws_server_send_queue ERROR\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    BaseType_t xReturn <span class="token punctuation">;</span>
    <span class="token comment">/*创建接收处理任务*/</span>
    xReturn <span class="token operator">=</span> <span class="token function">xTaskCreatePinnedToCore</span><span class="token punctuation">(</span>ws_server_rece_task<span class="token punctuation">,</span><span class="token string">"ws_server_rece_task"</span><span class="token punctuation">,</span><span class="token number">4096</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span> tskNO_AFFINITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>xReturn <span class="token operator">!=</span> pdPASS<span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"xTaskCreatePinnedToCore ws_server_rece_task error!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*创建发送任务，此任务不是必须的，因为发送函数可以放在任意地方*/</span>
    xReturn <span class="token operator">=</span> <span class="token function">xTaskCreatePinnedToCore</span><span class="token punctuation">(</span>ws_server_send_task<span class="token punctuation">,</span><span class="token string">"ws_server_send_task"</span><span class="token punctuation">,</span><span class="token number">4096</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span> tskNO_AFFINITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>xReturn <span class="token operator">!=</span> pdPASS<span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"xTaskCreatePinnedToCore ws_server_send_task error!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>将web_server_init()添加到app_main()中</li></ul> 
<p><img src="https://images2.imgbox.com/19/f6/IGoZymFI_o.png" alt="在这里插入图片描述"></p> 
<ul><li>编译，烧录到ESP32中，电脑与ESP32连接同一个局域网，在电脑浏览器中输入路由器给ESP32分配的IP：192.168.31.117，回车。</li></ul> 
<p><img src="https://images2.imgbox.com/f5/2d/iHKHrRWV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_377"></a>资源获取</h3> 
<p>免费下载链接：<a href="https://download.csdn.net/download/weixin_45775305/89342420">ESP32_web_server.zip</a></p> 
<h3><a id="_379"></a>结束语</h3> 
<ul><li>HTTP协议的服务器不能主动发消息客户端，但web socket协议可以。这教程只是搭一个web server的底层架子，如何玩出花来还望各位看官。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6d0c332ae7709d7b6a01d3e731adb958/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL8.0.35简介</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fe0de5a1f30c8e12d5c4a77d04406fb9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mysql 单行转多行，把逗号分隔的字段拆分成多行</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>