<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android App 启动流程学习 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/eb07a0657186cf4d17b537d5e5aa5e45/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="Android App 启动流程学习">
  <meta property="og:description" content="App启动 壹、App启动流程图贰、流程图详细解读2.1、系统操作Zygote 进程的孵化应用资源和类加载App在启动后立即显示应用的空白启动窗口创建应用进程 2.2、进程开始步骤3、ActivityThread 被加载到内存中步骤3.2、ActivityThread.main()步骤4、ActivityManagerService.attachApplication()步骤5.1步骤6.1、ApplicationThread.bindApplication()步骤7.1、ActivityThread.H 接收BIND_APPLICATIONLoadedApk.makeApplication()Instrumentation.newApplication() 步骤5.2、步骤6.2、ApplicationThread.scheduleLaunchActivity()步骤7.2、ActivityThread.H 接收LAUNCH_ACTIVITY 步骤8.2、handleLaunchActivityperformLaunchActivity 叁、API3.1、ActivityThread3.2、ApplicationThread3.3、ActivityManagerService3.4、ActivityStackSupervisor 参考地址 壹、App启动流程图 Android 更新后方法略不同，如下是8左右的源码。
https://www.jianshu.com/p/538dcfac774d
简述：
点击桌面应用程序图标时，Launcher的startActivity()方法通过Binder通信调用系统进程中的ActivityManagerService（AMS）的startActivity方法，启动应用程序。
系统进程（system_server）收到请求后，向Zygote进程发送创建应用程序进程的请求。
Zygote进程根据请求fork出应用程序进程，并执行应用程序的ActivityThread.main()方法。在此过程中，应用程序的主线程初始化了MainLooper和主线程Handler，并创建了ApplicationThread用于与AMS通信和协作。
应用程序进程通过Binder向system_server进程发送attachApplication请求。这实际上是应用程序进程通过Binder调用system_server进程中AMS的attachApplication方法，用于将ApplicationThread对象与AMS绑定。
system_server进程在收到attachApplication请求后，进行一些准备工作，然后通过Binder IPC向应用程序进程发送handleBindApplication请求（用于初始化Application并调用onCreate方法）和scheduleLaunchActivity请求（用于创建启动Activity）。
应用程序进程的Binder线程（ApplicationThread）收到请求后，通过Handler向主线程发送BIND_APPLICATION和LAUNCH_ACTIVITY消息。这里要注意的是，AMS和主线程并不直接通信，而是通过AMS和主线程的内部类ApplicationThread之间通过Binder通信，然后再通过Handler消息交互。
主线程收到消息后，创建Application并调用onCreate方法，然后通过反射机制创建目标Activity，并回调Activity的onCreate等方法。至此，应用程序正式启动，进入Activity的生命周期，依次执行onCreate、onStart、onResume方法，完成UI渲染并显示应用程序的主界面。
贰、流程图详细解读 2.1、系统操作 Zygote 进程的孵化 在应用启动之前，系统通常会先启动 Zygote 进程，Zygote 进程会在后台预加载一些系统类库和资源，以加速进程的创建。Zygote 进程在内部执行 main() 方法，创建 Android Runtime 环境，并等待新应用进程的请求。 应用资源和类加载 当用户启动应用或触发其他应用组件时，Zygote 进程会根据应用的包名加载应用的资源（如布局文件、字符串资源等）和类。Zygote 进程会充当应用进程的模板，根据应用的包名和所需的资源加载应用的代码和资源。 App在启动后立即显示应用的空白启动窗口 空白窗口由谁创建？？
在 Android 应用的启动过程中，这个短暂的背景通常是由系统自动创建和管理的，不需要开发者直接介入。具体来说，这个背景的创建和显示是由 Android 系统的窗口管理服务和系统框架负责处理的。
Android 系统会在应用启动时显示这个背景，以提供用户反馈并在后台进行应用的初始化。这个背景会在应用的主 Activity 准备好并开始显示用户界面之前显示。
开发者可以通过设置应用的主题和启动画面来自定义这个短暂的背景。主题和启动画面是应用外观和启动过程的一部分，允许开发者指定应用的标志、颜色、背景等。应用的主题和启动画面的设置可以在 AndroidManifest.xml 文件中进行定义。
总之，这个短暂的背景是由 Android 系统自动创建和管理的，以提供用户反馈和平滑的应用启动过渡。它不需要开发者直接创建或操作。
创建应用进程 应用进程（Application Process）：
应用进程是 Android 操作系统中运行应用的一个独立的执行单元。
每个应用都运行在其自己的应用进程中，这意味着每个应用都有独立的内存空间，独立的虚拟机（Dalvik 或 ART），以及独立的运行环境。
应用进程负责执行应用的各个组件，如 Activity、Service、Broadcast Receiver 等。每个组件都在应用进程中运行。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-17T15:11:19+08:00">
    <meta property="article:modified_time" content="2023-11-17T15:11:19+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android App 启动流程学习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>App启动</h4> 
 <ul><li><a href="#App_4" rel="nofollow">壹、App启动流程图</a></li><li><a href="#_37" rel="nofollow">贰、流程图详细解读</a></li><li><ul><li><a href="#21_39" rel="nofollow">2.1、系统操作</a></li><li><ul><li><a href="#Zygote__43" rel="nofollow">Zygote 进程的孵化</a></li><li><a href="#_47" rel="nofollow">应用资源和类加载</a></li><li><a href="#App_52" rel="nofollow">App在启动后立即显示应用的空白启动窗口</a></li><li><a href="#_62" rel="nofollow">创建应用进程</a></li></ul> 
   </li><li><a href="#22_74" rel="nofollow">2.2、进程开始</a></li><li><ul><li><a href="#3ActivityThread__78" rel="nofollow">步骤3、ActivityThread 被加载到内存中</a></li><li><a href="#32ActivityThreadmain_96" rel="nofollow">步骤3.2、ActivityThread.main()</a></li><li><a href="#4ActivityManagerServiceattachApplication_174" rel="nofollow">步骤4、ActivityManagerService.attachApplication()</a></li><li><a href="#51_232" rel="nofollow">步骤5.1</a></li><li><a href="#61ApplicationThreadbindApplication_240" rel="nofollow">步骤6.1、ApplicationThread.bindApplication()</a></li><li><a href="#71ActivityThreadH__261" rel="nofollow">步骤7.1、ActivityThread.H 接收</a></li><li><ul><li><a href="#BIND_APPLICATION_263" rel="nofollow">BIND_APPLICATION</a></li><li><a href="#LoadedApkmakeApplication_390" rel="nofollow">LoadedApk.makeApplication()</a></li><li><a href="#InstrumentationnewApplication_456" rel="nofollow">Instrumentation.newApplication()</a></li></ul> 
    </li><li><a href="#52_477" rel="nofollow">步骤5.2、</a></li><li><a href="#62ApplicationThreadscheduleLaunchActivity_532" rel="nofollow">步骤6.2、ApplicationThread.scheduleLaunchActivity()</a></li><li><a href="#72ActivityThreadH__550" rel="nofollow">步骤7.2、ActivityThread.H 接收</a></li><li><ul><li><a href="#LAUNCH_ACTIVITY_551" rel="nofollow">LAUNCH_ACTIVITY</a></li></ul> 
    </li><li><a href="#82handleLaunchActivity_569" rel="nofollow">步骤8.2、handleLaunchActivity</a></li><li><ul><li><a href="#performLaunchActivity_625" rel="nofollow">performLaunchActivity</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#API_754" rel="nofollow">叁、API</a></li><li><ul><li><ul><li><a href="#31ActivityThread_756" rel="nofollow">3.1、ActivityThread</a></li><li><a href="#32ApplicationThread_821" rel="nofollow">3.2、ApplicationThread</a></li><li><a href="#33ActivityManagerService_883" rel="nofollow">3.3、ActivityManagerService</a></li><li><a href="#34ActivityStackSupervisor_888" rel="nofollow">3.4、ActivityStackSupervisor</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_891" rel="nofollow">参考地址</a></li></ul> 
</div> 
<p></p> 
<h2><a id="App_4"></a>壹、App启动流程图</h2> 
<p>Android 更新后方法略不同，如下是8左右的源码。</p> 
<p><img src="https://images2.imgbox.com/97/8a/7Nqx5LXe_o.png" alt="请添加图片描述"></p> 
<p><a href="https://www.jianshu.com/p/538dcfac774d" rel="nofollow">https://www.jianshu.com/p/538dcfac774d</a></p> 
<p>简述：</p> 
<ol><li> <p>点击桌面应用程序图标时，Launcher的<code>startActivity()</code>方法通过Binder通信调用系统进程中的ActivityManagerService（AMS）的<code>startActivity</code>方法，启动应用程序。</p> </li><li> <p>系统进程（system_server）收到请求后，向Zygote进程发送创建应用程序进程的请求。</p> </li><li> <p>Zygote进程根据请求fork出应用程序进程，并执行应用程序的<code>ActivityThread.main()</code>方法。在此过程中，应用程序的主线程初始化了MainLooper和主线程Handler，并创建了<code>ApplicationThread</code>用于与AMS通信和协作。</p> </li><li> <p>应用程序进程通过Binder向system_server进程发送<code>attachApplication</code>请求。这实际上是应用程序进程通过Binder调用system_server进程中AMS的<code>attachApplication</code>方法，用于将<code>ApplicationThread</code>对象与AMS绑定。</p> </li><li> <p>system_server进程在收到<code>attachApplication</code>请求后，进行一些准备工作，然后通过Binder IPC向应用程序进程发送<code>handleBindApplication</code>请求（用于初始化Application并调用<code>onCreate</code>方法）和<code>scheduleLaunchActivity</code>请求（用于创建启动Activity）。</p> </li><li> <p>应用程序进程的Binder线程（<code>ApplicationThread</code>）收到请求后，通过Handler向主线程发送<code>BIND_APPLICATION</code>和<code>LAUNCH_ACTIVITY</code>消息。这里要注意的是，AMS和主线程并不直接通信，而是通过AMS和主线程的内部类<code>ApplicationThread</code>之间通过Binder通信，然后再通过Handler消息交互。</p> </li><li> <p>主线程收到消息后，创建<code>Application</code>并调用<code>onCreate</code>方法，然后通过反射机制创建目标Activity，并回调Activity的<code>onCreate</code>等方法。至此，应用程序正式启动，进入Activity的生命周期，依次执行<code>onCreate</code>、<code>onStart</code>、<code>onResume</code>方法，完成UI渲染并显示应用程序的主界面。</p> </li></ol> 
<h2><a id="_37"></a>贰、流程图详细解读</h2> 
<h3><a id="21_39"></a>2.1、系统操作</h3> 
<p><img src="https://images2.imgbox.com/38/12/5XjrxGxc_o.png" alt="请添加图片描述"></p> 
<h4><a id="Zygote__43"></a>Zygote 进程的孵化</h4> 
<ul><li>在应用启动之前，系统通常会先启动 Zygote 进程，Zygote 进程会在后台预加载一些系统类库和资源，以加速进程的创建。</li><li>Zygote 进程在内部执行 <code>main()</code> 方法，创建 Android Runtime 环境，并等待新应用进程的请求。</li></ul> 
<h4><a id="_47"></a>应用资源和类加载</h4> 
<ul><li>当用户启动应用或触发其他应用组件时，Zygote 进程会根据应用的包名加载应用的资源（如布局文件、字符串资源等）和类。</li><li>Zygote 进程会充当应用进程的模板，根据应用的包名和所需的资源加载应用的代码和资源。</li></ul> 
<h4><a id="App_52"></a>App在启动后立即显示应用的空白启动窗口</h4> 
<blockquote> 
 <p>空白窗口由谁创建？？<br> 在 Android 应用的启动过程中，这个短暂的背景通常是由系统自动创建和管理的，不需要开发者直接介入。具体来说，这个背景的创建和显示是由 Android 系统的窗口管理服务和系统框架负责处理的。<br> Android 系统会在应用启动时显示这个背景，以提供用户反馈并在后台进行应用的初始化。这个背景会在应用的主 Activity 准备好并开始显示用户界面之前显示。<br> 开发者可以通过设置应用的主题和启动画面来自定义这个短暂的背景。主题和启动画面是应用外观和启动过程的一部分，允许开发者指定应用的标志、颜色、背景等。应用的主题和启动画面的设置可以在 AndroidManifest.xml 文件中进行定义。<br> 总之，这个短暂的背景是由 Android 系统自动创建和管理的，以提供用户反馈和平滑的应用启动过渡。它不需要开发者直接创建或操作。</p> 
</blockquote> 
<h4><a id="_62"></a>创建应用进程</h4> 
<blockquote> 
 <p>应用进程（Application Process）：<br> 应用进程是 Android 操作系统中运行应用的一个独立的执行单元。<br> 每个应用都运行在其自己的应用进程中，这意味着每个应用都有独立的内存空间，独立的虚拟机（Dalvik 或 ART），以及独立的运行环境。<br> 应用进程负责执行应用的各个组件，如 Activity、Service、Broadcast Receiver 等。每个组件都在应用进程中运行。<br> 应用进程的生命周期由 Android 系统管理，系统可以在需要时创建、销毁或重启应用进程。</p> 
</blockquote> 
<h3><a id="22_74"></a>2.2、进程开始</h3> 
<h4><a id="3ActivityThread__78"></a>步骤3、ActivityThread 被加载到内存中</h4> 
<p>ActivityThread.main() 是进程被创建后就会被调用，但是不是主线程创建了就会立刻拉起Activity，而是继续和AMS通信。</p> 
<p><a href="https://www.cnblogs.com/mingfeng002/p/10323668.html" rel="nofollow">https://www.cnblogs.com/mingfeng002/p/10323668.html</a></p> 
<p>另外ActivityThread在Android中它就代表了Android的主线程，但是并不是一个Thread类。</p> 
<blockquote> 
 <p>严格来说，UI主线程不是ActivityThread。<br> ActivityThread类是Android APP进程的初始类，它的main函数是这个APP进程的入口。<br> APP进程中UI事件的执行代码段都是由ActivityThread提供的。<br> 也就是说，Main Thread实例是存在的，只是创建它的代码我们不可见。ActivityThread的main函数就是在这个Main Thread里被执行的。</p> 
</blockquote> 
<h4><a id="32ActivityThreadmain_96"></a>步骤3.2、ActivityThread.main()</h4> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter">String<span class="token punctuation">[</span><span class="token punctuation">]</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//各种初始化操作，省略</span>
    
    
    <span class="token comment">//初始化主线程的Looper，一个线程只能有一个Looper</span>
    Looper<span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ActivityThread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//在attach方法中会完成Application对象的初始化，然后调用Application的onCreate()方法</span>
    thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainThreadHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sMainThreadHandler <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//在主线程开启循环读取消息队列中的消息</span>
    Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token parameter">boolean system<span class="token punctuation">,</span> long startSeq</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    sCurrentActivityThread <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    mSystemThread <span class="token operator">=</span> system<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//如果应用进程</span>
        android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span>DdmHandleAppName<span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"&lt;pre-initialized&gt;"</span><span class="token punctuation">,</span>
                                                UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将mAppThread放到RuntimeInit类中的静态变量,也就是ApplicationThreadNative中的 this</span>
        RuntimeInit<span class="token punctuation">.</span><span class="token function">setApplicationObject</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//跨进程通讯，获取AMS在APP进程的代理</span>
        final IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//将mAppThread传入ActivityManagerService中</span>
            mgr<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>RemoteException ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 监听内存限制</span>
        BinderInternal<span class="token punctuation">.</span><span class="token function">addGcWatcher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            @Override <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSomeActivitiesChanged<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Runtime runtime <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                long dalvikMax <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">maxMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                long dalvikUsed <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> runtime<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//当虚拟机已使用内存超过最大内存的四分之三时，ActivityTaskManager释放一些Activity</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dalvikUsed <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>dalvikMax<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mSomeActivitiesChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        ActivityTaskManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">releaseSomeActivities</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>RemoteException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//通过system_server启动ActivityThread对象</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 为 ViewRootImpl 设置配置更新回调，</span>
    ViewRootImpl<span class="token punctuation">.</span>ConfigChangedCallback configChangedCallback
            <span class="token operator">=</span> <span class="token punctuation">(</span>Configuration globalConfig<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter">mResourcesManager</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">...</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//添加配置回调</span>
    ViewRootImpl<span class="token punctuation">.</span><span class="token function">addConfigCallback</span><span class="token punctuation">(</span>configChangedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="4ActivityManagerServiceattachApplication_174"></a>步骤4、ActivityManagerService.attachApplication()</h4> 
<pre><code class="prism language-javascript"><span class="token number">7020</span>      @Override
<span class="token number">7021</span>      <span class="token keyword">public</span> final <span class="token keyword">void</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token parameter">IApplicationThread thread</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">7022</span>          <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">7023</span>              int callingPid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7024</span>              final long origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7025</span>              <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> callingPid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7026</span>              Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7027</span>          <span class="token punctuation">}</span>
<span class="token number">7028</span>      <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> boolean <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span><span class="token parameter">@NonNull IApplicationThread thread<span class="token punctuation">,</span>
        int pid<span class="token punctuation">,</span> int callingUid<span class="token punctuation">,</span> long startSeq</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token operator">...</span><span class="token punctuation">.</span>
    
    <span class="token comment">//ApplicationThread调用bindApplication，ApplicationThread是ActivityThread的内部类</span>
    thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> providerList<span class="token punctuation">,</span>···<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token operator">...</span><span class="token punctuation">.</span>
    
    <span class="token comment">//查看这个进程中是否有顶部可见的activity正在等待运行…（10以后的版本，之前跟这基本一致）</span>
<span class="token number">6955</span>          <span class="token comment">// See if the top visible activity is waiting to run in this process...</span>
<span class="token number">6956</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>normalMode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6957</span>              <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6958</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span><span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6959</span>                      didSomething <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">6960</span>                  <span class="token punctuation">}</span>
<span class="token number">6961</span>              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6962</span>                  Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Exception thrown launching activities in "</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6963</span>                  badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">6964</span>              <span class="token punctuation">}</span>
<span class="token number">6965</span>          <span class="token punctuation">}</span>

<span class="token number">6967</span>          <span class="token comment">// Find any services that should be running in this process...</span>
<span class="token number">6968</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>badApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6969</span>              <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6970</span>                  didSomething <span class="token operator">|=</span> mServices<span class="token punctuation">.</span><span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6971</span>                  <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">"attachApplicationLocked: after mServices.attachApplicationLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6972</span>              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6973</span>                  Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Exception thrown starting services in "</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6974</span>                  badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">6975</span>              <span class="token punctuation">}</span>
<span class="token number">6976</span>          <span class="token punctuation">}</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="http://androidxref.com/6.0.0_r1/xref/frameworks/base/core/java/android/app/ActivityThread.java#ApplicationThread" rel="nofollow">http://androidxref.com/6.0.0_r1/xref/frameworks/base/core/java/android/app/ActivityThread.java#ApplicationThread</a></p> 
<h4><a id="51_232"></a>步骤5.1</h4> 
<p>如上</p> 
<pre><code class="prism language-javascript">thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> providerList<span class="token punctuation">,</span>···<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>方法中的thread就是IApplicationThread，就是ApplicationThread在AMS中的代理</p> 
<h4><a id="61ApplicationThreadbindApplication_240"></a>步骤6.1、ApplicationThread.bindApplication()</h4> 
<p>给ActivityThread的Handler发送bindApplication消息</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> final <span class="token keyword">void</span> <span class="token function">bindApplication</span><span class="token punctuation">(</span><span class="token parameter">String processName<span class="token punctuation">,</span> <span class="token operator">...</span>
                ContentCaptureOptions contentCaptureOptions<span class="token punctuation">,</span> long<span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>services <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ServiceManager<span class="token punctuation">.</span><span class="token function">initServiceCache</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">setCoreSettings</span><span class="token punctuation">(</span>coreSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>

    AppBindData data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppBindData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>processName <span class="token operator">=</span> processName<span class="token punctuation">;</span>
	<span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token constant">H</span><span class="token punctuation">.</span><span class="token constant">BIND_APPLICATION</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="71ActivityThreadH__261"></a>步骤7.1、ActivityThread.H 接收</h4> 
<h5><a id="BIND_APPLICATION_263"></a>BIND_APPLICATION</h5> 
<p>Handler接收到消息并处理BindApplication</p> 
<pre><code class="prism language-javascript"><span class="token number">1658</span>                  <span class="token keyword">case</span> <span class="token constant">BIND_APPLICATION</span><span class="token operator">:</span>
<span class="token number">1659</span>                      Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"bindApplication"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1660</span>                      AppBindData data <span class="token operator">=</span> <span class="token punctuation">(</span>AppBindData<span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
<span class="token number">1661</span>                      <span class="token function">handleBindApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1662</span>                      Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1663</span>                      <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<p>各种初始化，创建application实例并调用application的onCreate</p> 
<pre><code class="prism language-javascript"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindApplication</span><span class="token punctuation">(</span><span class="token parameter">AppBindData data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//在运行时将当前执行线程注册为敏感线程</span>
    VMRuntime<span class="token punctuation">.</span><span class="token function">registerSensitiveThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
    <span class="token comment">//标记进程起始时间</span>
    Process<span class="token punctuation">.</span><span class="token function">setStartTimes</span><span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
    <span class="token comment">//设置进程名字</span>
    Process<span class="token punctuation">.</span><span class="token function">setArgV0</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//设置一个标记位，androidQ及以上版本一些不明确数组相关的类会抛出数组越界异常</span>
    <span class="token comment">//例如[SparseArray的keyAt和setValueAt在Q之前的版本不会抛出异常](/https://blog.csdn.net/wzz18749670290/article/details/109352466)</span>
    UtilConfig<span class="token punctuation">.</span><span class="token function">setThrowExceptionForUpperArrayOutOfBounds</span><span class="token punctuation">(</span>
                data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span><span class="token constant">VERSION_CODES</span><span class="token punctuation">.</span><span class="token constant">Q</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//androidP之前用BitmapFactory解码Bitmap，会放大density。android P及以后，用ImageDecoder解码Bitmap，会跳过upscale节约内存</span>
    ImageDecoder<span class="token punctuation">.</span>sApiLevel <span class="token operator">=</span> data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">;</span>
    
    <span class="token comment">//重置系统时区</span>
    TimeZone<span class="token punctuation">.</span><span class="token function">setDefault</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//断点调试相关</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>debugMode <span class="token operator">!=</span> ApplicationThreadConstants<span class="token punctuation">.</span><span class="token constant">DEBUG_OFF</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// XXX should have option to change the port.</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token comment">//渲染调试相关</span>
    boolean isAppDebuggable <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span><span class="token constant">FLAG_DEBUGGABLE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    HardwareRenderer<span class="token punctuation">.</span><span class="token function">setDebuggingEnabled</span><span class="token punctuation">(</span>isAppDebuggable <span class="token operator">||</span> Build<span class="token punctuation">.</span><span class="token constant">IS_DEBUGGABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    HardwareRenderer<span class="token punctuation">.</span><span class="token function">setPackageName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//初始化HTTP代理</span>
    final IBinder b <span class="token operator">=</span> ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span><span class="token constant">CONNECTIVITY_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        final IConnectivityManager service <span class="token operator">=</span> IConnectivityManager<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Proxy<span class="token punctuation">.</span><span class="token function">setHttpProxySystemProperty</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getProxyForNetwork</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>RemoteException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//创建Instrumentation并初始化</span>
    <span class="token comment">// Continue loading instrumentation.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ii <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ApplicationInfo instrApp<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            instrApp <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>ii<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>RemoteException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            instrApp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instrApp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            instrApp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ii<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>instrApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        instrApp<span class="token punctuation">.</span><span class="token function">initForUser</span><span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        final LoadedApk pi <span class="token operator">=</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>instrApp<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">,</span>
                appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        final ContextImpl instrContext <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pi<span class="token punctuation">,</span>
                appContext<span class="token punctuation">.</span><span class="token function">getOpPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//通过ClassLoader创建Instrumentation</span>
            final ClassLoader cl <span class="token operator">=</span> instrContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentation <span class="token operator">=</span> <span class="token punctuation">(</span>Instrumentation<span class="token punctuation">)</span>
                cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationName<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token operator">...</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//初始化Instrumentation</span>
        final ComponentName component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>ii<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> ii<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> instrContext<span class="token punctuation">,</span> appContext<span class="token punctuation">,</span> component<span class="token punctuation">,</span>
                data<span class="token punctuation">.</span>instrumentationWatcher<span class="token punctuation">,</span> data<span class="token punctuation">.</span>instrumentationUiAutomationConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">basicInit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token operator">...</span>
    
    

    Application app<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建application，这里面会调用application的attachBaseContext，这里的info对应的class是LoadedApk.java，最终也是通过classLoader创建Application</span>
        app <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//这里调用installProvider()-&gt;AppComponentFactory.instantiateProvider-&gt;</span>
                <span class="token comment">//localProvider.attachInfo()-&gt;ContentProvider.onCreate();</span>
                <span class="token comment">//看到这里就明白了为什么LeakCanary2.0不需要在Application中手动初始化</span>
                <span class="token function">installContentProviders</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//调用application的onCreate</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//预加载字体资源</span>
    FontsContract<span class="token punctuation">.</span><span class="token function">setApplicationContextForResources</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在mInstrumentation.newApplication之前，创建了App的Context，具体实现类是ContextImpl</p> 
<p>然后创建App时传入了该Context，即App持有该Context</p> 
<p>创建App之后ContextImpl调用了setOuterContext(app)，使得该Context持有了App的引用。这也是为什么我们可以context.getApplicationContext()</p> 
<h5><a id="LoadedApkmakeApplication_390"></a>LoadedApk.makeApplication()</h5> 
<p><a href="http://androidxref.com/6.0.0_r1/xref/frameworks/base/core/java/android/app/LoadedApk.java" rel="nofollow">http://androidxref.com/6.0.0_r1/xref/frameworks/base/core/java/android/app/LoadedApk.java</a></p> 
<pre><code class="prism language-javascript"><span class="token number">554</span>    <span class="token keyword">public</span> Application <span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token parameter">boolean forceDefaultAppClass<span class="token punctuation">,</span>
<span class="token number">555</span>            Instrumentation instrumentation</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">556</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mApplication <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">557</span>            <span class="token keyword">return</span> mApplication<span class="token punctuation">;</span>
<span class="token number">558</span>        <span class="token punctuation">}</span>
<span class="token number">559</span>
<span class="token number">560</span>        Application app <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">561</span>
<span class="token number">562</span>        String appClass <span class="token operator">=</span> mApplicationInfo<span class="token punctuation">.</span>className<span class="token punctuation">;</span>
<span class="token number">563</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceDefaultAppClass <span class="token operator">||</span> <span class="token punctuation">(</span>appClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">564</span>            appClass <span class="token operator">=</span> <span class="token string">"android.app.Application"</span><span class="token punctuation">;</span>
<span class="token number">565</span>        <span class="token punctuation">}</span>
<span class="token number">566</span>
<span class="token number">567</span>        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">568</span>            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">569</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPackageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">570</span>                <span class="token function">initializeJavaContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">571</span>            <span class="token punctuation">}</span>
<span class="token number">572</span>            ContextImpl appContext <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span>mActivityThread<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">573</span>            app <span class="token operator">=</span> mActivityThread<span class="token punctuation">.</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">newApplication</span><span class="token punctuation">(</span>
<span class="token number">574</span>                    cl<span class="token punctuation">,</span> appClass<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">575</span>            appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">576</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">577</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mActivityThread<span class="token punctuation">.</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">578</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
<span class="token number">579</span>                    <span class="token string">"Unable to instantiate application "</span> <span class="token operator">+</span> appClass
<span class="token number">580</span>                    <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">581</span>            <span class="token punctuation">}</span>
<span class="token number">582</span>        <span class="token punctuation">}</span>
<span class="token number">583</span>        mActivityThread<span class="token punctuation">.</span>mAllApplications<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">584</span>        mApplication <span class="token operator">=</span> app<span class="token punctuation">;</span>
<span class="token number">585</span>
<span class="token number">586</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instrumentation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">587</span>            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">588</span>                instrumentation<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">589</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">590</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">591</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
<span class="token number">592</span>                        <span class="token string">"Unable to create application "</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">593</span>                        <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">594</span>                <span class="token punctuation">}</span>
<span class="token number">595</span>            <span class="token punctuation">}</span>
<span class="token number">596</span>        <span class="token punctuation">}</span>
<span class="token number">597</span>
<span class="token number">598</span>        <span class="token comment">// Rewrite the R 'constants' for all library apks.</span>
<span class="token number">599</span>        SparseArray<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> packageIdentifiers <span class="token operator">=</span> <span class="token function">getAssets</span><span class="token punctuation">(</span>mActivityThread<span class="token punctuation">)</span>
<span class="token number">600</span>                <span class="token punctuation">.</span><span class="token function">getAssignedPackageIdentifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">601</span>        final int <span class="token constant">N</span> <span class="token operator">=</span> packageIdentifiers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">602</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">603</span>            final int id <span class="token operator">=</span> packageIdentifiers<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">604</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token operator">||</span> id <span class="token operator">==</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">605</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">606</span>            <span class="token punctuation">}</span>
<span class="token number">607</span>
<span class="token number">608</span>            <span class="token function">rewriteRValues</span><span class="token punctuation">(</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> packageIdentifiers<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">609</span>        <span class="token punctuation">}</span>
<span class="token number">610</span>
<span class="token number">611</span>        <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token number">612</span>    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="InstrumentationnewApplication_456"></a>Instrumentation.newApplication()</h5> 
<p>http://androidxref.com/6.0.0_r1/xref/frameworks/base/core/java/android/app/Instrumentation.java</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> Application <span class="token function">newApplication</span><span class="token punctuation">(</span>ClassLoader cl<span class="token punctuation">,</span> String className<span class="token punctuation">,</span> Context context<span class="token punctuation">)</span>
        throws InstantiationException<span class="token punctuation">,</span> IllegalAccessException<span class="token punctuation">,</span> 
        ClassNotFoundException <span class="token punctuation">{<!-- --></span>
    Application app <span class="token operator">=</span> <span class="token function">getFactory</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">instantiateApplication</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用Application的attach    </span>
    app<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span><span class="token parameter">Application app</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//调用Application的onCreate   </span>
    app<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="52_477"></a>步骤5.2、</h4> 
<pre><code class="prism language-javascript"><span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span><span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> 
</code></pre> 
<p>会调到<code>ActivityStackSupervisor</code>类中</p> 
<p><a href="http://aospxref.com/android-8.0.0_r36/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java" rel="nofollow">http://aospxref.com/android-8.0.0_r36/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</a></p> 
<pre><code class="prism language-javascript"><span class="token number">957</span>      boolean <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">)</span> throws RemoteException <span class="token punctuation">{<!-- --></span>

    			<span class="token operator">...</span><span class="token punctuation">.</span>

<span class="token number">972</span>                              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>hr<span class="token punctuation">,</span> app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">973</span>                                  didSomething <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">974</span>                              <span class="token punctuation">}</span>

				<span class="token operator">...</span><span class="token punctuation">.</span>

<span class="token number">984</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSomething<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">985</span>              <span class="token function">ensureActivitiesVisibleLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">!</span><span class="token constant">PRESERVE_WINDOWS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">986</span>          <span class="token punctuation">}</span>
<span class="token number">987</span>          <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span>
<span class="token number">988</span>      <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript"><span class="token number">1325</span>      final boolean <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> ProcessRecord app<span class="token punctuation">,</span>
<span class="token number">1326</span>              boolean andResume<span class="token punctuation">,</span> boolean checkConfig<span class="token punctuation">)</span> throws RemoteException <span class="token punctuation">{<!-- --></span>
<span class="token number">1327</span>  		  <span class="token comment">//等到所有的onPause()方法执行结束才会去启动新的Activity</span>
<span class="token number">1328</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">allPausedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1335</span>              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">1336</span>          <span class="token punctuation">}</span>
				
				<span class="token operator">...</span><span class="token punctuation">.</span>

<span class="token number">1466</span>  			<span class="token comment">//调用ApplicationThread的scheduleLaunchActivity用于启动一个Activity</span>
<span class="token number">1467</span>              app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleLaunchActivity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
<span class="token number">1468</span>                      System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
<span class="token number">1469</span>                      <span class="token comment">// TODO: Have this take the merged configuration instead of separate global and</span>
<span class="token number">1470</span>                      <span class="token comment">// override configs.</span>
<span class="token number">1471</span>                      mergedConfiguration<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token number">1472</span>                      mergedConfiguration<span class="token punctuation">.</span><span class="token function">getOverrideConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>compat<span class="token punctuation">,</span>
<span class="token number">1473</span>                      r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> app<span class="token punctuation">.</span>repProcState<span class="token punctuation">,</span> r<span class="token punctuation">.</span>icicle<span class="token punctuation">,</span>
<span class="token number">1474</span>                      r<span class="token punctuation">.</span>persistentState<span class="token punctuation">,</span> results<span class="token punctuation">,</span> newIntents<span class="token punctuation">,</span> <span class="token operator">!</span>andResume<span class="token punctuation">,</span>
<span class="token number">1475</span>                      mService<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> profilerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token operator">...</span><span class="token punctuation">.</span>

<span class="token number">1548</span>  
<span class="token number">1549</span>          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">1550</span>      <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="62ApplicationThreadscheduleLaunchActivity_532"></a>步骤6.2、ApplicationThread.scheduleLaunchActivity()</h4> 
<pre><code class="prism language-javascript"><span class="token number">748</span>          <span class="token comment">// we use token to identify this activity without having to send the</span>
<span class="token number">749</span>          <span class="token comment">// activity itself back to the activity manager. (matters more with ipc)</span>
<span class="token number">750</span>          @Override
<span class="token number">751</span>          <span class="token keyword">public</span> final <span class="token keyword">void</span> <span class="token function">scheduleLaunchActivity</span><span class="token punctuation">(</span><span class="token parameter">Intent intent<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span> int ident<span class="token punctuation">,</span>
<span class="token number">752</span>                  ActivityInfo info<span class="token punctuation">,</span> Configuration curConfig<span class="token punctuation">,</span> Configuration overrideConfig<span class="token punctuation">,</span>
<span class="token number">753</span>                  CompatibilityInfo compatInfo<span class="token punctuation">,</span> String referrer<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">,</span>
<span class="token number">754</span>                  int procState<span class="token punctuation">,</span> Bundle state<span class="token punctuation">,</span> PersistableBundle persistentState<span class="token punctuation">,</span>
<span class="token number">755</span>                  List<span class="token operator">&lt;</span>ResultInfo<span class="token operator">&gt;</span> pendingResults<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>ReferrerIntent<span class="token operator">&gt;</span> pendingNewIntents<span class="token punctuation">,</span>
<span class="token number">756</span>                  boolean notResumed<span class="token punctuation">,</span> boolean isForward<span class="token punctuation">,</span> ProfilerInfo profilerInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">757</span>  
					<span class="token operator">...</span><span class="token punctuation">.</span>
				
<span class="token number">783</span>              <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token constant">H</span><span class="token punctuation">.</span><span class="token constant">LAUNCH_ACTIVITY</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">784</span>          <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="72ActivityThreadH__550"></a>步骤7.2、ActivityThread.H 接收</h4> 
<h5><a id="LAUNCH_ACTIVITY_551"></a>LAUNCH_ACTIVITY</h5> 
<pre><code class="prism language-javascript"><span class="token number">1584</span>          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token parameter">Message msg</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1585</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"&gt;&gt;&gt; handling: "</span> <span class="token operator">+</span> <span class="token function">codeToString</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1586</span>              <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1587</span>                  <span class="token keyword">case</span> <span class="token constant">LAUNCH_ACTIVITY</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">1588</span>                      Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"activityStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1589</span>                      final ActivityClientRecord r <span class="token operator">=</span> <span class="token punctuation">(</span>ActivityClientRecord<span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
<span class="token number">1590</span>  
<span class="token number">1591</span>                      r<span class="token punctuation">.</span>packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>
<span class="token number">1592</span>                              r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1593</span>                      <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"LAUNCH_ACTIVITY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1594</span>                      Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1595</span>                  <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="82handleLaunchActivity_569"></a>步骤8.2、handleLaunchActivity</h4> 
<pre><code class="prism language-javascript"><span class="token number">2872</span>      <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span><span class="token parameter">ActivityClientRecord r<span class="token punctuation">,</span> Intent customIntent<span class="token punctuation">,</span> String reason</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token number">2874</span>          <span class="token comment">//如果我们在进入后台后准备gc，那么我们回到活动状态，所以跳过它。</span>
			
				<span class="token operator">...</span><span class="token punctuation">.</span>

<span class="token number">2883</span>          <span class="token comment">//确保我们正在运行最新的配置。</span>

<span class="token number">2889</span>          <span class="token comment">// 创建活动之前进行初始化</span>
<span class="token number">2890</span>          WindowManagerGlobal<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2891</span>  
<span class="token number">2892</span>          Activity a <span class="token operator">=</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2893</span>  
				<span class="token comment">// 一些关于onResume还是finish的判断</span>
<span class="token number">2894</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2895</span>              r<span class="token punctuation">.</span>createdConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>mConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2896</span>              <span class="token function">reportSizeConfigurations</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2897</span>              Bundle oldState <span class="token operator">=</span> r<span class="token punctuation">.</span>state<span class="token punctuation">;</span>

				<span class="token comment">// 这里会调用到 ActivityClientRecord.activity.performResume()，判断是否 onResume调用</span>
<span class="token number">2898</span>              <span class="token function">handleResumeActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>isForward<span class="token punctuation">,</span>
<span class="token number">2899</span>                      <span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>startsNotResumed<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastProcessedSeq<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2900</span>  
<span class="token number">2901</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>startsNotResumed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2902</span>                  <span class="token comment">// The activity manager actually wants this one to start out paused, because it</span>
<span class="token number">2903</span>                  <span class="token comment">// needs to be visible but isn't in the foreground. We accomplish this by going</span>
<span class="token number">2904</span>                  <span class="token comment">// through the normal startup (because activities expect to go through onResume()</span>
<span class="token number">2905</span>                  <span class="token comment">// the first time they run, before their window is displayed), and then pausing it.</span>
<span class="token number">2906</span>                  <span class="token comment">// However, in this case we do -not- need to do the full pause cycle (of freezing</span>
<span class="token number">2907</span>                  <span class="token comment">// and such) because the activity manager assumes it can just retain the current</span>
<span class="token number">2908</span>                  <span class="token comment">// state it has.</span>
<span class="token number">2909</span>                  <span class="token function">performPauseActivityIfNeeded</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2910</span>  
<span class="token number">2911</span>                  <span class="token comment">// We need to keep around the original state, in case we need to be created again.</span>
<span class="token number">2912</span>                  <span class="token comment">// But we only do this for pre-Honeycomb apps, which always save their state when</span>
<span class="token number">2913</span>                  <span class="token comment">// pausing, so we can not have them save their state when restarting from a paused</span>
<span class="token number">2914</span>                  <span class="token comment">// state. For HC and later, we want to (and can) let the state be saved as the</span>
<span class="token number">2915</span>                  <span class="token comment">// normal part of stopping the activity.</span>
<span class="token number">2916</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPreHoneycomb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2917</span>                      r<span class="token punctuation">.</span>state <span class="token operator">=</span> oldState<span class="token punctuation">;</span>
<span class="token number">2918</span>                  <span class="token punctuation">}</span>
<span class="token number">2919</span>              <span class="token punctuation">}</span>
<span class="token number">2920</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2921</span>              <span class="token comment">// If there was an error, for any reason, tell the activity manager to stop us.</span>
<span class="token number">2922</span>              <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2923</span>                  ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2924</span>                      <span class="token punctuation">.</span><span class="token function">finishActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span><span class="token constant">RESULT_CANCELED</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token number">2925</span>                              Activity<span class="token punctuation">.</span><span class="token constant">DONT_FINISH_TASK_WITH_ACTIVITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2926</span>              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>RemoteException ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2927</span>                  <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2928</span>              <span class="token punctuation">}</span>
<span class="token number">2929</span>          <span class="token punctuation">}</span>
<span class="token number">2930</span>      <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="performLaunchActivity_625"></a>performLaunchActivity</h5> 
<pre><code class="prism language-javascript"><span class="token number">2683</span>      <span class="token keyword">private</span> Activity <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span><span class="token parameter">ActivityClientRecord r<span class="token punctuation">,</span> Intent customIntent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2684</span>          <span class="token comment">// System.out.println("##### [" + System.currentTimeMillis() + "] ActivityThread.performLaunchActivity(" + r + ")");</span>
<span class="token number">2685</span>  
				<span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token number">2703</span>  
<span class="token number">2704</span>          ContextImpl appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2705</span>          Activity activity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">2706</span>          <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">//通过Instrumentation反射获取Activity实例</span>
<span class="token number">2707</span>              java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2708</span>              activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>
<span class="token number">2709</span>                      cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2710</span>              StrictMode<span class="token punctuation">.</span><span class="token function">incrementExpectedActivityCount</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2711</span>              r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2712</span>              r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2713</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2714</span>                  r<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2715</span>              <span class="token punctuation">}</span>
<span class="token number">2716</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2717</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2718</span>                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
<span class="token number">2719</span>                      <span class="token string">"Unable to instantiate activity "</span> <span class="token operator">+</span> component
<span class="token number">2720</span>                      <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2721</span>              <span class="token punctuation">}</span>
<span class="token number">2722</span>          <span class="token punctuation">}</span>
<span class="token number">2723</span>  
<span class="token number">2724</span>          <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">//如果是多进程就创建，不是多进程就不创建</span>
<span class="token number">2725</span>              Application app <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2726</span>  
				<span class="token operator">...</span><span class="token punctuation">.</span>
				
					<span class="token comment">//回调activity的attach方法</span>
<span class="token number">2749</span>                  appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2750</span>                  activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
<span class="token number">2751</span>                          r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
<span class="token number">2752</span>                          r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
<span class="token number">2753</span>                          r<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span> r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> window<span class="token punctuation">,</span> r<span class="token punctuation">.</span>configCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2754</span>  
<span class="token number">2755</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>customIntent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2756</span>                      activity<span class="token punctuation">.</span>mIntent <span class="token operator">=</span> customIntent<span class="token punctuation">;</span>
<span class="token number">2757</span>                  <span class="token punctuation">}</span>

						<span class="token operator">...</span><span class="token punctuation">.</span>
						
						<span class="token comment">//设置主题</span>
<span class="token number">2761</span>                  int theme <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span><span class="token function">getThemeResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2762</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>theme <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2763</span>                      activity<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2764</span>                  <span class="token punctuation">}</span>
<span class="token number">2765</span>  
						<span class="token comment">//通过Instrumentation来回调activity的onCreate()方法</span>
<span class="token number">2766</span>                  activity<span class="token punctuation">.</span>mCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">2767</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2768</span>                      mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">,</span> r<span class="token punctuation">.</span>persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2769</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2770</span>                      mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2771</span>                  <span class="token punctuation">}</span>
<span class="token number">2772</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activity<span class="token punctuation">.</span>mCalled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2773</span>                      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SuperNotCalledException</span><span class="token punctuation">(</span>
<span class="token number">2774</span>                          <span class="token string">"Activity "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
<span class="token number">2775</span>                          <span class="token string">" did not call through to super.onCreate()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2776</span>                  <span class="token punctuation">}</span>
<span class="token number">2777</span>                  r<span class="token punctuation">.</span>activity <span class="token operator">=</span> activity<span class="token punctuation">;</span>
<span class="token number">2778</span>                  r<span class="token punctuation">.</span>stopped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

						<span class="token comment">//start</span>
<span class="token number">2779</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2780</span>                      activity<span class="token punctuation">.</span><span class="token function">performStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2781</span>                      r<span class="token punctuation">.</span>stopped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">2782</span>                  <span class="token punctuation">}</span>

						<span class="token comment">//RestoreInstanceState</span>
<span class="token number">2783</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2784</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2785</span>                          <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> r<span class="token punctuation">.</span>persistentState <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2786</span>                              mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnRestoreInstanceState</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
<span class="token number">2787</span>                                      r<span class="token punctuation">.</span>persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2788</span>                          <span class="token punctuation">}</span>
<span class="token number">2789</span>                      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2790</span>                          mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnRestoreInstanceState</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2791</span>                      <span class="token punctuation">}</span>
<span class="token number">2792</span>                  <span class="token punctuation">}</span>

						<span class="token comment">//OnPostCreate</span>
<span class="token number">2793</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2794</span>                      activity<span class="token punctuation">.</span>mCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">2795</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2796</span>                          mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnPostCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
<span class="token number">2797</span>                                  r<span class="token punctuation">.</span>persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2798</span>                      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2799</span>                          mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnPostCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2800</span>                      <span class="token punctuation">}</span>
<span class="token number">2801</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activity<span class="token punctuation">.</span>mCalled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2802</span>                          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SuperNotCalledException</span><span class="token punctuation">(</span>
<span class="token number">2803</span>                              <span class="token string">"Activity "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
<span class="token number">2804</span>                              <span class="token string">" did not call through to super.onPostCreate()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2805</span>                      <span class="token punctuation">}</span>
<span class="token number">2806</span>                  <span class="token punctuation">}</span>
<span class="token number">2807</span>              <span class="token punctuation">}</span>
<span class="token number">2808</span>              r<span class="token punctuation">.</span>paused <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">2809</span>  				<span class="token comment">//加入mActivities Map统一管理</span>
<span class="token number">2810</span>              mActivities<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2811</span>  
<span class="token number">2812</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>SuperNotCalledException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2813</span>              <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token number">2814</span>  
<span class="token number">2815</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2816</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2817</span>                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
<span class="token number">2818</span>                      <span class="token string">"Unable to start activity "</span> <span class="token operator">+</span> component
<span class="token number">2819</span>                      <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2820</span>              <span class="token punctuation">}</span>
<span class="token number">2821</span>          <span class="token punctuation">}</span>
<span class="token number">2822</span>  
<span class="token number">2823</span>          <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
<span class="token number">2824</span>      <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="API_754"></a>叁、API</h2> 
<h4><a id="31ActivityThread_756"></a>3.1、ActivityThread</h4> 
<p><a href="http://aospxref.com/android-14.0.0_r2/xref/frameworks/base/core/java/android/app/ActivityThread.java" rel="nofollow">http://aospxref.com/android-14.0.0_r2/xref/frameworks/base/core/java/android/app/ActivityThread.java</a></p> 
<p>以下是 Android 8 版本中的 <code>ActivityThread</code> 类的一些方法：</p> 
<ol><li> <p><strong>main()</strong>：应用进程的主入口点，用于初始化应用的全局状态，包括创建 <code>Application</code> 实例，启动应用的主 Activity，处理消息队列等。</p> </li><li> <p><strong>attach()</strong>：将 <code>ActivityThread</code> 附加到应用的进程，以进行应用的初始化和生命周期管理。</p> </li><li> <p><strong>bindApplication()</strong>：绑定应用到应用进程，包括创建 <code>Application</code> 实例和调用其 <code>onCreate</code> 方法，启动应用的主 Activity。</p> </li><li> <p><strong>schedulePauseActivity()</strong>：请求暂停指定 Activity 的生命周期。</p> </li><li> <p><strong>scheduleStopActivity()</strong>：请求停止指定 Activity 的生命周期。</p> </li><li> <p><strong>scheduleWindowVisibility()</strong>：处理窗口可见性的变化。</p> </li><li> <p><strong>scheduleLaunchActivity()</strong>：请求启动一个新的 Activity。</p> </li><li> <p><strong>scheduleReceiver()</strong>：处理广播接收器的注册和调度。</p> </li><li> <p><strong>scheduleCreateService()</strong>：请求创建服务。</p> </li><li> <p><strong>scheduleBindService()</strong>：请求绑定服务。</p> </li><li> <p><strong>scheduleUnbindService()</strong>：请求解绑服务。</p> </li><li> <p><strong>scheduleServiceArgs()</strong>：传递参数给服务。</p> </li><li> <p><strong>scheduleStopService()</strong>：请求停止服务。</p> </li><li> <p><strong>scheduleRegisteredReceiver()</strong>：处理已注册的广播接收器。</p> </li><li> <p><strong>scheduleLowMemory()</strong>：处理系统内存不足的情况。</p> </li><li> <p><strong>dispatchPackageBroadcast()</strong>：分发应用程序包的广播。</p> </li><li> <p><strong>dumpService()</strong>：输出服务信息。</p> </li><li> <p><strong>scheduleCrash()</strong>：请求应用进程崩溃。</p> </li><li> <p><strong>dumpHeap()</strong>：输出堆转储信息。</p> </li><li> <p><strong>attachAgent()</strong>：附加代理。</p> </li><li> <p><strong>setSchedulingGroup()</strong>：设置调度组。</p> </li><li> <p><strong>requestAssistContextExtras()</strong>：请求辅助上下文信息。</p> </li><li> <p><strong>updatePackageCompatibilityInfo()</strong>：更新应用包的兼容性信息。</p> </li><li> <p><strong>scheduleTrimMemory()</strong>：请求内存修剪。</p> </li><li> <p><strong>scheduleOnNewActivityOptions()</strong>：通知新的 Activity 选项。</p> </li></ol> 
<p>这些方法用于管理应用的生命周期、处理消息和事件，以确保应用能够正常启动、运行和响应用户操作。请注意，这些方法可能会在不同的 Android 版本中有所变化，而且可能还有其他私有方法用于实现不同版本中的新功能。如果需要了解特定 Android 版本的 <code>ActivityThread</code> 方法，请查阅相应版本的 Android 源代码或官方文档。</p> 
<h4><a id="32ApplicationThread_821"></a>3.2、ApplicationThread</h4> 
<p>以下是 Android 8 版本中的 <code>ApplicationThread</code> 类的一些方法：</p> 
<ol><li> <p><strong>bindApplication()</strong>：用于绑定应用程序到应用程序进程。这个方法负责创建应用程序的 <code>Application</code> 实例并调用其 <code>onCreate()</code> 方法，同时启动应用程序的主 Activity。</p> </li><li> <p><strong>schedulePauseActivity()</strong>：请求暂停指定 Activity 的生命周期。</p> </li><li> <p><strong>scheduleStopActivity()</strong>：请求停止指定 Activity 的生命周期。</p> </li><li> <p><strong>scheduleWindowVisibility()</strong>：处理窗口可见性的变化。</p> </li><li> <p><strong>scheduleResumeActivity()</strong>：请求恢复指定 Activity 的生命周期。</p> </li><li> <p><strong>scheduleSendResult()</strong>：用于发送 Activity 的结果。</p> </li><li> <p><strong>scheduleLaunchActivity()</strong>：请求启动新的 Activity。</p> </li><li> <p><strong>scheduleCreateService()</strong>：请求创建服务。</p> </li><li> <p><strong>scheduleBindService()</strong>：请求绑定服务。</p> </li><li> <p><strong>scheduleUnbindService()</strong>：请求解绑服务。</p> </li><li> <p><strong>scheduleServiceArgs()</strong>：传递参数给服务。</p> </li><li> <p><strong>scheduleStopService()</strong>：请求停止服务。</p> </li><li> <p><strong>scheduleLowMemory()</strong>：处理系统内存不足的情况。</p> </li><li> <p><strong>scheduleCrash()</strong>：请求应用进程崩溃。</p> </li><li> <p><strong>dumpHeap()</strong>：用于输出堆转储信息。</p> </li><li> <p><strong>dumpActivity()</strong>：用于输出 Activity 信息。</p> </li><li> <p><strong>scheduleRegisteredReceiver()</strong>：处理已注册的广播接收器。</p> </li><li> <p><strong>scheduleCreateBackupAgent()</strong>：用于请求创建备份代理，通常在应用需要进行数据备份和还原时调用。</p> </li><li> <p><strong>scheduleDestroyBackupAgent()</strong>：用于请求销毁备份代理，通常在备份操作完成后调用。</p> </li><li> <p><strong>scheduleSuicide()</strong>：请求应用进程自杀。</p> </li><li> <p><strong>scheduleConfigurationChanged()</strong>：用于处理配置更改。</p> </li><li> <p><strong>scheduleSleeping()</strong>：用于处理应用进程的休眠状态。</p> </li><li> <p><strong>dispatchPackageBroadcast()</strong>：分发应用程序包的广播。</p> </li><li> <p><strong>requestThumbnail()</strong>：请求获取 Activity 的缩略图。</p> </li><li> <p><strong>profilerControl()</strong>：用于性能分析控制。</p> </li></ol> 
<p>这些方法用于管理应用的生命周期、处理消息和事件，以确保应用能够正常启动、运行和响应用户操作。请注意，这些方法在不同的 Android 版本中可能会有所变化，而且可能还有其他私有方法用于实现不同版本中的新功能。如果需要了解特定 Android 版本的 <code>ApplicationThread</code> 方法，请查阅相应版本的 Android 源代码或官方文档。</p> 
<h4><a id="33ActivityManagerService_883"></a>3.3、ActivityManagerService</h4> 
<p>ActivityManagerService：<br> <a href="http://aospxref.com/android-8.0.0_r36/xref/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java#attachApplicationLocked" rel="nofollow">http://aospxref.com/android-8.0.0_r36/xref/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java#attachApplicationLocked</a></p> 
<h4><a id="34ActivityStackSupervisor_888"></a>3.4、ActivityStackSupervisor</h4> 
<p>ActivityStackSupervisor：<br> <a href="http://aospxref.com/android-8.0.0_r36/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java" rel="nofollow">http://aospxref.com/android-8.0.0_r36/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</a></p> 
<h2><a id="_891"></a>参考地址</h2> 
<p>文章大部分内容转自：<br> <a href="https://www.jianshu.com/p/643aa7c8e3dd" rel="nofollow">https://www.jianshu.com/p/643aa7c8e3dd</a></p> 
<p><a href="https://blog.csdn.net/sinat_31057219/article/details/132452043">https://blog.csdn.net/sinat_31057219/article/details/132452043</a></p> 
<p><a href="https://blog.51cto.com/u_16213631/7298774" rel="nofollow">https://blog.51cto.com/u_16213631/7298774</a></p> 
<p>启动流程详细解析!!<br> <a href="https://blog.csdn.net/weixin_43093006/article/details/128699383">https://blog.csdn.net/weixin_43093006/article/details/128699383</a></p> 
<p><a href="https://www.jianshu.com/p/538dcfac774d" rel="nofollow">https://www.jianshu.com/p/538dcfac774d</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e98f8d935b877945c93906b2b692e44c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C/C&#43;&#43;条件编译：#ifdef、#else、#endif等</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/96a765eeb50c129d00765c4654a35b1b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mysql的2059问题及解决方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>