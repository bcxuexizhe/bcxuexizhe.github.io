<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>第13章 Python建模库介绍 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/f51d1a797895e1921fbf0936bbbf2e8d/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="第13章 Python建模库介绍">
  <meta property="og:description" content="以下内容参考自https://github.com/iamseancheney/python_for_data_analysis_2nd_chinese_version/blob/master/%E7%AC%AC05%E7%AB%A0%20pandas%E5%85%A5%E9%97%A8.md
《利用Python进行数据分析·第2版》
用以学习和记录。
本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。
开发模型选用什么库取决于应用本身。许多统计问题可以用简单方法解决，比如普通的最小二乘回归，其它问题可能需要复杂的机器学习方法。幸运的是，Python已经成为了运用这些分析方法的语言之一，因此读完此书，你可以探索许多工具。
本章中，我会回顾一些pandas的特点，在你胶着于pandas数据规整和模型拟合和评分时，它们可能派上用场。然后我会简短介绍两个流行的建模工具，statsmodels和scikit-learn。这二者每个都值得再写一本书，我就不做全面的介绍，而是建议你学习两个项目的线上文档和其它基于Python的数据科学、统计和机器学习的书籍。
pandas与模型代码的接口 模型开发的通常工作流是使用pandas进行数据加载和清洗，然后切换到建模库进行建模。开发模型的重要一环是机器学习中的“特征工程”。它可以描述从原始数据集中提取信息的任何数据转换或分析，这些数据集可能在建模中有用。本书中学习的数据聚合和GroupBy工具常用于特征工程中。
优秀的特征工程超出了本书的范围，我会尽量直白地介绍一些用于数据操作和建模切换的方法。
pandas与其它分析库通常是靠NumPy的数组联系起来的。将DataFrame转换为NumPy数组，可以使用.values属性：
In [10]: import pandas as pd In [11]: import numpy as np In [12]: data = pd.DataFrame({ ....: &#39;x0&#39;: [1, 2, 3, 4, 5], ....: &#39;x1&#39;: [0.01, -0.01, 0.25, -4.1, 0.], ....: &#39;y&#39;: [-1.5, 0., 3.6, 1.3, -2.]}) In [13]: data Out[13]: x0 x1 y 0 1 0.01 -1.5 1 2 -0.01 0.0 2 3 0.25 3.6 3 4 -4.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-21T15:51:28+08:00">
    <meta property="article:modified_time" content="2024-05-21T15:51:28+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">第13章 Python建模库介绍</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>以下内容参考自https://github.com/iamseancheney/python_for_data_analysis_2nd_chinese_version/blob/master/%E7%AC%AC05%E7%AB%A0%20pandas%E5%85%A5%E9%97%A8.md<br> 《利用Python进行数据分析·第2版》<br> 用以学习和记录。</p> 
<p>本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。</p> 
<p>开发模型选用什么库取决于应用本身。许多统计问题可以用简单方法解决，比如普通的最小二乘回归，其它问题可能需要复杂的机器学习方法。幸运的是，Python已经成为了运用这些分析方法的语言之一，因此读完此书，你可以探索许多工具。</p> 
<p>本章中，我会回顾一些<code>pandas</code>的特点，在你胶着于pandas数据规整和模型拟合和评分时，它们可能派上用场。然后我会简短介绍两个流行的建模工具，<code>statsmodels</code>和<code>scikit-learn</code>。这二者每个都值得再写一本书，我就不做全面的介绍，而是建议你学习两个项目的线上文档和其它基于Python的数据科学、统计和机器学习的书籍。</p> 
<h2><a id="pandas_10"></a>pandas与模型代码的接口</h2> 
<p>模型开发的通常工作流是使用pandas进行数据加载和清洗，然后切换到建模库进行建模。开发模型的重要一环是机器学习中的“特征工程”。它可以描述从原始数据集中提取信息的任何数据转换或分析，这些数据集可能在建模中有用。本书中学习的数据聚合和GroupBy工具常用于特征工程中。</p> 
<p>优秀的特征工程超出了本书的范围，我会尽量直白地介绍一些用于数据操作和建模切换的方法。</p> 
<p><code>pandas</code>与其它分析库通常是靠<code>NumPy</code>的数组联系起来的。将<code>DataFrame</code>转换为<code>NumPy</code>数组，可以使用<code>.values</code>属性：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd

In <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

In <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'x0'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'x1'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.1</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'y'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">3.6</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data
Out<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
   x0    x1    y
<span class="token number">0</span>   <span class="token number">1</span>  <span class="token number">0.01</span> <span class="token operator">-</span><span class="token number">1.5</span>
<span class="token number">1</span>   <span class="token number">2</span> <span class="token operator">-</span><span class="token number">0.01</span>  <span class="token number">0.0</span>
<span class="token number">2</span>   <span class="token number">3</span>  <span class="token number">0.25</span>  <span class="token number">3.6</span>
<span class="token number">3</span>   <span class="token number">4</span> <span class="token operator">-</span><span class="token number">4.10</span>  <span class="token number">1.3</span>
<span class="token number">4</span>   <span class="token number">5</span>  <span class="token number">0.00</span> <span class="token operator">-</span><span class="token number">2.0</span>

In <span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data<span class="token punctuation">.</span>columns
Out<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Index<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'x0'</span><span class="token punctuation">,</span> <span class="token string">'x1'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'object'</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data<span class="token punctuation">.</span>values
Out<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1.</span>  <span class="token punctuation">,</span>  <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">2.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.01</span><span class="token punctuation">,</span>  <span class="token number">0.</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">3.</span>  <span class="token punctuation">,</span>  <span class="token number">0.25</span><span class="token punctuation">,</span>  <span class="token number">3.6</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">4.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.1</span> <span class="token punctuation">,</span>  <span class="token number">1.3</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">5.</span>  <span class="token punctuation">,</span>  <span class="token number">0.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>要转换回<code>DataFrame</code>，可以传递一个二维<code>ndarray</code>，可带有列名：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">:</span> df2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token punctuation">.</span>values<span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'one'</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">:</span> df2
Out<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
   one   two  three
<span class="token number">0</span>  <span class="token number">1.0</span>  <span class="token number">0.01</span>   <span class="token operator">-</span><span class="token number">1.5</span>
<span class="token number">1</span>  <span class="token number">2.0</span> <span class="token operator">-</span><span class="token number">0.01</span>    <span class="token number">0.0</span>
<span class="token number">2</span>  <span class="token number">3.0</span>  <span class="token number">0.25</span>    <span class="token number">3.6</span>
<span class="token number">3</span>  <span class="token number">4.0</span> <span class="token operator">-</span><span class="token number">4.10</span>    <span class="token number">1.3</span>
<span class="token number">4</span>  <span class="token number">5.0</span>  <span class="token number">0.00</span>   <span class="token operator">-</span><span class="token number">2.0</span>
</code></pre> 
<p><strong>笔记：最好当数据是均匀的时候使用<code>.values</code>属性。例如，全是数值类型。如果数据是不均匀的，结果会是Python对象的<code>ndarray</code>：</strong></p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">:</span> df3 <span class="token operator">=</span> data<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">:</span> df3<span class="token punctuation">[</span><span class="token string">'strings'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">]</span>

In <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">:</span> df3
Out<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
  x0    x1    y strings
<span class="token number">0</span>   <span class="token number">1</span>  <span class="token number">0.01</span> <span class="token operator">-</span><span class="token number">1.5</span>       a
<span class="token number">1</span>   <span class="token number">2</span> <span class="token operator">-</span><span class="token number">0.01</span>  <span class="token number">0.0</span>       b
<span class="token number">2</span>   <span class="token number">3</span>  <span class="token number">0.25</span>  <span class="token number">3.6</span>       c
<span class="token number">3</span>   <span class="token number">4</span> <span class="token operator">-</span><span class="token number">4.10</span>  <span class="token number">1.3</span>       d
<span class="token number">4</span>   <span class="token number">5</span>  <span class="token number">0.00</span> <span class="token operator">-</span><span class="token number">2.0</span>       e

In <span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">:</span> df3<span class="token punctuation">.</span>values
Out<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">3.6</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.1</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">object</span><span class="token punctuation">)</span>
</code></pre> 
<p>对于一些模型，你可能只想使用列的子集。我建议你使用<code>loc</code>，用<code>values</code>作索引：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">:</span> model_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'x0'</span><span class="token punctuation">,</span> <span class="token string">'x1'</span><span class="token punctuation">]</span>

In <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data<span class="token punctuation">.</span>loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> model_cols<span class="token punctuation">]</span><span class="token punctuation">.</span>values
Out<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1.</span>  <span class="token punctuation">,</span>  <span class="token number">0.01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">2.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">3.</span>  <span class="token punctuation">,</span>  <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">4.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">5.</span>  <span class="token punctuation">,</span>  <span class="token number">0.</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>一些库原生支持<code>pandas</code>，会自动完成工作：从<code>DataFrame</code>转换到<code>NumPy</code>，将模型的参数名添加到输出表的列或<code>Series</code>。其它情况，你可以手工进行“元数据管理”。</p> 
<p>在第12章，我们学习了<code>pandas</code>的<code>Categorical</code>类型和<code>pandas.get_dummies</code>函数。假设数据集中有一个非数值列：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>Categorical<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>                                   categories<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data
Out<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
   x0    x1    y category
<span class="token number">0</span>   <span class="token number">1</span>  <span class="token number">0.01</span> <span class="token operator">-</span><span class="token number">1.5</span>        a
<span class="token number">1</span>   <span class="token number">2</span> <span class="token operator">-</span><span class="token number">0.01</span>  <span class="token number">0.0</span>        b
<span class="token number">2</span>   <span class="token number">3</span>  <span class="token number">0.25</span>  <span class="token number">3.6</span>        a
<span class="token number">3</span>   <span class="token number">4</span> <span class="token operator">-</span><span class="token number">4.10</span>  <span class="token number">1.3</span>        a
<span class="token number">4</span>   <span class="token number">5</span>  <span class="token number">0.00</span> <span class="token operator">-</span><span class="token number">2.0</span>        b
</code></pre> 
<p>如果我们想替换<code>category</code>列为虚变量，我们可以创建虚变量，删除<code>category</code>列，然后添加到结果：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">:</span> dummies <span class="token operator">=</span> pd<span class="token punctuation">.</span>get_dummies<span class="token punctuation">(</span>data<span class="token punctuation">.</span>category<span class="token punctuation">,</span> prefix<span class="token operator">=</span><span class="token string">'category'</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data_with_dummies <span class="token operator">=</span> data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token string">'category'</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>dummies<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data_with_dummies
Out<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
   x0    x1    y  category_a  category_b
<span class="token number">0</span>   <span class="token number">1</span>  <span class="token number">0.01</span> <span class="token operator">-</span><span class="token number">1.5</span>           <span class="token number">1</span>           <span class="token number">0</span>
<span class="token number">1</span>   <span class="token number">2</span> <span class="token operator">-</span><span class="token number">0.01</span>  <span class="token number">0.0</span>           <span class="token number">0</span>           <span class="token number">1</span>
<span class="token number">2</span>   <span class="token number">3</span>  <span class="token number">0.25</span>  <span class="token number">3.6</span>           <span class="token number">1</span>           <span class="token number">0</span>
<span class="token number">3</span>   <span class="token number">4</span> <span class="token operator">-</span><span class="token number">4.10</span>  <span class="token number">1.3</span>           <span class="token number">1</span>           <span class="token number">0</span>
<span class="token number">4</span>   <span class="token number">5</span>  <span class="token number">0.00</span> <span class="token operator">-</span><span class="token number">2.0</span>           <span class="token number">0</span>           <span class="token number">1</span>
</code></pre> 
<p>用虚变量拟合某些统计模型会有一些细微差别。当你不只有数字列时，使用<code>Patsy</code>（下一节的主题）可能更简单，更不容易出错。</p> 
<h2><a id="Patsy_133"></a>用Patsy创建模型描述</h2> 
<p><code>Patsy</code>是<code>Python</code>的一个库，使用简短的字符串“公式语法”描述统计模型（尤其是线性模型），可能是受到了R和S统计编程语言的公式语法的启发。</p> 
<p><code>Patsy</code>适合描述<code>statsmodels</code>的线性模型，因此我会关注于它的主要特点，让你尽快掌握。Patsy的公式是一个特殊的字符串语法，如下所示：</p> 
<pre><code class="prism language-python">y <span class="token operator">~</span> x0 <span class="token operator">+</span> x1
</code></pre> 
<p><code>a+b</code>不是将<code>a</code>与<code>b</code>相加的意思，而是为模型创建的设计矩阵。<code>patsy.dmatrices</code>函数接收一个公式字符串和一个数据集（可以是<code>DataFrame</code>或数组的字典），为线性模型创建设计矩阵：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'x0'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'x1'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.1</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'y'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">3.6</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data
Out<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
   x0    x1    y
<span class="token number">0</span>   <span class="token number">1</span>  <span class="token number">0.01</span> <span class="token operator">-</span><span class="token number">1.5</span>
<span class="token number">1</span>   <span class="token number">2</span> <span class="token operator">-</span><span class="token number">0.01</span>  <span class="token number">0.0</span>
<span class="token number">2</span>   <span class="token number">3</span>  <span class="token number">0.25</span>  <span class="token number">3.6</span>
<span class="token number">3</span>   <span class="token number">4</span> <span class="token operator">-</span><span class="token number">4.10</span>  <span class="token number">1.3</span>
<span class="token number">4</span>   <span class="token number">5</span>  <span class="token number">0.00</span> <span class="token operator">-</span><span class="token number">2.0</span>

In <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">import</span> patsy

In <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">,</span> X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'y ~ x0 + x1'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
</code></pre> 
<p>现在有：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y
Out<span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
     y
  <span class="token operator">-</span><span class="token number">1.5</span>
   <span class="token number">0.0</span>
   <span class="token number">3.6</span>
   <span class="token number">1.3</span>
  <span class="token operator">-</span><span class="token number">2.0</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'y'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">34</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X
Out<span class="token punctuation">[</span><span class="token number">34</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
  Intercept  x0     x1
          <span class="token number">1</span>   <span class="token number">1</span>   <span class="token number">0.01</span>
          <span class="token number">1</span>   <span class="token number">2</span>  <span class="token operator">-</span><span class="token number">0.01</span>
          <span class="token number">1</span>   <span class="token number">3</span>   <span class="token number">0.25</span>
          <span class="token number">1</span>   <span class="token number">4</span>  <span class="token operator">-</span><span class="token number">4.10</span>
          <span class="token number">1</span>   <span class="token number">5</span>   <span class="token number">0.00</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'Intercept'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">'x0'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token string">'x1'</span> <span class="token punctuation">(</span>column <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>这些<code>Patsy</code>的<code>DesignMatrix</code>实例是<code>NumPy</code>的<code>ndarray</code>，带有附加元数据：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">35</span><span class="token punctuation">]</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">35</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">0.</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">3.6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2.</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1.</span>  <span class="token punctuation">,</span>  <span class="token number">1.</span>  <span class="token punctuation">,</span>  <span class="token number">0.01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.</span>  <span class="token punctuation">,</span>  <span class="token number">2.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.</span>  <span class="token punctuation">,</span>  <span class="token number">3.</span>  <span class="token punctuation">,</span>  <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.</span>  <span class="token punctuation">,</span>  <span class="token number">4.</span>  <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.</span>  <span class="token punctuation">,</span>  <span class="token number">5.</span>  <span class="token punctuation">,</span>  <span class="token number">0.</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>你可能想<code>Intercept</code>是哪里来的。这是线性模型（比如普通最小二乘回归）的惯例用法。添加<code>+0</code>到模型可以不显示<code>intercept</code>：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">37</span><span class="token punctuation">]</span><span class="token punctuation">:</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'y ~ x0 + x1 + 0'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
Out<span class="token punctuation">[</span><span class="token number">37</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  x0     x1
   <span class="token number">1</span>   <span class="token number">0.01</span>
   <span class="token number">2</span>  <span class="token operator">-</span><span class="token number">0.01</span>
   <span class="token number">3</span>   <span class="token number">0.25</span>
   <span class="token number">4</span>  <span class="token operator">-</span><span class="token number">4.10</span>
   <span class="token number">5</span>   <span class="token number">0.00</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'x0'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">'x1'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>Patsy</code>对象可以直接传递到算法（比如<code>numpy.linalg.lstsq</code>）中，它执行普通最小二乘回归：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">38</span><span class="token punctuation">]</span><span class="token punctuation">:</span> coef<span class="token punctuation">,</span> resid<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>lstsq<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
</code></pre> 
<p>模型的元数据保留在<code>design_info</code>属性中，因此你可以重新附加列名到拟合系数，以获得一个<code>Series</code>，例如：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">39</span><span class="token punctuation">]</span><span class="token punctuation">:</span> coef
Out<span class="token punctuation">[</span><span class="token number">39</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0.3129</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.0791</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.2655</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">:</span> coef <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>coef<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span>X<span class="token punctuation">.</span>design_info<span class="token punctuation">.</span>column_names<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">41</span><span class="token punctuation">]</span><span class="token punctuation">:</span> coef
Out<span class="token punctuation">[</span><span class="token number">41</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
Intercept    <span class="token number">0.312910</span>
x0          <span class="token operator">-</span><span class="token number">0.079106</span>
x1          <span class="token operator">-</span><span class="token number">0.265464</span>
dtype<span class="token punctuation">:</span> float64
</code></pre> 
<h3><a id="Patsy_249"></a>用Patsy公式进行数据转换</h3> 
<p>你可以将<code>Python</code>代码与<code>patsy</code>公式结合。在评估公式时，库将尝试查找在封闭作用域内使用的函数：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">,</span> X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'y ~ x0 + np.log(np.abs(x1) + 1)'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">43</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X
Out<span class="token punctuation">[</span><span class="token number">43</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
  Intercept  x0  np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>x1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token number">1</span>   <span class="token number">1</span>                 <span class="token number">0.00995</span>
          <span class="token number">1</span>   <span class="token number">2</span>                 <span class="token number">0.00995</span>
          <span class="token number">1</span>   <span class="token number">3</span>                 <span class="token number">0.22314</span>
          <span class="token number">1</span>   <span class="token number">4</span>                 <span class="token number">1.62924</span>
          <span class="token number">1</span>   <span class="token number">5</span>                 <span class="token number">0.00000</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'Intercept'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">'x0'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token string">'np.log(np.abs(x1) + 1)'</span> <span class="token punctuation">(</span>column <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>常见的变量转换包括标准化（平均值为0，方差为1）和中心化（减去平均值）。<code>Patsy</code>有内置的函数进行这样的工作：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">44</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">,</span> X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'y ~ standardize(x0) + center(x1)'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X
Out<span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
  Intercept  standardize<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>  center<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>
          <span class="token number">1</span>         <span class="token operator">-</span><span class="token number">1.41421</span>        <span class="token number">0.78</span>
          <span class="token number">1</span>         <span class="token operator">-</span><span class="token number">0.70711</span>        <span class="token number">0.76</span>
          <span class="token number">1</span>          <span class="token number">0.00000</span>        <span class="token number">1.02</span>
          <span class="token number">1</span>          <span class="token number">0.70711</span>       <span class="token operator">-</span><span class="token number">3.33</span>
          <span class="token number">1</span>          <span class="token number">1.41421</span>        <span class="token number">0.77</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'Intercept'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">'standardize(x0)'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token string">'center(x1)'</span> <span class="token punctuation">(</span>column <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>作为建模的一步，你可能拟合模型到一个数据集，然后用另一个数据集评估模型。另一个数据集可能是剩余的部分或是新数据。当执行中心化和标准化转变，用新数据进行预测要格外小心。因为你必须使用平均值或标准差转换新数据集，这也称作状态转换。</p> 
<p><code>patsy.build_design_matrices</code>函数可以使用原始样本数据集的保存信息，来转换新数据：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">46</span><span class="token punctuation">]</span><span class="token punctuation">:</span> new_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'x0'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'x1'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2.3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'y'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">47</span><span class="token punctuation">]</span><span class="token punctuation">:</span> new_X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>build_design_matrices<span class="token punctuation">(</span><span class="token punctuation">[</span>X<span class="token punctuation">.</span>design_info<span class="token punctuation">]</span><span class="token punctuation">,</span> new_data<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">:</span> new_X
Out<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
<span class="token punctuation">[</span>DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
   Intercept  standardize<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>  center<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>
           <span class="token number">1</span>          <span class="token number">2.12132</span>        <span class="token number">3.87</span>
           <span class="token number">1</span>          <span class="token number">2.82843</span>        <span class="token number">0.27</span>
           <span class="token number">1</span>          <span class="token number">3.53553</span>        <span class="token number">0.77</span>
           <span class="token number">1</span>          <span class="token number">4.24264</span>        <span class="token number">3.07</span>
   Terms<span class="token punctuation">:</span>
     <span class="token string">'Intercept'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token string">'standardize(x0)'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
     <span class="token string">'center(x1)'</span> <span class="token punctuation">(</span>column <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<p>因为<code>Patsy</code>中的加号不是加法的意义，当你按照名称将数据集的列相加时，你必须用特殊<code>I</code>函数将它们封装起来：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">49</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">,</span> X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'y ~ I(x0 + x1)'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X
Out<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  Intercept  I<span class="token punctuation">(</span>x0 <span class="token operator">+</span> x1<span class="token punctuation">)</span>
          <span class="token number">1</span>        <span class="token number">1.01</span>
          <span class="token number">1</span>        <span class="token number">1.99</span>
          <span class="token number">1</span>        <span class="token number">3.25</span>
          <span class="token number">1</span>       <span class="token operator">-</span><span class="token number">0.10</span>
          <span class="token number">1</span>        <span class="token number">5.00</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'Intercept'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">'I(x0 + x1)'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>Patsy</code>的<code>patsy.builtins</code>模块还有一些其它的内置转换。请查看线上文档。</p> 
<p>分类数据有一个特殊的转换类，下面进行讲解。</p> 
<h3><a id="Patsy_335"></a>分类数据和Patsy</h3> 
<p>非数值数据可以用多种方式转换为模型设计矩阵。完整的讲解超出了本书范围，最好和统计课一起学习。</p> 
<p>当你在<code>Patsy</code>公式中使用非数值数据，它们会默认转换为虚变量。如果有截距，会去掉一个，避免共线性：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'key1'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'key2'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'v1'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token string">'v2'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.7</span><span class="token punctuation">]</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">,</span> X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'v2 ~ key1'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">53</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X
Out<span class="token punctuation">[</span><span class="token number">53</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  Intercept  key1<span class="token punctuation">[</span>T<span class="token punctuation">.</span>b<span class="token punctuation">]</span>
          <span class="token number">1</span>          <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">1</span>
          <span class="token number">1</span>          <span class="token number">1</span>
          <span class="token number">1</span>          <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">1</span>
          <span class="token number">1</span>          <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">1</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'Intercept'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">'key1'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果你从模型中忽略截距，每个分类值的列都会包括在设计矩阵的模型中：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">54</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">,</span> X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'v2 ~ key1 + 0'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X
Out<span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  key1<span class="token punctuation">[</span>a<span class="token punctuation">]</span>  key1<span class="token punctuation">[</span>b<span class="token punctuation">]</span>
        <span class="token number">1</span>        <span class="token number">0</span>
        <span class="token number">1</span>        <span class="token number">0</span>
        <span class="token number">0</span>        <span class="token number">1</span>
        <span class="token number">0</span>        <span class="token number">1</span>
        <span class="token number">1</span>        <span class="token number">0</span>
        <span class="token number">0</span>        <span class="token number">1</span>
        <span class="token number">1</span>        <span class="token number">0</span>
        <span class="token number">0</span>        <span class="token number">1</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'key1'</span> <span class="token punctuation">(</span>columns <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>使用C函数，数值列可以截取为分类量：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">56</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">,</span> X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'v2 ~ C(key2)'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">57</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X
Out<span class="token punctuation">[</span><span class="token number">57</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  Intercept  C<span class="token punctuation">(</span>key2<span class="token punctuation">)</span><span class="token punctuation">[</span>T<span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">]</span>
          <span class="token number">1</span>             <span class="token number">0</span>
          <span class="token number">1</span>             <span class="token number">1</span>
          <span class="token number">1</span>             <span class="token number">0</span>
          <span class="token number">1</span>             <span class="token number">1</span>
          <span class="token number">1</span>             <span class="token number">0</span>
          <span class="token number">1</span>             <span class="token number">1</span>
          <span class="token number">1</span>             <span class="token number">0</span>
          <span class="token number">1</span>             <span class="token number">0</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'Intercept'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">'C(key2)'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>当你在模型中使用多个分类名，事情就会变复杂，因为会包括<code>key1:key2</code>形式的相交部分，它可以用在方差（<code>ANOVA</code>）模型分析中：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">58</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">'key2'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'key2'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'zero'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'one'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">59</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data
Out<span class="token punctuation">[</span><span class="token number">59</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
  key1  key2  v1   v2
<span class="token number">0</span>    a  zero   <span class="token number">1</span> <span class="token operator">-</span><span class="token number">1.0</span>
<span class="token number">1</span>    a   one   <span class="token number">2</span>  <span class="token number">0.0</span>
<span class="token number">2</span>    b  zero   <span class="token number">3</span>  <span class="token number">2.5</span>
<span class="token number">3</span>    b   one   <span class="token number">4</span> <span class="token operator">-</span><span class="token number">0.5</span>
<span class="token number">4</span>    a  zero   <span class="token number">5</span>  <span class="token number">4.0</span>
<span class="token number">5</span>    b   one   <span class="token number">6</span> <span class="token operator">-</span><span class="token number">1.2</span>
<span class="token number">6</span>    a  zero   <span class="token number">7</span>  <span class="token number">0.2</span>
<span class="token number">7</span>    b  zero   <span class="token number">8</span> <span class="token operator">-</span><span class="token number">1.7</span>

In <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">,</span> X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'v2 ~ key1 + key2'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">61</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X
Out<span class="token punctuation">[</span><span class="token number">61</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
  Intercept  key1<span class="token punctuation">[</span>T<span class="token punctuation">.</span>b<span class="token punctuation">]</span>  key2<span class="token punctuation">[</span>T<span class="token punctuation">.</span>zero<span class="token punctuation">]</span>
          <span class="token number">1</span>          <span class="token number">0</span>             <span class="token number">1</span>
          <span class="token number">1</span>          <span class="token number">0</span>             <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">1</span>             <span class="token number">1</span>
          <span class="token number">1</span>          <span class="token number">1</span>             <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">0</span>             <span class="token number">1</span>
          <span class="token number">1</span>          <span class="token number">1</span>             <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">0</span>             <span class="token number">1</span>
          <span class="token number">1</span>          <span class="token number">1</span>             <span class="token number">1</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'Intercept'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">'key1'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token string">'key2'</span> <span class="token punctuation">(</span>column <span class="token number">2</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">,</span> X <span class="token operator">=</span> patsy<span class="token punctuation">.</span>dmatrices<span class="token punctuation">(</span><span class="token string">'v2 ~ key1 + key2 + key1:key2'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X
Out<span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
DesignMatrix <span class="token keyword">with</span> shape <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
  Intercept  key1<span class="token punctuation">[</span>T<span class="token punctuation">.</span>b<span class="token punctuation">]</span>  key2<span class="token punctuation">[</span>T<span class="token punctuation">.</span>zero<span class="token punctuation">]</span>
key1<span class="token punctuation">[</span>T<span class="token punctuation">.</span>b<span class="token punctuation">]</span><span class="token punctuation">:</span>key2<span class="token punctuation">[</span>T<span class="token punctuation">.</span>zero<span class="token punctuation">]</span>
          <span class="token number">1</span>          <span class="token number">0</span>             <span class="token number">1</span>                       <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">0</span>             <span class="token number">0</span>                       <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">1</span>             <span class="token number">1</span>                       <span class="token number">1</span>
          <span class="token number">1</span>          <span class="token number">1</span>             <span class="token number">0</span>                       <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">0</span>             <span class="token number">1</span>                       <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">1</span>             <span class="token number">0</span>                       <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">0</span>             <span class="token number">1</span>                       <span class="token number">0</span>
          <span class="token number">1</span>          <span class="token number">1</span>             <span class="token number">1</span>                       <span class="token number">1</span>
  Terms<span class="token punctuation">:</span>
    <span class="token string">'Intercept'</span> <span class="token punctuation">(</span>column <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">'key1'</span> <span class="token punctuation">(</span>column <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token string">'key2'</span> <span class="token punctuation">(</span>column <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token string">'key1:key2'</span> <span class="token punctuation">(</span>column <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>Patsy</code>提供转换分类数据的其它方法，包括以特定顺序转换。请参阅线上文档。</p> 
<h2><a id="statsmodels_466"></a>statsmodels介绍</h2> 
<p><code>statsmodels</code>是<code>Python</code>进行拟合多种统计模型、进行统计试验和数据探索可视化的库。<code>Statsmodels</code>包含许多经典的统计方法，但没有贝叶斯方法和机器学习模型。</p> 
<p><code>statsmodels</code>包含的模型有：</p> 
<ul><li>线性模型，广义线性模型和健壮线性模型</li><li>线性混合效应模型</li><li>方差（<code>ANOVA</code>）方法分析</li><li>时间序列过程和状态空间模型</li><li>广义矩估计</li></ul> 
<p>下面，我会使用一些基本的<code>statsmodels</code>工具，探索<code>Patsy</code>公式和<code>pandasDataFrame</code>对象如何使用模型接口。</p> 
<h3><a id="_479"></a>估计线性模型</h3> 
<p><code>statsmodels</code>有多种线性回归模型，包括从基本（比如普通最小二乘）到复杂（比如迭代加权最小二乘法）的。</p> 
<p><code>statsmodels</code>的线性模型有两种不同的接口：基于数组和基于公式。它们可以通过API模块引入：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> statsmodels<span class="token punctuation">.</span>api <span class="token keyword">as</span> sm
<span class="token keyword">import</span> statsmodels<span class="token punctuation">.</span>formula<span class="token punctuation">.</span>api <span class="token keyword">as</span> smf
</code></pre> 
<p>为了展示它们的使用方法，我们从一些随机数据生成一个线性模型：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">dnorm</span><span class="token punctuation">(</span>mean<span class="token punctuation">,</span> variance<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        size <span class="token operator">=</span> size<span class="token punctuation">,</span>
    <span class="token keyword">return</span> mean <span class="token operator">+</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>variance<span class="token punctuation">)</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token operator">*</span>size<span class="token punctuation">)</span>

<span class="token comment"># For reproducibility</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">)</span>

N <span class="token operator">=</span> <span class="token number">100</span>
X <span class="token operator">=</span> np<span class="token punctuation">.</span>c_<span class="token punctuation">[</span>dnorm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> size<span class="token operator">=</span>N<span class="token punctuation">)</span><span class="token punctuation">,</span>
          dnorm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> size<span class="token operator">=</span>N<span class="token punctuation">)</span><span class="token punctuation">,</span>
          dnorm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> size<span class="token operator">=</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span>
eps <span class="token operator">=</span> dnorm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> size<span class="token operator">=</span>N<span class="token punctuation">)</span>
beta <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span>

y <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>X<span class="token punctuation">,</span> beta<span class="token punctuation">)</span> <span class="token operator">+</span> eps
</code></pre> 
<p><strong>这里<code>np.c_</code>用于沿着第二个轴（列方向）连接数组。在这里，它被用来将三个独立的正态分布随机数数组水平地连接起来，形成一个矩阵。如果直接<code>np</code>，那么生成的是一个一维数组，因为没有传入嵌套列表。</strong></p> 
<p>这里，我使用了“真实”模型和可知参数<code>beta</code>。此时，<code>dnorm</code>可用来生成正态分布数据，带有特定均值和方差。现在有：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">66</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
Out<span class="token punctuation">[</span><span class="token number">66</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.1295</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.2128</span><span class="token punctuation">,</span>  <span class="token number">0.5042</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">0.3029</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.4357</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2542</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.3285</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0253</span><span class="token punctuation">,</span>  <span class="token number">0.1384</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.3515</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.7196</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2582</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.2433</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3738</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5226</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">67</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
Out<span class="token punctuation">[</span><span class="token number">67</span><span class="token punctuation">]</span><span class="token punctuation">:</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">0.4279</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.6735</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0909</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.4895</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.1289</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre> 
<p>像之前<code>Patsy</code>看到的，线性模型通常要拟合一个截距。<code>sm.add_constant</code>函数可以添加一个截距的列到现存的矩阵：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X_model <span class="token operator">=</span> sm<span class="token punctuation">.</span>add_constant<span class="token punctuation">(</span>X<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">69</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X_model<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
Out<span class="token punctuation">[</span><span class="token number">69</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1.</span>    <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1295</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.2128</span><span class="token punctuation">,</span>  <span class="token number">0.5042</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.</span>    <span class="token punctuation">,</span>  <span class="token number">0.3029</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.4357</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2542</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.</span>    <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3285</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0253</span><span class="token punctuation">,</span>  <span class="token number">0.1384</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.</span>    <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3515</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.7196</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2582</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">1.</span>    <span class="token punctuation">,</span>  <span class="token number">1.2433</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3738</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5226</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>sm.OLS</code>类可以拟合一个普通最小二乘回归：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">70</span><span class="token punctuation">]</span><span class="token punctuation">:</span> model <span class="token operator">=</span> sm<span class="token punctuation">.</span>OLS<span class="token punctuation">(</span>y<span class="token punctuation">,</span> X<span class="token punctuation">)</span>
</code></pre> 
<p>这个模型的<code>fit</code>方法返回了一个回归结果对象，它包含估计的模型参数和其它内容：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">71</span><span class="token punctuation">]</span><span class="token punctuation">:</span> results <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span><span class="token punctuation">:</span> results<span class="token punctuation">.</span>params
Out<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span><span class="token punctuation">:</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">0.1783</span><span class="token punctuation">,</span>  <span class="token number">0.223</span> <span class="token punctuation">,</span>  <span class="token number">0.501</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>对结果使用<code>summary</code>方法可以打印模型的详细诊断结果：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">73</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
OLS Regression Results                            
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Dep<span class="token punctuation">.</span> Variable<span class="token punctuation">:</span>                      y   R<span class="token operator">-</span>squared<span class="token punctuation">:</span>                       <span class="token number">0.430</span>
Model<span class="token punctuation">:</span>                            OLS   Adj<span class="token punctuation">.</span> R<span class="token operator">-</span>squared<span class="token punctuation">:</span>                  <span class="token number">0.413</span>
Method<span class="token punctuation">:</span>                 Least Squares   F<span class="token operator">-</span>statistic<span class="token punctuation">:</span>                     <span class="token number">24.42</span>
Date<span class="token punctuation">:</span>                Mon<span class="token punctuation">,</span> <span class="token number">25</span> Sep <span class="token number">2017</span>   Prob <span class="token punctuation">(</span>F<span class="token operator">-</span>statistic<span class="token punctuation">)</span><span class="token punctuation">:</span>           <span class="token number">7.44e-12</span>
Time<span class="token punctuation">:</span>                        <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">06</span><span class="token punctuation">:</span><span class="token number">15</span>   Log<span class="token operator">-</span>Likelihood<span class="token punctuation">:</span>                <span class="token operator">-</span><span class="token number">34.305</span>
No<span class="token punctuation">.</span> Observations<span class="token punctuation">:</span>                 <span class="token number">100</span>   AIC<span class="token punctuation">:</span>                             <span class="token number">74.61</span>
Df Residuals<span class="token punctuation">:</span>                      <span class="token number">97</span>   BIC<span class="token punctuation">:</span>                             <span class="token number">82.42</span>
Df Model<span class="token punctuation">:</span>                           <span class="token number">3</span>                                         
Covariance Type<span class="token punctuation">:</span>            nonrobust                                         
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
                 coef    std err          t      P<span class="token operator">&gt;</span><span class="token operator">|</span>t<span class="token operator">|</span>      <span class="token punctuation">[</span><span class="token number">0.025</span>      <span class="token number">0.975</span><span class="token punctuation">]</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
x1             <span class="token number">0.1783</span>      <span class="token number">0.053</span>      <span class="token number">3.364</span>      <span class="token number">0.001</span>       <span class="token number">0.073</span>       <span class="token number">0.283</span>
x2             <span class="token number">0.2230</span>      <span class="token number">0.046</span>      <span class="token number">4.818</span>      <span class="token number">0.000</span>       <span class="token number">0.131</span>       <span class="token number">0.315</span>
x3             <span class="token number">0.5010</span>      <span class="token number">0.080</span>      <span class="token number">6.237</span>      <span class="token number">0.000</span>       <span class="token number">0.342</span>       <span class="token number">0.660</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Omnibus<span class="token punctuation">:</span>                        <span class="token number">4.662</span>   Durbin<span class="token operator">-</span>Watson<span class="token punctuation">:</span>                   <span class="token number">2.201</span>
Prob<span class="token punctuation">(</span>Omnibus<span class="token punctuation">)</span><span class="token punctuation">:</span>                  <span class="token number">0.097</span>   Jarque<span class="token operator">-</span>Bera <span class="token punctuation">(</span>JB<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token number">4.098</span>
Skew<span class="token punctuation">:</span>                           <span class="token number">0.481</span>   Prob<span class="token punctuation">(</span>JB<span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token number">0.129</span>
Kurtosis<span class="token punctuation">:</span>                       <span class="token number">3.243</span>   Cond<span class="token punctuation">.</span> No<span class="token punctuation">.</span>
<span class="token number">1.74</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Warnings<span class="token punctuation">:</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Standard Errors assume that the covariance matrix of the errors <span class="token keyword">is</span> correctly 
specified<span class="token punctuation">.</span>
</code></pre> 
<p>这里的参数名为通用名<code>x1, x2</code>等等。假设所有的模型参数都在一个<code>DataFrame</code>中：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">74</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>X<span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'col0'</span><span class="token punctuation">,</span> <span class="token string">'col1'</span><span class="token punctuation">,</span> <span class="token string">'col2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span> <span class="token operator">=</span> y

In <span class="token punctuation">[</span><span class="token number">76</span><span class="token punctuation">]</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
Out<span class="token punctuation">[</span><span class="token number">76</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
       col0      col1      col2         y
<span class="token number">0</span> <span class="token operator">-</span><span class="token number">0.129468</span> <span class="token operator">-</span><span class="token number">1.212753</span>  <span class="token number">0.504225</span>  <span class="token number">0.427863</span>
<span class="token number">1</span>  <span class="token number">0.302910</span> <span class="token operator">-</span><span class="token number">0.435742</span> <span class="token operator">-</span><span class="token number">0.254180</span> <span class="token operator">-</span><span class="token number">0.673480</span>
<span class="token number">2</span> <span class="token operator">-</span><span class="token number">0.328522</span> <span class="token operator">-</span><span class="token number">0.025302</span>  <span class="token number">0.138351</span> <span class="token operator">-</span><span class="token number">0.090878</span>
<span class="token number">3</span> <span class="token operator">-</span><span class="token number">0.351475</span> <span class="token operator">-</span><span class="token number">0.719605</span> <span class="token operator">-</span><span class="token number">0.258215</span> <span class="token operator">-</span><span class="token number">0.489494</span>
<span class="token number">4</span>  <span class="token number">1.243269</span> <span class="token operator">-</span><span class="token number">0.373799</span> <span class="token operator">-</span><span class="token number">0.522629</span> <span class="token operator">-</span><span class="token number">0.128941</span>
</code></pre> 
<p>现在，我们使用<code>statsmodels</code>的公式<code>API</code>和<code>Patsy</code>的公式字符串：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">:</span> results <span class="token operator">=</span> smf<span class="token punctuation">.</span>ols<span class="token punctuation">(</span><span class="token string">'y ~ col0 + col1 + col2'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">78</span><span class="token punctuation">]</span><span class="token punctuation">:</span> results<span class="token punctuation">.</span>params
Out<span class="token punctuation">[</span><span class="token number">78</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
Intercept    <span class="token number">0.033559</span>
col0         <span class="token number">0.176149</span>
col1         <span class="token number">0.224826</span>
col2         <span class="token number">0.514808</span>
dtype<span class="token punctuation">:</span> float64

In <span class="token punctuation">[</span><span class="token number">79</span><span class="token punctuation">]</span><span class="token punctuation">:</span> results<span class="token punctuation">.</span>tvalues
Out<span class="token punctuation">[</span><span class="token number">79</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
Intercept    <span class="token number">0.952188</span>
col0         <span class="token number">3.319754</span>
col1         <span class="token number">4.850730</span>
col2         <span class="token number">6.303971</span>
dtype<span class="token punctuation">:</span> float64
</code></pre> 
<p>观察下<code>statsmodels</code>是如何返回<code>Series</code>结果的，附带有<code>DataFrame</code>的列名。当使用公式和<code>pandas</code>对象时，我们不需要使用<code>add_constant</code>。</p> 
<p>给出一个样本外数据，你可以根据估计的模型参数计算预测值：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">:</span> results<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
<span class="token number">0</span>   <span class="token operator">-</span><span class="token number">0.002327</span>
<span class="token number">1</span>   <span class="token operator">-</span><span class="token number">0.141904</span>
<span class="token number">2</span>    <span class="token number">0.041226</span>
<span class="token number">3</span>   <span class="token operator">-</span><span class="token number">0.323070</span>
<span class="token number">4</span>   <span class="token operator">-</span><span class="token number">0.100535</span>
dtype<span class="token punctuation">:</span> float64
</code></pre> 
<p><code>statsmodels</code>的线性模型结果还有其它的分析、诊断和可视化工具。除了普通最小二乘模型，还有其它的线性模型。</p> 
<h3><a id="_636"></a>估计时间序列过程</h3> 
<p><code>statsmodels</code>的另一模型类是进行时间序列分析，包括自回归过程、卡尔曼滤波和其它态空间模型，和多元自回归模型。</p> 
<p>用自回归结构和噪声来模拟一些时间序列数据：</p> 
<pre><code class="prism language-python">init_x <span class="token operator">=</span> <span class="token number">4</span>

<span class="token keyword">import</span> random
values <span class="token operator">=</span> <span class="token punctuation">[</span>init_x<span class="token punctuation">,</span> init_x<span class="token punctuation">]</span>
N <span class="token operator">=</span> <span class="token number">1000</span>

b0 <span class="token operator">=</span> <span class="token number">0.8</span>
b1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.4</span>
noise <span class="token operator">=</span> dnorm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
    new_x <span class="token operator">=</span> values<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> b0 <span class="token operator">+</span> values<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> b1 <span class="token operator">+</span> noise<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    values<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_x<span class="token punctuation">)</span>
</code></pre> 
<p>这个数据有<code>AR(2)</code>结构（两个延迟），参数是<code>0.8</code>和<code>-0.4</code>。拟合<code>AR</code>模型时，你可能不知道滞后项的个数，因此可以用较多的滞后量来拟合这个模型：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">82</span><span class="token punctuation">]</span><span class="token punctuation">:</span> MAXLAGS <span class="token operator">=</span> <span class="token number">5</span>

In <span class="token punctuation">[</span><span class="token number">83</span><span class="token punctuation">]</span><span class="token punctuation">:</span> model <span class="token operator">=</span> sm<span class="token punctuation">.</span>tsa<span class="token punctuation">.</span>AR<span class="token punctuation">(</span>values<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">84</span><span class="token punctuation">]</span><span class="token punctuation">:</span> results <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>MAXLAGS<span class="token punctuation">)</span>
</code></pre> 
<p>结果中的估计参数首先是截距，其次是前两个参数的估计值：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">85</span><span class="token punctuation">]</span><span class="token punctuation">:</span> results<span class="token punctuation">.</span>params
Out<span class="token punctuation">[</span><span class="token number">85</span><span class="token punctuation">]</span><span class="token punctuation">:</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.0062</span><span class="token punctuation">,</span>  <span class="token number">0.7845</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.4085</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0136</span><span class="token punctuation">,</span>  <span class="token number">0.015</span> <span class="token punctuation">,</span>  <span class="token number">0.0143</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre> 
<p>更多的细节以及如何解释结果超出了本书的范围，可以通过statsmodels文档学习更多。</p> 
<h2><a id="scikitlearn_673"></a>scikit-learn介绍</h2> 
<p><code>scikit-learn</code>是一个广泛使用、用途多样的<code>Python</code>机器学习库。它包含多种标准监督和非监督机器学习方法和模型选择和评估、数据转换、数据加载和模型持久化工具。这些模型可以用于分类、聚合、预测和其它任务。</p> 
<p>机器学习方面的学习和应用<code>scikit-learn</code>和<code>TensorFlow</code>解决实际问题的线上和纸质资料很多。本节中，我会简要介绍<code>scikit-learn API</code>的风格。</p> 
<p>写作此书的时候，<code>scikit-learn</code>并没有和<code>pandas</code>深度结合，但是有些第三方包在开发中。尽管如此，<code>pandas</code>非常适合在模型拟合前处理数据集。</p> 
<p>举个例子，我用一个<code>Kaggle</code>竞赛的经典数据集，关于泰坦尼克号乘客的生还率。我们用<code>pandas</code>加载测试和训练数据集：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">86</span><span class="token punctuation">]</span><span class="token punctuation">:</span> train <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'datasets/titanic/train.csv'</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">87</span><span class="token punctuation">]</span><span class="token punctuation">:</span> test <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'datasets/titanic/test.csv'</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">88</span><span class="token punctuation">]</span><span class="token punctuation">:</span> train<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
Out<span class="token punctuation">[</span><span class="token number">88</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
   PassengerId  Survived  Pclass  \
<span class="token number">0</span>            <span class="token number">1</span>         <span class="token number">0</span>       <span class="token number">3</span>   
<span class="token number">1</span>            <span class="token number">2</span>         <span class="token number">1</span>       <span class="token number">1</span>   
<span class="token number">2</span>            <span class="token number">3</span>         <span class="token number">1</span>       <span class="token number">3</span>   
<span class="token number">3</span>            <span class="token number">4</span>         <span class="token number">1</span>       <span class="token number">1</span>   
                                                Name     Sex   Age  SibSp  \
<span class="token number">0</span>                            Braund<span class="token punctuation">,</span> Mr<span class="token punctuation">.</span> Owen Harris    male  <span class="token number">22.0</span>      <span class="token number">1</span>   
<span class="token number">1</span>  Cumings<span class="token punctuation">,</span> Mrs<span class="token punctuation">.</span> John Bradley <span class="token punctuation">(</span>Florence Briggs Th<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  female  <span class="token number">38.0</span>      <span class="token number">1</span>   
<span class="token number">2</span>                             Heikkinen<span class="token punctuation">,</span> Miss<span class="token punctuation">.</span> Laina  female  <span class="token number">26.0</span>      <span class="token number">0</span>   
<span class="token number">3</span>       Futrelle<span class="token punctuation">,</span> Mrs<span class="token punctuation">.</span> Jacques Heath <span class="token punctuation">(</span>Lily May Peel<span class="token punctuation">)</span>  female  <span class="token number">35.0</span>      <span class="token number">1</span>   
   Parch            Ticket     Fare Cabin Embarked  
<span class="token number">0</span>      <span class="token number">0</span>         A<span class="token operator">/</span><span class="token number">5</span> <span class="token number">21171</span>   <span class="token number">7.2500</span>   NaN        S  
<span class="token number">1</span>      <span class="token number">0</span>          PC <span class="token number">17599</span>  <span class="token number">71.2833</span>   C85        C  
<span class="token number">2</span>      <span class="token number">0</span>  STON<span class="token operator">/</span>O2<span class="token punctuation">.</span> <span class="token number">3101282</span>   <span class="token number">7.9250</span>   NaN        S  
<span class="token number">3</span>      <span class="token number">0</span>            <span class="token number">113803</span>  <span class="token number">53.1000</span>  C123        S
</code></pre> 
<p><code>statsmodels</code>和<code>scikit-learn</code>通常不能接收缺失数据，因此我们要查看列是否包含缺失值：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">89</span><span class="token punctuation">]</span><span class="token punctuation">:</span> train<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">89</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
PassengerId      <span class="token number">0</span>
Survived         <span class="token number">0</span>
Pclass           <span class="token number">0</span>
Name             <span class="token number">0</span>
Sex              <span class="token number">0</span>
Age            <span class="token number">177</span>
SibSp            <span class="token number">0</span>
Parch            <span class="token number">0</span>
Ticket           <span class="token number">0</span>
Fare             <span class="token number">0</span>
Cabin          <span class="token number">687</span>
Embarked         <span class="token number">2</span>
dtype<span class="token punctuation">:</span> int64

In <span class="token punctuation">[</span><span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">:</span> test<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
PassengerId      <span class="token number">0</span>
Pclass           <span class="token number">0</span>
Name             <span class="token number">0</span>
Sex              <span class="token number">0</span>
Age             <span class="token number">86</span>
SibSp            <span class="token number">0</span>
Parch            <span class="token number">0</span>
Ticket           <span class="token number">0</span>
Fare             <span class="token number">1</span>
Cabin          <span class="token number">327</span>
Embarked         <span class="token number">0</span>
dtype<span class="token punctuation">:</span> int64
</code></pre> 
<p>在统计和机器学习的例子中，根据数据中的特征，一个典型的任务是预测乘客能否生还。模型现在训练数据集中拟合，然后用样本外测试数据集评估。</p> 
<p>我想用年龄作为预测值，但是它包含缺失值。缺失数据补全的方法有多种，我用的是一种简单方法，用训练数据集的中位数补全两个表的空值：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">91</span><span class="token punctuation">]</span><span class="token punctuation">:</span> impute_value <span class="token operator">=</span> train<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>median<span class="token punctuation">(</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">92</span><span class="token punctuation">]</span><span class="token punctuation">:</span> train<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> train<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>impute_value<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">93</span><span class="token punctuation">]</span><span class="token punctuation">:</span> test<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> test<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>impute_value<span class="token punctuation">)</span>
</code></pre> 
<p>现在我们需要指定模型。我增加了一个列<code>IsFemale</code>，作为<code>“Sex”</code>列的编码（<strong>将<code>Sex</code>列生成一个新列<code>IsFemale</code>，这里使用了一个条件表达式，会产生一个布尔类型的<code>Series</code>，然后使用<code>astype(int)</code>将布尔值转换为整数</strong>）：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">94</span><span class="token punctuation">]</span><span class="token punctuation">:</span> train<span class="token punctuation">[</span><span class="token string">'IsFemale'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>train<span class="token punctuation">[</span><span class="token string">'Sex'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'female'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">95</span><span class="token punctuation">]</span><span class="token punctuation">:</span> test<span class="token punctuation">[</span><span class="token string">'IsFemale'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token string">'Sex'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'female'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
</code></pre> 
<p>然后，我们确定一些模型变量，并创建<code>NumPy</code>数组：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">96</span><span class="token punctuation">]</span><span class="token punctuation">:</span> predictors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Pclass'</span><span class="token punctuation">,</span> <span class="token string">'IsFemale'</span><span class="token punctuation">,</span> <span class="token string">'Age'</span><span class="token punctuation">]</span>

In <span class="token punctuation">[</span><span class="token number">97</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X_train <span class="token operator">=</span> train<span class="token punctuation">[</span>predictors<span class="token punctuation">]</span><span class="token punctuation">.</span>values

In <span class="token punctuation">[</span><span class="token number">98</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X_test <span class="token operator">=</span> test<span class="token punctuation">[</span>predictors<span class="token punctuation">]</span><span class="token punctuation">.</span>values

In <span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y_train <span class="token operator">=</span> train<span class="token punctuation">[</span><span class="token string">'Survived'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values

In <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">:</span> X_train<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
Out<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>  <span class="token number">3.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>  <span class="token number">22.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>  <span class="token number">1.</span><span class="token punctuation">,</span>   <span class="token number">1.</span><span class="token punctuation">,</span>  <span class="token number">38.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>  <span class="token number">3.</span><span class="token punctuation">,</span>   <span class="token number">1.</span><span class="token punctuation">,</span>  <span class="token number">26.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>  <span class="token number">1.</span><span class="token punctuation">,</span>   <span class="token number">1.</span><span class="token punctuation">,</span>  <span class="token number">35.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>  <span class="token number">3.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>  <span class="token number">35.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y_train<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
Out<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">]</span><span class="token punctuation">:</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>我不能保证这是一个好模型，但它的特征都符合。我们用<code>scikit-learn</code>的<code>LogisticRegression</code>模型，创建一个模型实例：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LogisticRegression

In <span class="token punctuation">[</span><span class="token number">103</span><span class="token punctuation">]</span><span class="token punctuation">:</span> model <span class="token operator">=</span> LogisticRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>与<code>statsmodels</code>类似，我们可以用模型的<code>fit</code>方法，将它拟合到训练数据：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">]</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
LogisticRegression<span class="token punctuation">(</span>C<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> class_weight<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> dual<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> fit_intercept<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
          intercept_scaling<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max_iter<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> multi_class<span class="token operator">=</span><span class="token string">'ovr'</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
          penalty<span class="token operator">=</span><span class="token string">'l2'</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> solver<span class="token operator">=</span><span class="token string">'liblinear'</span><span class="token punctuation">,</span> tol<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span>
          verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> warm_start<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>现在，我们可以用<code>model.predict</code>，对测试数据进行预测：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">105</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y_predict <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">106</span><span class="token punctuation">]</span><span class="token punctuation">:</span> y_predict<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
Out<span class="token punctuation">[</span><span class="token number">106</span><span class="token punctuation">]</span><span class="token punctuation">:</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果你有测试数据集的真是值，你可以计算准确率或其它错误度量值：</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span>y_true <span class="token operator">==</span> y_predict<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>在实际中，模型训练经常有许多额外的复杂因素。许多模型有可以调节的参数，有些方法（比如交叉验证）可以用来进行参数调节，避免对训练数据过拟合。这通常可以提高预测性或对新数据的健壮性。</p> 
<p>交叉验证通过分割训练数据来模拟样本外预测。基于模型的精度得分（比如均方差），可以对模型参数进行网格搜索。有些模型，如logistic回归，有内置的交叉验证的估计类。例如，logisticregressioncv类可以用一个参数指定网格搜索对模型的正则化参数C的粒度：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">107</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LogisticRegressionCV

In <span class="token punctuation">[</span><span class="token number">108</span><span class="token punctuation">]</span><span class="token punctuation">:</span> model_cv <span class="token operator">=</span> LogisticRegressionCV<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">109</span><span class="token punctuation">]</span><span class="token punctuation">:</span> model_cv<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">109</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
LogisticRegressionCV<span class="token punctuation">(</span>Cs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> class_weight<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> dual<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
           fit_intercept<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> intercept_scaling<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> max_iter<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
           multi_class<span class="token operator">=</span><span class="token string">'ovr'</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> penalty<span class="token operator">=</span><span class="token string">'l2'</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
           refit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> solver<span class="token operator">=</span><span class="token string">'lbfgs'</span><span class="token punctuation">,</span> tol<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

</code></pre> 
<p>要手动进行交叉验证，你可以使用<code>cross_val_score</code>帮助函数，它可以处理数据分割。例如，要交叉验证我们的带有四个不重叠训练数据的模型，可以这样做：</p> 
<pre><code class="prism language-python">In <span class="token punctuation">[</span><span class="token number">110</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> cross_val_score

In <span class="token punctuation">[</span><span class="token number">111</span><span class="token punctuation">]</span><span class="token punctuation">:</span> model <span class="token operator">=</span> LogisticRegression<span class="token punctuation">(</span>C<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">112</span><span class="token punctuation">]</span><span class="token punctuation">:</span> scores <span class="token operator">=</span> cross_val_score<span class="token punctuation">(</span>model<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

In <span class="token punctuation">[</span><span class="token number">113</span><span class="token punctuation">]</span><span class="token punctuation">:</span> scores
Out<span class="token punctuation">[</span><span class="token number">113</span><span class="token punctuation">]</span><span class="token punctuation">:</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">0.7723</span><span class="token punctuation">,</span>  <span class="token number">0.8027</span><span class="token punctuation">,</span>  <span class="token number">0.7703</span><span class="token punctuation">,</span>  <span class="token number">0.7883</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>默认的评分指标取决于模型本身，但是可以明确指定一个评分。交叉验证过的模型需要更长时间来训练，但会有更高的模型性能。</p> 
<h2><a id="_840"></a>继续学习</h2> 
<p>我只是介绍了一些<code>Python</code>建模库的表面内容，现在有越来越多的框架用于各种统计和机器学习，它们都是用<code>Python</code>或<code>Python</code>用户界面实现的。</p> 
<p>这本书的重点是数据规整，有其它的书是关注建模和数据科学工具的。其中优秀的有：</p> 
<ul><li>Andreas Mueller and Sarah Guido (O’Reilly)的 《Introduction to Machine Learning with Python》</li><li>Jake VanderPlas (O’Reilly)的 《Python Data Science Handbook》</li><li>Joel Grus (O’Reilly) 的 《Data Science from Scratch: First Principles》</li><li>Sebastian Raschka (Packt Publishing) 的《Python Machine Learning》</li><li>Aurélien Géron (O’Reilly) 的《Hands-On Machine Learning with Scikit-Learn and TensorFlow》</li><li></ul> 
<p>虽然书是学习的好资源，但是随着底层开源软件的发展，书的内容会过时。最好是不断熟悉各种统计和机器学习框架的文档，学习最新的功能和API。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9d9339a67f65d37854f88420dbc2bbd7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【测试SQLite】测试SQLite支持的SQL语句分类</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6811f5581a230b5327042f25f9125976/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">视频标注已上线，支持视频分类、多目标检测｜ModelWhale 版本更新</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>