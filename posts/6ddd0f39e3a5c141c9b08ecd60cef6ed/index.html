<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>StarRocks实战——多点大数据数仓构建 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/6ddd0f39e3a5c141c9b08ecd60cef6ed/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="StarRocks实战——多点大数据数仓构建">
  <meta property="og:description" content="目录
前言
一、背景介绍
二、原有架构的痛点
2.1 技术成本
2.2 开发成本
2.2.1 离线 T&#43;1 更新的分析场景
2.2.2 实时更新分析场景
2.2.3 固定维度分析场景
2.2.4 运维成本
三、选择StarRocks的原因
3.1 引擎收敛
3.2 “大宽表”模型替换
3.3 简化Lambda架构
3.4 模型持续迭代
3.5 明细、汇总一体化
3.6 外表能力
3.7 单表聚合查询
3.8 多表关联查询
3.9 实时更新读写查询
四、实践经验
4.1 集群拆分
4.2 按照数据更新频率进行拆分
4.3 按照业务域进行拆分
4.4 调优手段
4.4.1 优化表结构定义
1）模型选择
2）分区和分桶 3）稀疏索引、bloomfilter、Bitmap Index
4）物化视图
5）使用BITMAP / HyperLogLog 数据类型进行去重
4.4.2 优化查询SQL
1）Broadcast Join
2）Colocation Join
3）并行度调整
4）CBO 优化器
4.5 工具集成
4.5.1 数据集成">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-17T10:48:36+08:00">
    <meta property="article:modified_time" content="2024-04-17T10:48:36+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">StarRocks实战——多点大数据数仓构建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%89%8D%E8%A8%80-toc" style="margin-left:0px;"><a href="#%E5%89%8D%E8%A8%80" rel="nofollow">前言</a></p> 
<p id="%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D" rel="nofollow">一、背景介绍</a></p> 
<p id="%E4%BA%8C%E3%80%81%E5%8E%9F%E6%9C%89%E6%9E%B6%E6%9E%84%E7%9A%84%E7%97%9B%E7%82%B9-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%E3%80%81%E5%8E%9F%E6%9C%89%E6%9E%B6%E6%9E%84%E7%9A%84%E7%97%9B%E7%82%B9" rel="nofollow">二、原有架构的痛点</a></p> 
<p id="2.1%20%E6%8A%80%E6%9C%AF%E6%88%90%E6%9C%AC-toc" style="margin-left:40px;"><a href="#2.1%20%E6%8A%80%E6%9C%AF%E6%88%90%E6%9C%AC" rel="nofollow">2.1 技术成本</a></p> 
<p id="2.2%20%E5%BC%80%E5%8F%91%E6%88%90%E6%9C%AC-toc" style="margin-left:40px;"><a href="#2.2%20%E5%BC%80%E5%8F%91%E6%88%90%E6%9C%AC" rel="nofollow">2.2 开发成本</a></p> 
<p id="2.2.1%C2%A0%E7%A6%BB%E7%BA%BF%20T%2B1%20%E6%9B%B4%E6%96%B0%E7%9A%84%E5%88%86%E6%9E%90%E5%9C%BA%E6%99%AF-toc" style="margin-left:80px;"><a href="#2.2.1%C2%A0%E7%A6%BB%E7%BA%BF%20T%2B1%20%E6%9B%B4%E6%96%B0%E7%9A%84%E5%88%86%E6%9E%90%E5%9C%BA%E6%99%AF" rel="nofollow">2.2.1 离线 T+1 更新的分析场景</a></p> 
<p id="2.2.2%20%E5%AE%9E%E6%97%B6%E6%9B%B4%E6%96%B0%E5%88%86%E6%9E%90%E5%9C%BA%E6%99%AF-toc" style="margin-left:80px;"><a href="#2.2.2%20%E5%AE%9E%E6%97%B6%E6%9B%B4%E6%96%B0%E5%88%86%E6%9E%90%E5%9C%BA%E6%99%AF" rel="nofollow">2.2.2 实时更新分析场景</a></p> 
<p id="2.2.3%20%E5%9B%BA%E5%AE%9A%E7%BB%B4%E5%BA%A6%E5%88%86%E6%9E%90%E5%9C%BA%E6%99%AF-toc" style="margin-left:80px;"><a href="#2.2.3%20%E5%9B%BA%E5%AE%9A%E7%BB%B4%E5%BA%A6%E5%88%86%E6%9E%90%E5%9C%BA%E6%99%AF" rel="nofollow">2.2.3 固定维度分析场景</a></p> 
<p id="2.2.4%C2%A0%E8%BF%90%E7%BB%B4%E6%88%90%E6%9C%AC-toc" style="margin-left:80px;"><a href="#2.2.4%C2%A0%E8%BF%90%E7%BB%B4%E6%88%90%E6%9C%AC" rel="nofollow">2.2.4 运维成本</a></p> 
<p id="%E4%B8%89%E3%80%81%E9%80%89%E6%8B%A9StarRocks%E7%9A%84%E5%8E%9F%E5%9B%A0-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E9%80%89%E6%8B%A9StarRocks%E7%9A%84%E5%8E%9F%E5%9B%A0" rel="nofollow">三、选择StarRocks的原因</a></p> 
<p id="3.1%20%E5%BC%95%E6%93%8E%E6%94%B6%E6%95%9B-toc" style="margin-left:40px;"><a href="#3.1%20%E5%BC%95%E6%93%8E%E6%94%B6%E6%95%9B" rel="nofollow">3.1 引擎收敛</a></p> 
<p id="3.2%20%E2%80%9C%E5%A4%A7%E5%AE%BD%E8%A1%A8%E2%80%9D%E6%A8%A1%E5%9E%8B%E6%9B%BF%E6%8D%A2-toc" style="margin-left:40px;"><a href="#3.2%20%E2%80%9C%E5%A4%A7%E5%AE%BD%E8%A1%A8%E2%80%9D%E6%A8%A1%E5%9E%8B%E6%9B%BF%E6%8D%A2" rel="nofollow">3.2 “大宽表”模型替换</a></p> 
<p id="3.3%C2%A0%E7%AE%80%E5%8C%96Lambda%E6%9E%B6%E6%9E%84-toc" style="margin-left:40px;"><a href="#3.3%C2%A0%E7%AE%80%E5%8C%96Lambda%E6%9E%B6%E6%9E%84" rel="nofollow">3.3 简化Lambda架构</a></p> 
<p id="3.4%20%E6%A8%A1%E5%9E%8B%E6%8C%81%E7%BB%AD%E8%BF%AD%E4%BB%A3-toc" style="margin-left:40px;"><a href="#3.4%20%E6%A8%A1%E5%9E%8B%E6%8C%81%E7%BB%AD%E8%BF%AD%E4%BB%A3" rel="nofollow">3.4 模型持续迭代</a></p> 
<p id="3.5%20%E6%98%8E%E7%BB%86%E3%80%81%E6%B1%87%E6%80%BB%E4%B8%80%E4%BD%93%E5%8C%96-toc" style="margin-left:40px;"><a href="#3.5%20%E6%98%8E%E7%BB%86%E3%80%81%E6%B1%87%E6%80%BB%E4%B8%80%E4%BD%93%E5%8C%96" rel="nofollow">3.5 明细、汇总一体化</a></p> 
<p id="3.6%20%E5%A4%96%E8%A1%A8%E8%83%BD%E5%8A%9B-toc" style="margin-left:40px;"><a href="#3.6%20%E5%A4%96%E8%A1%A8%E8%83%BD%E5%8A%9B" rel="nofollow">3.6 外表能力</a></p> 
<p id="3.7%C2%A0%E5%8D%95%E8%A1%A8%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-toc" style="margin-left:40px;"><a href="#3.7%C2%A0%E5%8D%95%E8%A1%A8%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2" rel="nofollow">3.7 单表聚合查询</a></p> 
<p id="3.8%C2%A0%E5%A4%9A%E8%A1%A8%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2-toc" style="margin-left:40px;"><a href="#3.8%C2%A0%E5%A4%9A%E8%A1%A8%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2" rel="nofollow">3.8 多表关联查询</a></p> 
<p id="3.9%20%E5%AE%9E%E6%97%B6%E6%9B%B4%E6%96%B0%E8%AF%BB%E5%86%99%E6%9F%A5%E8%AF%A2-toc" style="margin-left:40px;"><a href="#3.9%20%E5%AE%9E%E6%97%B6%E6%9B%B4%E6%96%B0%E8%AF%BB%E5%86%99%E6%9F%A5%E8%AF%A2" rel="nofollow">3.9 实时更新读写查询</a></p> 
<p id="%E5%9B%9B%E3%80%81%E5%AE%9E%E8%B7%B5%E7%BB%8F%E9%AA%8C-toc" style="margin-left:0px;"><a href="#%E5%9B%9B%E3%80%81%E5%AE%9E%E8%B7%B5%E7%BB%8F%E9%AA%8C" rel="nofollow">四、实践经验</a></p> 
<p id="4.1%20%E9%9B%86%E7%BE%A4%E6%8B%86%E5%88%86-toc" style="margin-left:40px;"><a href="#4.1%20%E9%9B%86%E7%BE%A4%E6%8B%86%E5%88%86" rel="nofollow">4.1 集群拆分</a></p> 
<p id="4.2%20%E6%8C%89%E7%85%A7%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E9%A2%91%E7%8E%87%E8%BF%9B%E8%A1%8C%E6%8B%86%E5%88%86-toc" style="margin-left:40px;"><a href="#4.2%20%E6%8C%89%E7%85%A7%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E9%A2%91%E7%8E%87%E8%BF%9B%E8%A1%8C%E6%8B%86%E5%88%86" rel="nofollow">4.2 按照数据更新频率进行拆分</a></p> 
<p id="4.2%20%E6%8C%89%E7%85%A7%E4%B8%9A%E5%8A%A1%E5%9F%9F%E8%BF%9B%E8%A1%8C%E6%8B%86%E5%88%86-toc" style="margin-left:40px;"><a href="#4.2%20%E6%8C%89%E7%85%A7%E4%B8%9A%E5%8A%A1%E5%9F%9F%E8%BF%9B%E8%A1%8C%E6%8B%86%E5%88%86" rel="nofollow">4.3 按照业务域进行拆分</a></p> 
<p id="4.3%C2%A0%E8%B0%83%E4%BC%98%E6%89%8B%E6%AE%B5-toc" style="margin-left:40px;"><a href="#4.3%C2%A0%E8%B0%83%E4%BC%98%E6%89%8B%E6%AE%B5" rel="nofollow">4.4 调优手段</a></p> 
<p id="4.3.1%C2%A0%E4%BC%98%E5%8C%96%E8%A1%A8%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89-toc" style="margin-left:80px;"><a href="#4.3.1%C2%A0%E4%BC%98%E5%8C%96%E8%A1%A8%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89" rel="nofollow">4.4.1 优化表结构定义</a></p> 
<p id="%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9-toc" style="margin-left:120px;"><a href="#%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9" rel="nofollow">1）模型选择</a></p> 
<p id="%E5%88%86%E5%8C%BA%E5%92%8C%E5%88%86%E6%A1%B6%C2%A0-toc" style="margin-left:120px;"><a href="#%E5%88%86%E5%8C%BA%E5%92%8C%E5%88%86%E6%A1%B6%C2%A0" rel="nofollow">2）分区和分桶 </a></p> 
<p id="%E7%A8%80%E7%96%8F%E7%B4%A2%E5%BC%95%E3%80%81bloomfilter%E3%80%81Bitmap%20Index-toc" style="margin-left:120px;"><a href="#%E7%A8%80%E7%96%8F%E7%B4%A2%E5%BC%95%E3%80%81bloomfilter%E3%80%81Bitmap%20Index" rel="nofollow">3）稀疏索引、bloomfilter、Bitmap Index</a></p> 
<p id="%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE-toc" style="margin-left:120px;"><a href="#%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE" rel="nofollow">4）物化视图</a></p> 
<p id="%E4%BD%BF%E7%94%A8BITMAP%20%2F%20HyperLogLog%20%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%BF%9B%E8%A1%8C%E5%8E%BB%E9%87%8D-toc" style="margin-left:120px;"><a href="#%E4%BD%BF%E7%94%A8BITMAP%20%2F%20HyperLogLog%20%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%BF%9B%E8%A1%8C%E5%8E%BB%E9%87%8D" rel="nofollow">5）使用BITMAP / HyperLogLog 数据类型进行去重</a></p> 
<p id="4.3.2%C2%A0%E4%BC%98%E5%8C%96%E6%9F%A5%E8%AF%A2%20SQL-toc" style="margin-left:80px;"><a href="#4.3.2%C2%A0%E4%BC%98%E5%8C%96%E6%9F%A5%E8%AF%A2%20SQL" rel="nofollow">4.4.2 优化查询SQL</a></p> 
<p id="Broadcast%20Join-toc" style="margin-left:120px;"><a href="#Broadcast%20Join" rel="nofollow">1）Broadcast Join</a></p> 
<p id="Colocation%20Join-toc" style="margin-left:120px;"><a href="#Colocation%20Join" rel="nofollow">2）Colocation Join</a></p> 
<p id="%E5%B9%B6%E8%A1%8C%E5%BA%A6%E8%B0%83%E6%95%B4-toc" style="margin-left:120px;"><a href="#%E5%B9%B6%E8%A1%8C%E5%BA%A6%E8%B0%83%E6%95%B4" rel="nofollow">3）并行度调整</a></p> 
<p id="CBO%20%E4%BC%98%E5%8C%96%E5%99%A8-toc" style="margin-left:120px;"><a href="#CBO%20%E4%BC%98%E5%8C%96%E5%99%A8" rel="nofollow">4）CBO 优化器</a></p> 
<p id="4.4%C2%A0%E5%B7%A5%E5%85%B7%E9%9B%86%E6%88%90-toc" style="margin-left:40px;"><a href="#4.4%C2%A0%E5%B7%A5%E5%85%B7%E9%9B%86%E6%88%90" rel="nofollow">4.5 工具集成</a></p> 
<p id="4.4.1%C2%A0%20%E6%95%B0%E6%8D%AE%E9%9B%86%E6%88%90-toc" style="margin-left:80px;"><a href="#4.4.1%C2%A0%20%E6%95%B0%E6%8D%AE%E9%9B%86%E6%88%90" rel="nofollow">4.5.1  数据集成</a></p> 
<p id="4.4.2%C2%A0%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6-toc" style="margin-left:80px;"><a href="#4.4.2%C2%A0%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6" rel="nofollow">4.5.2 监控预警</a></p> 
<p id="%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93-toc" style="margin-left:0px;"><a href="#%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93" rel="nofollow">五、总结</a></p> 
<hr id="hr-toc"> 
<p>   原文大佬介绍的这篇StarRocks数仓建设实践有借鉴意义的，这些摘抄下来用作沉淀学习。如有侵权，请告知~</p> 
<h2 id="%E5%89%8D%E8%A8%80">前言</h2> 
<p>      多点 DMALL 成立于2015年，是一站式全渠道数字零售解决方案服务商。 多点大数据部门使用 StarRocks逐步替代了 Impala、Impala on Kudu、Apache Kylin等存储引擎，实现了<strong><span style="background-color:#ffd7b9;">存储引擎的收敛，简化了实时数据处理链路，同时也能保障较高的查询并发以及较低的响应延迟要求</span>。</strong></p> 
<h2 id="%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D">一、背景介绍</h2> 
<p>     多点大数据部门为内部业务研发团队、数据分析师、外部用户以及合作伙伴，提供了基础的大数据产品、平台服务，帮助零售企业解决了从基本的数据汇总管理、统一的数据计算应用、到各种场景下对数据的多模式使用的需求，可覆盖零售企业绝大部分数据诉求。</p> 
<p><img alt="" height="165" src="https://images2.imgbox.com/e9/b2/Uer0tRZQ_o.png" width="500"></p> 
<p>    技术层面，多点大数据部门基于 Hadoop 开源技术栈，并进行了部分二次开发后构建起了以下的一个技术架构全景图。从下到上分为基础设施层、数据源层、数据集成层、离线/实时计算层、集市层、分析存储层、数据服务/应用层，数据开发，数据模型中心与运维管理层对各层提供支持。</p> 
<p><img alt="" height="406" src="https://images2.imgbox.com/3d/00/b5145b8A_o.png" width="600"></p> 
<ul><li>基础设施层：包括超大带宽的专线网络；公有云、私有云、机房托管的混合云部署；</li><li>数据源层：包括企业OLTP 数据库、业务数据、日志数据、三方接入数据；</li><li>数据集成层：DataBus 是多点自研数据同步平台，解决企业内各业务线之间，<span style="background-color:#ffd7b9;">跨企业组织之间以及跨行业的数据汇聚，融合等问题，将不同系统的数据互相打通，实现数据自由流动</span>；</li><li>离线计算层：利用Hive /Spark高可扩展的批处理能力承担离线数仓的ETL和数据模型加工；</li><li>实时计算层：利用Flink /Spark Streaming完成实时数据的ETL<strong>（包括维度扩充，多流join，实时汇总）</strong>等；</li><li>离线/实时集市层：使用数仓分层模型构建ODS(原始数据层)，DWD（数据明细层）、DWS（汇总层）、DIM（维度层）、DWT（主题层）、ADS（应用层），并根据公司业务拆不同的数据域；</li><li><strong>分析存储层</strong>：主要依赖Druid、ClickHouse、Impala on Kudu、Apache Kylin、Elasticsearch、HBase、MySQL、StarRocks提供OLAP查询能力；</li><li>数据服务/应用层：该层通过提供BI分析产品、数据服务接口，营销，报表类产品，向内部运营人员、外部客户，合作伙伴提供数据分析决策能力；</li></ul> 
<h2 id="%E4%BA%8C%E3%80%81%E5%8E%9F%E6%9C%89%E6%9E%B6%E6%9E%84%E7%9A%84%E7%97%9B%E7%82%B9">二、原有架构的痛点</h2> 
<p>   上述架构解决了多点绝大部分数据诉求，在整个架构中，无论是基于Hive，Spark的离线计算，基于Flink ,Spark Streaming 的实时计算；基于HDFS，kafka的存储；基于数仓分层模型建设等方案都已基本成熟。但是在OLAP领域，无论是多点还是业界仍然处于百家争鸣，各有所长的状态。纵观多点在OLAP引擎的探索实践中，遇到了各种各样问题，总结如下：</p> 
<h3 id="2.1%20%E6%8A%80%E6%9C%AF%E6%88%90%E6%9C%AC">2.1 技术成本</h3> 
<p>    由于上层业务场景复杂，各个场景的技术难点，核心点均不一样。多点生活在整个技术架构升级的过程中先后引入了HBase、Elasticsearch、Druid、ClickHouse、Impala on Kudu、Kylin等OLAP引擎。但是随着技术栈增多，技术曲线陡峭，没有充足的资源进行多技术栈的维护，造成了比较高的技术成本。</p> 
<p><img alt="" height="216" src="https://images2.imgbox.com/f0/ac/e0yTLtt8_o.png" width="500"></p> 
<h3 id="2.2%20%E5%BC%80%E5%8F%91%E6%88%90%E6%9C%AC">2.2 开发成本</h3> 
<p>  多点数据分析场景大致可以分为<strong>离线+1更新分析场景</strong>，<strong>实时更新分析场景</strong>，<strong>固定维度分析场景。</strong></p> 
<h4 id="2.2.1%C2%A0%E7%A6%BB%E7%BA%BF%20T%2B1%20%E6%9B%B4%E6%96%B0%E7%9A%84%E5%88%86%E6%9E%90%E5%9C%BA%E6%99%AF">2.2.1 <strong>离线 T+1 更新的分析场景</strong></h4> 
<p><strong>   </strong>例如<span style="background-color:#ffd7b9;">多点的精细化用户运营平台</span>，其核心的功能是基于用户、消费、行为、设备等属性，提供多维度筛选条件，并通过自定义条件实现用户分层，便于进行精细化用户运营。</p> 
<p><img alt="" height="301" src="https://images2.imgbox.com/b4/03/xoM9kSMO_o.png" width="300"></p> 
<p>    针对数据更新为T+1的分析场景，原主要使用的分析引擎为ClickHouse。利用ClickHouse构建“大宽表”模型，将事实表与维度表提前进行关联，对外提供单表聚合的SQL查询，以及通过构建DWT主题宽表，提供Ad-Hoc查询；该场景面临的问题是：<strong><span style="background-color:#ffd7b9;">虽然ClickHouse单表查询强悍，但是Join能力不强，需要提前进行关联，将多表关联成单表，会存在额外的开发成本</span>。</strong></p> 
<p><img alt="" height="137" src="https://images2.imgbox.com/83/aa/JKakihaA_o.png" width="600"></p> 
<h4 id="2.2.2%20%E5%AE%9E%E6%97%B6%E6%9B%B4%E6%96%B0%E5%88%86%E6%9E%90%E5%9C%BA%E6%99%AF">2.2.2 <strong>实时更新分析场景</strong></h4> 
<p><strong>   </strong>实时更新场景主要是实时监控经营的各项指标，如当前时间段内的 GMV、下单数量、妥投数量、指标达成、对比，环比等指标，为客户的经营决策提供更具备时效性的参考依据。</p> 
<p></p> 
<p><img alt="" height="145" src="https://images2.imgbox.com/82/b7/jUAUYODD_o.png" width="1080"></p> 
<p>    针对数据为实时（秒级）更新的场景，原主要使用Impala on Kudu 引擎，采用Lambda架构，基于相同的主键，将流式的预计算的结果数据，批计算的结果数据，基于相同的主键进行merge。</p> 
<p><img alt="" height="391" src="https://images2.imgbox.com/dc/4b/O1DJPSJY_o.png" width="600"></p> 
<p>     上述方案中的 Flink AGG部分， 该程序的功能包括<span style="background-color:#ffd7b9;">窗口内的预计算，多流Join</span>等操作。当<span style="background-color:#ffd7b9;">业务需求变更或者上游数据结构变更</span>的时候，需要升级 Flink AGG程序，以及离线ETL的任务，<span style="background-color:#ffd7b9;">类似于“烟囱式”的迭代开发，开发效率低下</span>。资源消耗层面，在Flink里面做预计算，时间窗口的选取以及内存占用之间也需要平衡。</p> 
<h4 id="2.2.3%20%E5%9B%BA%E5%AE%9A%E7%BB%B4%E5%BA%A6%E5%88%86%E6%9E%90%E5%9C%BA%E6%99%AF">2.2.3 固定维度<strong>分析场景</strong></h4> 
<p>     固定维度的分析场景主要针对固化的，标准的业务场景进行分析，多维分析可通过多维形式组织起来的数据进行<span style="background-color:#ffd7b9;">上卷， 下下钻，切片，切块，旋转</span>等各种分析操作，以便剖析数据，使分析者、决策者能从多个角度、多个侧面观察数据仓库中的数据，深入了解包含在数据中的信息和内涵。</p> 
<p>   针对分析维度固定的分析场景，按照业务上常用的分析指标以及维度，此前使用Kylin进行cube预计算，但是使用 Kylin也会遇到如下问题：</p> 
<ul><li>由于多点业务场景涉及的维度比较多，各种类目、营运组织的组合，<span style="background-color:#ffd7b9;">会导致cube膨胀，占用比较多的存储资源；</span></li><li>当数据重跑以及新增维度，指标的时候，针对已经在线上运行的cube模型，为了保障数据重跑时候服务依然可用，需要新增cube模型，并行提供支持，造成存储重复；</li><li>由于目前使用的 Kylin v3.1.2 是使用<span style="background-color:#ffd7b9;">HBase作为后端存储，row key顺序设计以及分区键的选择会严重的影响查询性能，</span>对开发不友好。</li></ul> 
<h4 id="2.2.4%C2%A0%E8%BF%90%E7%BB%B4%E6%88%90%E6%9C%AC">2.2.4 <strong>运维成本</strong></h4> 
<p>   多点大数据产品系统的接入可以大致分为SaaS 化接入、私有云以及本地化部署。针对私有云，本地化部署的客户，OLAP 引擎易部署、易维护、极简的架构尤其重要，像 HBase、Impala on Kudu、Kylin等强依赖 Hadoop生态的OLAP引擎，会增加部署的复杂性；<span style="background-color:#ffd7b9;">ClickHouse集群不能自动感知集群拓扑变化，有不能自动balance数据，会增加缩容，扩容等的维护成本。</span></p> 
<h2 id="%E4%B8%89%E3%80%81%E9%80%89%E6%8B%A9StarRocks%E7%9A%84%E5%8E%9F%E5%9B%A0">三、<strong>选择StarRocks的原因</strong></h2> 
<p>    多点大数据部门从2021年年初开始，在调研市面上常用的存储引擎时发现了StarRocks。StarRocks 架构设计融合了 MPP 数据库，以及分布式系统的设计思想，具备架构精简，支持全面向量化引擎、智能查询优化、高效更新、智能物化视图、标准SQL、流批一体，高可用易扩展等特性，天然的解决了上述的问题。</p> 
<h3 id="3.1%20%E5%BC%95%E6%93%8E%E6%94%B6%E6%95%9B">3.1 引擎收敛</h3> 
<p> <span style="background-color:#ffd7b9;">  原有系统的多维分析，高并发查询，预计算，实时分析，Ad-hoc查询等场景系使用了多套系统，</span>基本上可以使用一套 StarRocks 解决。多点大数据平台、产品逐步形成以 StarRocks为主，其他 OLAP引擎为辅的存储架构，解决维护多套引擎的技术成本问题。</p> 
<h3 id="3.2%20%E2%80%9C%E5%A4%A7%E5%AE%BD%E8%A1%A8%E2%80%9D%E6%A8%A1%E5%9E%8B%E6%9B%BF%E6%8D%A2">3.2 “大宽表”模型替换</h3> 
<p>   StarRocks 支持Broadcast Join、Colocate Join等分布式 Join 的特性，可以在查询性能可接受的范围内，<span style="background-color:#ffd7b9;">使用星型、星座模型替代“大宽表”模型，节约提前关联关联的开发成本</span>，同时针对事实表中历史数据变更，需要重新“跑数”的场景，可以只需重跑（overwrite）部分表的数据，提高整体的“跑数”效率。</p> 
<h3 id="3.3%C2%A0%E7%AE%80%E5%8C%96Lambda%E6%9E%B6%E6%9E%84">3.3 <strong>简化Lambda架构</strong></h3> 
<p>    StarRocks支持明细、聚合、更新、主键模型，可以基于StarRocks自带预聚合的特性，优化掉现有Lambda架构中的预聚合部分。</p> 
<p>   StarRocks 直接拉取/订阅Hive或者 Kafka 中的数据，在 StarRocks 中进行聚合运算；StarRocks的数据模型是Aggregate模型，通过MAX、SUM、MIN、BITMAP_UNION 等聚合函数在StarRocks中进行预聚合。</p> 
<h3 id="3.4%20%E6%A8%A1%E5%9E%8B%E6%8C%81%E7%BB%AD%E8%BF%AD%E4%BB%A3"><strong>3.4 模型持续迭代</strong></h3> 
<p>   针对已在线上运行的模型，如果有需求上的变更，比如增加、删除、变更字段，可以使用简单SQL命令动态地修改表的定义，在表结构变更的过程中，线上的服务不受任何的影响。</p> 
<h3 id="3.5%20%E6%98%8E%E7%BB%86%E3%80%81%E6%B1%87%E6%80%BB%E4%B8%80%E4%BD%93%E5%8C%96">3.5 明细、汇总一体化</h3> 
<p>   在实际的业务场景中，通常存在两种场景并存的分析需求：对固定维度的聚合分析和对原始明细数据的查询。在这种情况下，StarRocks支持对原表构建物化视图，数据更新的时候，物化视图跟随原表一起进行更新，保证数据的一致性。<span style="background-color:#ffd7b9;">当用户查询时，并不感知物化视图的存在，不必显式的指定物化视图的名称，查询优化器可以根据查询条件自动判断是否可以路由到相应的物化视图上</span>。</p> 
<h3 id="3.6%20%E5%A4%96%E8%A1%A8%E8%83%BD%E5%8A%9B">3.6 外表能力</h3> 
<p>   StarRocks支持以外部表的形式，接入其他数据源包括 MySQL、HDFS、Elasticsearch、Hive 等。比如可以使用 StarRocks 建立Elasticsearch的外表，为Elasticsearch 提供SQL 查询的能力。</p> 
<h3 id="3.7%C2%A0%E5%8D%95%E8%A1%A8%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><strong>3.7 单表聚合查询</strong></h3> 
<p>    在现有的数据 T+1 更新的汇总业务场景中，选取了多点报表业务中的“单品销售分析”场景进行测试，<span style="background-color:#ffd7b9;">单表单天数据亿级别，上百个维度和分析指标</span>，<span style="background-color:#ffd7b9;">属于典型的基于“大宽表”的 Ad-hoc 查询场景。</span>在相同情况（机器配置、数据量、sql）下进行ClickHouse 对比 StarRocks 的性能测试：</p> 
<p><img alt="" height="297" src="https://images2.imgbox.com/a5/5e/kD6vYD33_o.png" width="500"></p> 
<p>横坐标：分区（天）数-并发数；纵坐标：响应时长（ms）</p> 
<p>从查询响应时长来看，单表的聚合查询，ClickHouse 与 StarRocks 的查询响应时长相差不多。</p> 
<h3 id="3.8%C2%A0%E5%A4%9A%E8%A1%A8%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2">3.8 <strong>多表关联查询</strong></h3> 
<p>    在现有的数据 <span style="background-color:#ffd7b9;">T+1 更新</span><strong>多表关联</strong>的汇总分析业务场景中，选取了现在多点报表业务中的“门店销售分析”场景进行测试，事实表单天数据亿级别，多个维表数据量在十万级别，属于典型的高维分析场景。在相同情况（机器配置、数据量、sql）下进行ClickHouse 对比 StarRocks 的性能测试：</p> 
<p><img alt="" height="361" src="https://images2.imgbox.com/70/18/ny6l09Tw_o.png" width="500"></p> 
<p>横坐标：分区（天）数-并发数；纵坐标：响应时长（ms）</p> 
<p>从查询响应时长来看，多表关联聚合查询，StarRocks的性能要优于ClickHouse。</p> 
<h3 id="3.9%20%E5%AE%9E%E6%97%B6%E6%9B%B4%E6%96%B0%E8%AF%BB%E5%86%99%E6%9F%A5%E8%AF%A2">3.9 实时更新读写查询</h3> 
<p>   在现有的<span style="background-color:#ffd7b9;">数据准实时更新（边写边读）</span>的汇总查询业务场景中，选取了“实时销售分析”场景进行测试，订单数据实时更新，单天数据量亿级别。属于典型的“实时更新，实时查询”场景。在相同情况（机器配置、数据量、SQL）下进行Impala on Kudu对比 StarRocks 的性能测试：</p> 
<p><img alt="" height="349" src="https://images2.imgbox.com/1c/2a/vdSisrqo_o.png" width="500"></p> 
<p>横坐标：分区（天）数-并发数；纵坐标：响应时长（ms）。</p> 
<p>从查询响应时长来看，在边读边写的情况下，聚合查询的 SQL，StarRocks 的性能要优于 Impala on Kudu。</p> 
<h2 id="%E5%9B%9B%E3%80%81%E5%AE%9E%E8%B7%B5%E7%BB%8F%E9%AA%8C">四、<strong>实践经验</strong></h2> 
<p>   多点目前已经在高维业务指标报表，Ad-hoc分析、实时全链路监控等场景中引入了 StarRocks，在使用中总结出以下经验：</p> 
<h3 id="4.1%20%E9%9B%86%E7%BE%A4%E6%8B%86%E5%88%86"><strong>4.1 集群拆分</strong></h3> 
<p>   由于 StarRocks极简的架构设计，易于运维部署。根据一定的规则，搭建了多套集群，避免业务之间的相互影响。</p> 
<h3 id="4.2%20%E6%8C%89%E7%85%A7%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E9%A2%91%E7%8E%87%E8%BF%9B%E8%A1%8C%E6%8B%86%E5%88%86">4.2 按照数据更新频率进行拆分</h3> 
<p>   例如数据是T+1更新，且单表数据量在百亿级别以上的场景（例如高维业务指标报表、Ad-hoc 分析），构建了离线分析集群。通过提高<span style="background-color:#ffd7b9;">StarRocks的查询并发（parallel_fragment_exec_instance_num））、单节点内存限制</span>（exec_mem_limit）等对复杂查询有好的参数，提高集群的查询性能；</p> 
<p>   针对数据是准实时更新，写多读多的场景（实时报表，实时全链路监控），构建了实时分析集群，通过调整StarRocks的compaction（cumulative_compaction_num_threads_per_disk、base_compaction_num_threads_per_disk）等对写入友好的参数，加快数据版本合并。</p> 
<h3 id="4.2%20%E6%8C%89%E7%85%A7%E4%B8%9A%E5%8A%A1%E5%9F%9F%E8%BF%9B%E8%A1%8C%E6%8B%86%E5%88%86"><strong>4.3 按照业务域进行拆分</strong></h3> 
<p>  多点客户的接入方式不同，且各种SLA要求也不同，会按照不同的需求搭建不同的StarRocks就请你，尽量满足多种客户需求。</p> 
<h3 id="4.3%C2%A0%E8%B0%83%E4%BC%98%E6%89%8B%E6%AE%B5">4.4 <strong>调优手段</strong></h3> 
<p>   针对在线服务、系统，为了<span style="background-color:#ffd7b9;">提高系统整体的查询性能</span>，可以从不同的维度进行优化：</p> 
<h4 id="4.3.1%C2%A0%E4%BC%98%E5%8C%96%E8%A1%A8%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89">4.4.1 <strong>优化表结构定义</strong></h4> 
<h5 id="%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9"><strong>1）模型选择</strong></h5> 
<p>StarRocks 的模型包括明细模型、聚合模型、更新模型、主键模型。</p> 
<p>如果需要对原始的数据（例如订单流水，原始操作记录等）来进行分析，可以选择明细模型；</p> 
<p>如果业务方进行的查询为汇总类查询，比如 SUM、COUNT、MAX 等类型的查询，可以选择聚合模型，提前进行预聚合，查询的时候直接获取结果；</p> 
<p>如果数据需要频繁的进行状态更新（比如订单的状态变更），可以选择更新模型。</p> 
<h5 id="%E5%88%86%E5%8C%BA%E5%92%8C%E5%88%86%E6%A1%B6%C2%A0"><strong>2）分区和分桶 </strong></h5> 
<p>    StarRocks可以对表进行分区<strong>(parition) </strong>和分桶<strong>(bucket)</strong>，分区在逻辑上把表划分成了多个子表，可以按照时间进行分区；<span style="background-color:#ffd7b9;">分桶可以按照不同的策略将数据划分为不同的 tablet，分布在不同的 BE 节点上。</span>按照目前多点大数据集群的机器配置（64C+256G+12TB SSD），通常将一个 tablet 保持在200MB~1GB的大小，会有比较好的性能。</p> 
<h5 id="%E7%A8%80%E7%96%8F%E7%B4%A2%E5%BC%95%E3%80%81bloomfilter%E3%80%81Bitmap%20Index"><strong>3）稀疏索引、bloomfilter、Bitmap Index</strong></h5> 
<p>   为了提高查询的性能，可以对 StarRocks 的表结构额外构建索引。稀疏索引：可以将查询中常见的过滤字段放在 schema 的前面, <span style="background-color:#ffd7b9;">区分度越大，频次越高的查询字段越往前放；</span>同时对区分度比较大（高基数列）的列构建 bloomfilter；对区分度不大（低基数列）的列构建 Bitmap Index。</p> 
<h5 id="%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE"><strong>4）物化视图</strong></h5> 
<p>  针对实际查询场景中经常用到的查询 SQL，可以对原始表构建物化视图，其本质为<span style="background-color:#ffd7b9;">原始表 (base table）的一个物化索引，通过物化视图提前进行索引排序，指标预计算，查询的时候子自动路由到物化视图</span>进行查询。</p> 
<h5 id="%E4%BD%BF%E7%94%A8BITMAP%20%2F%20HyperLogLog%20%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%BF%9B%E8%A1%8C%E5%8E%BB%E9%87%8D"><strong>5）使用BITMAP / HyperLogLog 数据类型进行去重</strong></h5> 
<p>   在交易场景中进行会计算交易次数，使用常规的方式（COUNT DISTRINCT order_id）去重，其缺点是需要消耗极大的计算和存储资源，对大规模数据集和查询延迟敏感的去重场景支持不够友好<span style="background-color:#ffd7b9;">。通过定义 BITMAP 的数据类型，可以减少传统 COUNT DISTINCT 去重的执行需要的内存空间、执行时长</span>；而对于像<span style="background-color:#ffd7b9;">流量统计场景中针对 UV 的计算，在允许有部分统计偏差的前提</span>下，可以定义 HyperLogLog 的数据类型，提高去重效率。</p> 
<h4 id="4.3.2%C2%A0%E4%BC%98%E5%8C%96%E6%9F%A5%E8%AF%A2%20SQL">4.4.2 <strong>优化查询SQL</strong></h4> 
<h5 id="Broadcast%20Join"><strong>1）Broadcast Join</strong></h5> 
<p>    当<strong><span style="background-color:#ffd7b9;">大表与小表进行 Join</span> </strong>的时候，可以使用 Broadcast Join（StarRocks 针对小表的默认 Join 方式为 Broadcast Join），<strong><span style="background-color:#ffd7b9;">小表向大表广播的方式进行Join</span></strong>。该方式可以用于事实表与维度表进行关联查询；</p> 
<h5 id="Colocation%20Join"><strong>2）Colocation Join</strong></h5> 
<p>    当<span style="background-color:#ffd7b9;">大表与大表进行 Join</span> 的时候，为了加速查询，相关表可以采用共同的分桶列（colocate_with）进行分桶。当分桶列相同，相关表进行 Join 操作时，可以<span style="background-color:#ffd7b9;">直接在本地进行 Join，再将结果数据进行合并</span>，<span style="background-color:#ffd7b9;">避免数据在中间计算的时候就在集群中的传输</span>。</p> 
<h5 id="%E5%B9%B6%E8%A1%8C%E5%BA%A6%E8%B0%83%E6%95%B4"><strong>3）并行度调整</strong></h5> 
<p>   当机器资源比较充裕时，可以将增加执行并行度（ parallel_fragment_exec_instance_num）让更多的执行实例同时处理一组数据扫描，从而提升查询效率。但是并行度设置为较大的数值会消耗更多的机器资源，例如<strong>CPU、内存、磁盘 IO，影响整体的 QPS。</strong><span style="background-color:#ffd7b9;">需要根据实际上的查询场景来设置并行度，一般建议占用机器核数的50%</span>。</p> 
<h5 id="CBO%20%E4%BC%98%E5%8C%96%E5%99%A8"><strong>4）CBO 优化器</strong></h5> 
<p>   针对复杂Ad-hoc 场景，可以开启 StarRocks的<strong>基于成本（Cost-based Optimizer，CBO）的查询规划器</strong>，在众多查询计划空间中<span style="background-color:#ffd7b9;">快速找到最优计划，提高查询优化器</span>。</p> 
<h3 id="4.4%C2%A0%E5%B7%A5%E5%85%B7%E9%9B%86%E6%88%90"><strong>4.5 工具集成</strong></h3> 
<p>   为了与多点的大数据平台进行打通，对StartRocks进行了一些集成封装。</p> 
<h4 id="4.4.1%C2%A0%20%E6%95%B0%E6%8D%AE%E9%9B%86%E6%88%90">4.5.1  数据集成</h4> 
<p>    通过封装 StarRocks 的Broker Load 以及 Stream Load 接口，与多点的大数据平台打通，实现通过配置的方式将数据从Hive批量同步到StarRocks，或者订阅MQ将实时数据同步到StarRocks。</p> 
<h4 id="4.4.2%C2%A0%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6">4.5.2 监控预警</h4> 
<p>  通过集成Prometheus和Grafana，与监控平台打通。对多个StarRocks集群的运行情况进行监控，<strong><span style="background-color:#ffd7b9;">当集群的某些指标超过一定阈值的时候进行报警。</span></strong></p> 
<h2 id="%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93">五、总结</h2> 
<p>    多点从2021年上半年开始调研引入 StarRocks，当前已有四个集群在稳定运行提供线上服务，逐步替代 Impala、Impala on Kudu、Apache Kylin 等存储引擎，<span style="background-color:#ffd7b9;">实现了存储引擎的收敛，简化了实时数据处理链路，同时也能保障较高的查询并发以及较低的响应延迟要求</span>。</p> 
<p></p> 
<p>参考文章：</p> 
<p><a href="https://mp.weixin.qq.com/s/s0b-lR19o4umWwlfB1jEwQ" rel="nofollow" title="多点 DMALL x StarRocks：实现存储引擎的收敛，保障高查询并发及低延迟要求">多点 DMALL x StarRocks：实现存储引擎的收敛，保障高查询并发及低延迟要求</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c569bd84a2098fab45b4064507055d16/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【大数据】分布式文件系统HDFS</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/988f351a1c14f7cbbf4833dae48bad2f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Stable Diffusion】最新换脸模型：IP-Adapter Face ID Plus V2 WebUI 效果超赞！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>