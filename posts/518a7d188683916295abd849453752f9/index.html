<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ã€C&#43;&#43;å…¥é—¨åˆ°ç²¾é€šã€‘æ™ºèƒ½æŒ‡é’ˆ shared_ptrå¾ªç¯å¼•ç”¨ | weak_ptr ç®€ä»‹åŠC&#43;&#43;æ¨¡æ‹Ÿå®ç° [ C&#43;&#43;å…¥é—¨ ] - ç¼–ç¨‹å­¦ä¹ è€…</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/518a7d188683916295abd849453752f9/">
  <meta property="og:site_name" content="ç¼–ç¨‹å­¦ä¹ è€…">
  <meta property="og:title" content="ã€C&#43;&#43;å…¥é—¨åˆ°ç²¾é€šã€‘æ™ºèƒ½æŒ‡é’ˆ shared_ptrå¾ªç¯å¼•ç”¨ | weak_ptr ç®€ä»‹åŠC&#43;&#43;æ¨¡æ‹Ÿå®ç° [ C&#43;&#43;å…¥é—¨ ]">
  <meta property="og:description" content="é˜…è¯»å¯¼èˆª å¼•è¨€ä¸€ã€std::shared_ptrçš„å¾ªç¯å¼•ç”¨1. æ¦‚å¿µ2. ç¤ºä¾‹åˆ†æ äºŒã€std::weak_ptr1. ç®€ä»‹2. weak_ptræ¨¡æ¿ç±»æä¾›çš„æˆå‘˜æ–¹æ³•3. ä½¿ç”¨ç¤ºä¾‹ï¼ˆ1ï¼‰weak_ptræŒ‡é’ˆçš„åˆ›å»ºï¼ˆ2ï¼‰å®Œæ•´ç¤ºä¾‹ï¼ˆè§£å†³ä¸Šé¢å¾ªç¯å¼•ç”¨é—®é¢˜ï¼‰ 4. C&#43;&#43;æ¨¡æ‹Ÿå®ç° æ¸©é¦¨æç¤º å¼•è¨€ æ¬¢è¿é˜…è¯»æœ¬ç³»åˆ—æ–‡ç« çš„ç¬¬äºŒç¯‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ¢è®¨ä¸ shared_ptr ç›¸å…³çš„ä¸»é¢˜ã€‚ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»äº† shared_ptr çš„å¼ºå¤§åŠŸèƒ½ï¼Œä½†ä¹Ÿæåˆ°äº†å®ƒå¯èƒ½é¢ä¸´çš„ä¸€ä¸ªé—®é¢˜ â€”â€” å¾ªç¯å¼•ç”¨ã€‚å½“ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡ä¹‹é—´ç›¸äº’æŒæœ‰ shared_ptr çš„å¼•ç”¨æ—¶ï¼Œå°±ä¼šå½¢æˆå¾ªç¯å¼•ç”¨ï¼Œå¯¼è‡´è¿™äº›å¯¹è±¡æ— æ³•è¢«æ­£ç¡®é‡Šæ”¾ï¼Œä»è€Œå¼•å‘å†…å­˜æ³„æ¼ã€‚
åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥è®¨è®ºå¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œå¹¶å¼•å…¥å¦ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆç±»â€”â€”weak_ptrã€‚weak_ptr æ˜¯ shared_ptr çš„ä¼™ä¼´ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä»¥é¿å…å¯¹è±¡æ— æ³•é‡Šæ”¾çš„æƒ…å†µã€‚
é€šè¿‡å­¦ä¹  shared_ptr å’Œ weak_ptr çš„ç»„åˆä½¿ç”¨ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†åŠ¨æ€åˆ†é…çš„å¯¹è±¡ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼Œå¹¶æé«˜ä»£ç çš„å¥å£®æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚æ•¬è¯·æœŸå¾…æœ¬æ–‡çš„å‰–æå’Œç¤ºä¾‹ï¼Œå¸Œæœ›èƒ½ç»™æ‚¨å¸¦æ¥æ›´æ·±å…¥çš„äº†è§£å’Œå®è·µç»éªŒã€‚
ä¸€ã€std::shared_ptrçš„å¾ªç¯å¼•ç”¨ 1. æ¦‚å¿µ å½“ä½¿ç”¨ std::shared_ptr æ—¶ï¼Œå¾ªç¯å¼•ç”¨æ˜¯ä¸€ç§å¸¸è§çš„é—®é¢˜ã€‚å¾ªç¯å¼•ç”¨æŒ‡çš„æ˜¯ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡å½¼æ­¤æŒæœ‰ shared_ptr çš„å¼•ç”¨ï¼Œå½¢æˆä¸€ä¸ªç¯çŠ¶ä¾èµ–å…³ç³»ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿æ²¡æœ‰å¤–éƒ¨å¼•ç”¨æŒ‡å‘è¿™äº›å¯¹è±¡ï¼Œå®ƒä»¬çš„å¼•ç”¨è®¡æ•°ä¹Ÿæ— æ³•é™ä¸ºé›¶ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚
å¾ªç¯å¼•ç”¨å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼çš„å‘ç”Ÿï¼Œå› ä¸ºæ¯ä¸ªå¯¹è±¡éƒ½ä¼šæŒæœ‰å¯¹å…¶ä»–å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯¼è‡´å®ƒä»¬çš„å¼•ç”¨è®¡æ•°æ— æ³•å½’é›¶ã€‚å½“æ²¡æœ‰å¤–éƒ¨å¼•ç”¨æŒ‡å‘è¿™äº›å¯¹è±¡æ—¶ï¼Œå®ƒä»¬çš„ææ„å‡½æ•°ä¸ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œå¯¼è‡´èµ„æºæ— æ³•æ­£ç¡®é‡Šæ”¾ã€‚
2. ç¤ºä¾‹åˆ†æ é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼Œè¿™æ®µä»£ç å°±æ˜æ˜¾å­˜åœ¨ç€å¾ªç¯å¼•ç”¨ã€‚
struct ListNode { int _data; shared_ptr&lt;ListNode&gt; _prev; shared_ptr&lt;ListNode&gt; _next; ~ListNode(){ cout &lt;&lt; &#34;~ListNode()&#34; &lt;&lt; endl; } }; int main() { shared_ptr&lt;ListNode&gt; node1(new ListNode); shared_ptr&lt;ListNode&gt; node2(new ListNode); cout &lt;&lt; node1.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-25T15:45:13+08:00">
    <meta property="article:modified_time" content="2024-01-25T15:45:13+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å­¦ä¹ è€…" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å­¦ä¹ è€…</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ã€C&#43;&#43;å…¥é—¨åˆ°ç²¾é€šã€‘æ™ºèƒ½æŒ‡é’ˆ shared_ptrå¾ªç¯å¼•ç”¨ | weak_ptr ç®€ä»‹åŠC&#43;&#43;æ¨¡æ‹Ÿå®ç° [ C&#43;&#43;å…¥é—¨ ]</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/ad/1c/N3yys92M_o.jpg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> </p> 
<div class="toc"> 
 <h4>é˜…è¯»å¯¼èˆª</h4> 
 <ul><li><a href="#_2" rel="nofollow">å¼•è¨€</a></li><li><a href="#stdshared_ptr_8" rel="nofollow">ä¸€ã€std::shared_ptrçš„å¾ªç¯å¼•ç”¨</a></li><li><ul><li><a href="#1__9" rel="nofollow">1. æ¦‚å¿µ</a></li><li><a href="#2__14" rel="nofollow">2. ç¤ºä¾‹åˆ†æ</a></li></ul> 
  </li><li><a href="#stdweak_ptr_49" rel="nofollow">äºŒã€std::weak_ptr</a></li><li><ul><li><a href="#1__50" rel="nofollow">1. ç®€ä»‹</a></li><li><a href="#2_weak_ptr_57" rel="nofollow">2. weak_ptræ¨¡æ¿ç±»æä¾›çš„æˆå‘˜æ–¹æ³•</a></li><li><a href="#3__69" rel="nofollow">3. ä½¿ç”¨ç¤ºä¾‹</a></li><li><ul><li><a href="#1weak_ptr_70" rel="nofollow">ï¼ˆ1ï¼‰weak_ptræŒ‡é’ˆçš„åˆ›å»º</a></li><li><a href="#2_107" rel="nofollow">ï¼ˆ2ï¼‰å®Œæ•´ç¤ºä¾‹ï¼ˆè§£å†³ä¸Šé¢å¾ªç¯å¼•ç”¨é—®é¢˜ï¼‰</a></li></ul> 
   </li><li><a href="#4_C_205" rel="nofollow">4. C++æ¨¡æ‹Ÿå®ç°</a></li></ul> 
  </li><li><a href="#_254" rel="nofollow">æ¸©é¦¨æç¤º</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>å¼•è¨€</h2> 
<p>æ¬¢è¿é˜…è¯»æœ¬ç³»åˆ—æ–‡ç« çš„ç¬¬äºŒç¯‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ¢è®¨ä¸ <code>shared_ptr</code> ç›¸å…³çš„ä¸»é¢˜ã€‚ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»äº† <code>shared_ptr</code> çš„å¼ºå¤§åŠŸèƒ½ï¼Œä½†ä¹Ÿæåˆ°äº†å®ƒå¯èƒ½é¢ä¸´çš„ä¸€ä¸ªé—®é¢˜ â€”â€” <strong>å¾ªç¯å¼•ç”¨</strong>ã€‚å½“ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡ä¹‹é—´ç›¸äº’æŒæœ‰ <code>shared_ptr</code> çš„å¼•ç”¨æ—¶ï¼Œå°±ä¼šå½¢æˆå¾ªç¯å¼•ç”¨ï¼Œå¯¼è‡´è¿™äº›å¯¹è±¡æ— æ³•è¢«æ­£ç¡®é‡Šæ”¾ï¼Œä»è€Œå¼•å‘å†…å­˜æ³„æ¼ã€‚</p> 
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥è®¨è®ºå¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œ<strong>å¹¶å¼•å…¥å¦ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆç±»â€”â€”<code>weak_ptr</code>ã€‚<code>weak_ptr</code> æ˜¯ <code>shared_ptr</code> çš„ä¼™ä¼´ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä»¥é¿å…å¯¹è±¡æ— æ³•é‡Šæ”¾çš„æƒ…å†µ</strong>ã€‚</p> 
<p>é€šè¿‡å­¦ä¹  <code>shared_ptr</code> å’Œ <code>weak_ptr</code> çš„ç»„åˆä½¿ç”¨ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†åŠ¨æ€åˆ†é…çš„å¯¹è±¡ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼Œå¹¶æé«˜ä»£ç çš„å¥å£®æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚æ•¬è¯·æœŸå¾…æœ¬æ–‡çš„å‰–æå’Œç¤ºä¾‹ï¼Œå¸Œæœ›èƒ½ç»™æ‚¨å¸¦æ¥æ›´æ·±å…¥çš„äº†è§£å’Œå®è·µç»éªŒã€‚</p> 
<h2><a id="stdshared_ptr_8"></a>ä¸€ã€std::shared_ptrçš„å¾ªç¯å¼•ç”¨</h2> 
<h3><a id="1__9"></a>1. æ¦‚å¿µ</h3> 
<p>å½“ä½¿ç”¨ <code>std::shared_ptr</code> æ—¶ï¼Œå¾ªç¯å¼•ç”¨æ˜¯ä¸€ç§å¸¸è§çš„é—®é¢˜ã€‚å¾ªç¯å¼•ç”¨æŒ‡çš„æ˜¯<strong>ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡å½¼æ­¤æŒæœ‰ <code>shared_ptr</code> çš„å¼•ç”¨ï¼Œå½¢æˆä¸€ä¸ªç¯çŠ¶ä¾èµ–å…³ç³»ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿æ²¡æœ‰å¤–éƒ¨å¼•ç”¨æŒ‡å‘è¿™äº›å¯¹è±¡ï¼Œå®ƒä»¬çš„å¼•ç”¨è®¡æ•°ä¹Ÿæ— æ³•é™ä¸ºé›¶ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼</strong>ã€‚</p> 
<p>å¾ªç¯å¼•ç”¨å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼çš„å‘ç”Ÿï¼Œå› ä¸ºæ¯ä¸ªå¯¹è±¡éƒ½ä¼šæŒæœ‰å¯¹å…¶ä»–å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯¼è‡´å®ƒä»¬çš„å¼•ç”¨è®¡æ•°æ— æ³•å½’é›¶ã€‚å½“æ²¡æœ‰å¤–éƒ¨å¼•ç”¨æŒ‡å‘è¿™äº›å¯¹è±¡æ—¶ï¼Œå®ƒä»¬çš„ææ„å‡½æ•°ä¸ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œå¯¼è‡´èµ„æºæ— æ³•æ­£ç¡®é‡Šæ”¾ã€‚</p> 
<h3><a id="2__14"></a>2. ç¤ºä¾‹åˆ†æ</h3> 
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼Œè¿™æ®µä»£ç å°±æ˜æ˜¾å­˜åœ¨ç€å¾ªç¯å¼•ç”¨ã€‚</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">ListNode</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> _data<span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _prev<span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _next<span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">ListNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~ListNode()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">node1</span><span class="token punctuation">(</span><span class="token keyword">new</span> ListNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">node2</span><span class="token punctuation">(</span><span class="token keyword">new</span> ListNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> node1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> node2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	node1<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> node2<span class="token punctuation">;</span>
	node2<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> node1<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> node1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> node2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>âœ…<strong>å¾ªç¯å¼•ç”¨åˆ†æ</strong>ï¼š</p> 
<ol><li><code>node1</code>å’Œ<code>node2</code>ä¸¤ä¸ªæ™ºèƒ½æŒ‡é’ˆå¯¹è±¡æŒ‡å‘ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå¼•ç”¨è®¡æ•°å˜æˆ1ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨<code>delete</code>ã€‚</li><li><code>node1</code>çš„<code>_next</code>æŒ‡å‘<code>node2</code>ï¼Œ<code>node2</code>çš„<code>_prev</code>æŒ‡å‘<code>node1</code>ï¼Œå¼•ç”¨è®¡æ•°å˜æˆ2ã€‚</li><li><code>node1</code>å’Œ<code>node2</code>ææ„ï¼Œå¼•ç”¨è®¡æ•°å‡åˆ°1ï¼Œä½†æ˜¯<code>_next</code>è¿˜æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ä½†æ˜¯<code>_prev</code>è¿˜æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹ã€‚</li><li><strong>ä¹Ÿå°±æ˜¯è¯´<code>_next</code>ææ„äº†ï¼Œ<code>node2</code>å°±é‡Šæ”¾äº†</strong>ã€‚</li><li><strong>ä¹Ÿå°±æ˜¯è¯´<code>_prev</code>ææ„äº†ï¼Œ<code>node1</code>å°±é‡Šæ”¾äº†</strong>ã€‚</li><li><strong>ä½†æ˜¯<code>_next</code>å±äº<code>node</code>çš„æˆå‘˜ï¼Œ<code>node1</code>é‡Šæ”¾äº†ï¼Œ<code>_next</code>æ‰ä¼šææ„ï¼Œè€Œ<code>node1</code>ç”±<code>_prev</code>ç®¡ç†ï¼Œ<code>_prev</code>å±äº<code>node2</code>æˆå‘˜ï¼Œæ‰€ä»¥è¿™å°±å«å¾ªç¯å¼•ç”¨ï¼Œè°ä¹Ÿä¸ä¼šé‡Šæ”¾</strong>ã€‚</li></ol> 
<p>â­•è®©æˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™ä¸ªå›¾ç‰‡æ¥è¯´ä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼š<br> <img src="https://images2.imgbox.com/5a/16/g6aa2CD3_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>ä¸ºäº†è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ <code>std::weak_ptr</code>ã€‚<code>std::weak_ptr</code> æ˜¯ä¸€ç§å¼±å¼•ç”¨ï¼Œå®ƒå¯ä»¥æŒ‡å‘ <code>std::shared_ptr</code> æŒæœ‰çš„å¯¹è±¡ï¼Œä½†ä¸ä¼šå¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚è¿™æ ·ï¼Œå³ä½¿å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Œé€šè¿‡ä½¿ç”¨ <code>std::weak_ptr</code> å¯ä»¥æ‰“ç ´å¾ªç¯å¼•ç”¨ï¼Œä½¿å¯¹è±¡çš„å¼•ç”¨è®¡æ•°èƒ½å¤Ÿæ­£ç¡®é™ä¸ºé›¶ï¼Œä»è€Œè§¦å‘ææ„å‡½æ•°çš„è°ƒç”¨ã€‚</p> 
<h2><a id="stdweak_ptr_49"></a>äºŒã€std::weak_ptr</h2> 
<h3><a id="1__50"></a>1. ç®€ä»‹</h3> 
<p><code>std::weak_ptr</code> æ˜¯ C++11 æ ‡å‡†åº“ä¸­æä¾›çš„ä¸€ç§å¼±å¼•ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒå¯ä»¥æŒ‡å‘ <code>std::shared_ptr</code> æ‰€ç®¡ç†çš„å¯¹è±¡ï¼Œ<strong>ä½†ä¸ä¼šå¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°</strong>ã€‚å› æ­¤ï¼Œå½“ä½¿ç”¨ <code>std::weak_ptr</code> æ—¶ï¼Œ<strong>å¦‚æœ <code>std::shared_ptr</code> å¯¹è±¡è¢«é‡Šæ”¾æˆ–è€…è¿‡æœŸï¼Œ<code>std::weak_ptr</code> å°†è‡ªåŠ¨å¤±æ•ˆï¼Œé¿å…äº†å¾ªç¯å¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„æ¼é—®é¢˜</strong>ã€‚</p> 
<p>ğŸ”´<a href="https://cplusplus.com/reference/memory/weak_ptr/" rel="nofollow">std::weak_ptrå®˜æ–¹æ–‡æ¡£</a></p> 
<p><img src="https://images2.imgbox.com/75/49/Ji8tPSWv_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h3><a id="2_weak_ptr_57"></a>2. weak_ptræ¨¡æ¿ç±»æä¾›çš„æˆå‘˜æ–¹æ³•</h3> 
<p>å’Œ <code>shared_ptr&lt;T&gt;</code>ã€<code>unique_ptr&lt;T&gt;</code> ç›¸æ¯”ï¼Œ<code>weak_ptr&lt;T&gt;</code> æ¨¡æ¿ç±»æä¾›çš„æˆå‘˜æ–¹æ³•ä¸å¤šï¼Œä¸‹è¡¨ç½—åˆ—äº†å¸¸ç”¨çš„æˆå‘˜æ–¹æ³•åŠå„è‡ªçš„åŠŸèƒ½ã€‚</p> 
<table><thead><tr><th>æˆå‘˜æ–¹æ³•</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td><strong>operator=</strong></td><td>é‡è½½ <code>=</code> èµ‹å€¼è¿ç®—ç¬¦ï¼Œä½¿å¾— <code>std::weak_ptr</code> æŒ‡é’ˆå¯ä»¥ç›´æ¥è¢« <code>std::weak_ptr</code> æˆ–è€… <code>std::shared_ptr</code> ç±»å‹æŒ‡é’ˆèµ‹å€¼ã€‚</td></tr><tr><td><strong>swap(x)</strong></td><td>å…¶ä¸­ <code>x</code> è¡¨ç¤ºä¸€ä¸ªåŒç±»å‹çš„ <code>std::weak_ptr</code> ç±»å‹æŒ‡é’ˆï¼Œè¯¥å‡½æ•°å¯ä»¥äº’æ¢ä¸¤ä¸ªåŒç±»å‹ <code>std::weak_ptr</code> æŒ‡é’ˆçš„å†…å®¹ã€‚</td></tr><tr><td><strong>reset()</strong></td><td>å°†å½“å‰ <code>std::weak_ptr</code> æŒ‡é’ˆç½®ä¸ºç©ºæŒ‡é’ˆã€‚</td></tr><tr><td><strong>use_count()</strong></td><td>æŸ¥çœ‹æŒ‡å‘å’Œå½“å‰ <code>std::weak_ptr</code> æŒ‡é’ˆç›¸åŒçš„ <code>std::shared_ptr</code> æŒ‡é’ˆçš„æ•°é‡ã€‚</td></tr><tr><td><strong>expired()</strong></td><td>åˆ¤æ–­å½“å‰ <code>std::weak_ptr</code> æŒ‡é’ˆæ˜¯å¦è¿‡æœŸï¼ˆæŒ‡é’ˆä¸ºç©ºï¼Œæˆ–è€…æŒ‡å‘çš„å †å†…å­˜å·²ç»è¢«é‡Šæ”¾ï¼‰ã€‚</td></tr><tr><td><strong>lock()</strong></td><td>å¦‚æœå½“å‰ <code>std::weak_ptr</code> å·²ç»è¿‡æœŸï¼Œåˆ™è¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªç©ºçš„ <code>std::shared_ptr</code> æŒ‡é’ˆï¼›åä¹‹ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªå’Œå½“å‰ <code>std::weak_ptr</code> æŒ‡å‘ç›¸åŒçš„ <code>std::shared_ptr</code> æŒ‡é’ˆã€‚</td></tr></tbody></table> 
<p>ğŸš¨ğŸš¨<strong>æ³¨æ„ï¼š<code>weak_ptr&lt;T&gt;</code> æ¨¡æ¿ç±»æ²¡æœ‰é‡è½½ <code>*</code> å’Œ <code>-&gt;</code> è¿ç®—ç¬¦ï¼Œå› æ­¤ <code>weak_ptr</code> ç±»å‹æŒ‡é’ˆåªèƒ½è®¿é—®æŸä¸€ <code>shared_ptr</code> æŒ‡é’ˆæŒ‡å‘çš„å †å†…å­˜ç©ºé—´ï¼Œæ— æ³•å¯¹å…¶è¿›è¡Œä¿®æ”¹</strong>ã€‚</p> 
<h3><a id="3__69"></a>3. ä½¿ç”¨ç¤ºä¾‹</h3> 
<h4><a id="1weak_ptr_70"></a>ï¼ˆ1ï¼‰weak_ptræŒ‡é’ˆçš„åˆ›å»º</h4> 
<p>åˆ›å»º <code>std::weak_ptr</code> æŒ‡é’ˆçš„æ–¹å¼å’Œåˆ›å»º <code>std::shared_ptr</code> çš„æ–¹å¼ç±»ä¼¼ã€‚ä¸‹é¢åˆ—ä¸¾äº†ä¸‰ç§å¸¸è§çš„åˆ›å»º <code>std::weak_ptr</code> çš„æ–¹å¼ï¼š</p> 
<ol><li>ä» <code>std::shared_ptr</code> åˆ›å»º</li></ol> 
<p>å¯ä»¥é€šè¿‡å°† <code>std::shared_ptr</code> èµ‹å€¼ç»™ <code>std::weak_ptr</code> æ¥åˆ›å»ºä¸€ä¸ªå¼±å¼•ç”¨æŒ‡é’ˆï¼Œä¾‹å¦‚ï¼š</p> 
<pre><code class="prism language-cpp">std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> sptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token operator">::</span>weak_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">wptr</span><span class="token punctuation">(</span>sptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª <code>std::shared_ptr</code> å¯¹è±¡ <code>sptr</code>ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªåŠ¨æ€åˆ†é…çš„ <code>int</code> ç±»å‹å¯¹è±¡ã€‚ç„¶åï¼Œæˆ‘ä»¬å°† <code>sptr</code> èµ‹å€¼ç»™ <code>std::weak_ptr</code> å¯¹è±¡ <code>wptr</code>ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¼±å¼•ç”¨æŒ‡é’ˆã€‚</p> 
<ol start="2"><li>ä» <code>std::shared_ptr</code> è½¬æ¢</li></ol> 
<p>å¯ä»¥é€šè¿‡ <code>std::shared_ptr</code> çš„ <code>weak_ptr</code> æˆå‘˜å‡½æ•°ï¼Œå°† <code>std::shared_ptr</code> è½¬æ¢ä¸º <code>std::weak_ptr</code>ï¼Œä¾‹å¦‚ï¼š</p> 
<pre><code class="prism language-cpp">std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> sptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token operator">::</span>weak_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> wptr <span class="token operator">=</span> sptr<span class="token operator">-&gt;</span><span class="token function">weak_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª <code>std::shared_ptr</code> å¯¹è±¡ <code>sptr</code>ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªåŠ¨æ€åˆ†é…çš„ <code>int</code> ç±»å‹å¯¹è±¡ã€‚ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨ <code>sptr</code> çš„ <code>weak_ptr()</code> æˆå‘˜å‡½æ•°ï¼Œå°† <code>sptr</code> è½¬æ¢ä¸º <code>std::weak_ptr</code> å¯¹è±¡ <code>wptr</code>ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¼±å¼•ç”¨æŒ‡é’ˆã€‚</p> 
<ol start="3"><li>ä½¿ç”¨ <code>std::weak_ptr</code> çš„æ„é€ å‡½æ•°</li></ol> 
<p>å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>std::weak_ptr</code> çš„æ„é€ å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„å¼±å¼•ç”¨æŒ‡é’ˆï¼Œä¾‹å¦‚ï¼š</p> 
<pre><code class="prism language-cpp">std<span class="token operator">::</span>weak_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> wptr<span class="token punctuation">;</span>
</code></pre> 
<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„ <code>std::weak_ptr</code> å¯¹è±¡ <code>wptr</code>ï¼Œå®ƒä¸æŒæœ‰ä»»ä½•å¯¹è±¡çš„å¼•ç”¨ã€‚</p> 
<h4><a id="2_107"></a>ï¼ˆ2ï¼‰å®Œæ•´ç¤ºä¾‹ï¼ˆè§£å†³ä¸Šé¢å¾ªç¯å¼•ç”¨é—®é¢˜ï¼‰</h4> 
<p>ä½¿ç”¨ <code>std::weak_ptr</code> ä¿®æ”¹ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥å°† <code>_prev</code> å’Œ <code>_next</code> æˆå‘˜å˜é‡æ”¹ä¸º <code>std::weak_ptr&lt;ListNode&gt;</code> ç±»å‹ã€‚è¿™æ ·å¯ä»¥é¿å…å¾ªç¯å¼•ç”¨ï¼ŒåŒæ—¶ä»ç„¶å¯ä»¥è®¿é—®é“¾è¡¨ä¸­çš„å‰ä¸€ä¸ªèŠ‚ç‚¹å’Œåä¸€ä¸ªèŠ‚ç‚¹</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">ListNode</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> _data<span class="token punctuation">;</span>
	weak_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _prev<span class="token punctuation">;</span>
	weak_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _next<span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">ListNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~ListNode()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">node1</span><span class="token punctuation">(</span><span class="token keyword">new</span> ListNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">node2</span><span class="token punctuation">(</span><span class="token keyword">new</span> ListNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> node1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> node2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	node1<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> node2<span class="token punctuation">;</span>
	node2<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> node1<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> node1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> node2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

	<span class="token comment">// ä½¿ç”¨ weak_ptr.lock() è·å– shared_ptr å¯¹è±¡</span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> node1Next <span class="token operator">=</span> node1<span class="token operator">-&gt;</span>_next<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> node2Prev <span class="token operator">=</span> node2<span class="token operator">-&gt;</span>_prev<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>node1Next<span class="token punctuation">)</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"node1 next data: "</span> <span class="token operator">&lt;&lt;</span> node1Next<span class="token operator">-&gt;</span>_data <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"node1 next is nullptr"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>node2Prev<span class="token punctuation">)</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"node2 prev data: "</span> <span class="token operator">&lt;&lt;</span> node2Prev<span class="token operator">-&gt;</span>_data <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"node2 prev is nullptr"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>è¿è¡Œä¸Šè¿°ä»£ç ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p> 
<pre><code class="prism language-cpp"><span class="token number">1</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">2</span>
node1 next data<span class="token operator">:</span> <span class="token number">0</span>
node2 prev data<span class="token operator">:</span> <span class="token number">0</span>
</code></pre> 
<p>åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªèŠ‚ç‚¹ <code>node1</code> å’Œ <code>node2</code>ï¼Œå¹¶é€šè¿‡ <code>std::weak_ptr</code> è¿›è¡Œç›¸äº’å¼•ç”¨ã€‚</p> 
<pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">node1</span><span class="token punctuation">(</span><span class="token keyword">new</span> ListNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">node2</span><span class="token punctuation">(</span><span class="token keyword">new</span> ListNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¾ç½®èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ã€‚ä¿®æ”¹å‰çš„ä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-cpp">node1<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> node2<span class="token punctuation">;</span>
node2<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> node1<span class="token punctuation">;</span>
</code></pre> 
<p>æˆ‘ä»¬å°† <code>_next</code> å’Œ <code>_prev</code> æˆå‘˜å˜é‡çš„ç±»å‹ä» <code>shared_ptr&lt;ListNode&gt;</code> æ”¹ä¸º <code>weak_ptr&lt;ListNode&gt;</code>ï¼š</p> 
<pre><code class="prism language-cpp">weak_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _prev<span class="token punctuation">;</span>
weak_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _next<span class="token punctuation">;</span>
</code></pre> 
<p>è¿™æ ·å°±å»ºç«‹äº†èŠ‚ç‚¹ä¹‹é—´çš„å¼±å¼•ç”¨å…³ç³»ï¼Œé¿å…äº†å¾ªç¯å¼•ç”¨ã€‚</p> 
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>lock()</code> æ–¹æ³•å°† <code>std::weak_ptr</code> è½¬æ¢ä¸º <code>std::shared_ptr</code>ï¼Œä»¥è®¿é—®æ‰€ç®¡ç†çš„å¯¹è±¡ã€‚</p> 
<pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> node1Next <span class="token operator">=</span> node1<span class="token operator">-&gt;</span>_next<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> node2Prev <span class="token operator">=</span> node2<span class="token operator">-&gt;</span>_prev<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>å¦‚æœ <code>std::weak_ptr</code> ä¸è¿‡æœŸï¼ˆå³æ‰€ç®¡ç†çš„å¯¹è±¡è¿˜å­˜åœ¨ï¼‰ï¼Œ<code>lock()</code> æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„ <code>std::shared_ptr</code> å¯¹è±¡ï¼Œå¦åˆ™è¿”å›ç©ºæŒ‡é’ˆã€‚</p> 
<p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº› <code>std::shared_ptr</code> å¯¹è±¡æ¥è®¿é—®é“¾è¡¨ä¸­çš„å‰é©±å’Œåç»§èŠ‚ç‚¹çš„æ•°æ®ã€‚</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>node1Next<span class="token punctuation">)</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"node1 next data: "</span> <span class="token operator">&lt;&lt;</span> node1Next<span class="token operator">-&gt;</span>_data <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token keyword">else</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"node1 next is nullptr"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>node2Prev<span class="token punctuation">)</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"node2 prev data: "</span> <span class="token operator">&lt;&lt;</span> node2Prev<span class="token operator">-&gt;</span>_data <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token keyword">else</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"node2 prev is nullptr"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre> 
<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°è®¿é—®é“¾è¡¨ä¸­çš„å‰é©±å’Œåç»§èŠ‚ç‚¹ï¼Œè€Œä¸ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨å’Œå†…å­˜æ³„æ¼ã€‚</p> 
<h3><a id="4_C_205"></a>4. C++æ¨¡æ‹Ÿå®ç°</h3> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">weak_ptr</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// é»˜è®¤æ„é€ å‡½æ•°ï¼Œå°†_ptræˆå‘˜æŒ‡é’ˆåˆå§‹åŒ–ä¸ºnullptr</span>
    <span class="token function">weak_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">// æ¥å—shared_ptrå‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå°†_ptræˆå‘˜æŒ‡é’ˆåˆå§‹åŒ–ä¸ºshared_ptræ‰€ç®¡ç†å¯¹è±¡çš„æŒ‡é’ˆ</span>
    <span class="token function">weak_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> sp<span class="token punctuation">)</span>
        <span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>sp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">// é‡è½½*è¿ç®—ç¬¦ï¼Œè¿”å›æ‰€ç®¡ç†å¯¹è±¡çš„å¼•ç”¨</span>
    T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">*</span>_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// é‡è½½-&gt;è¿ç®—ç¬¦ï¼Œè¿”å›æ‰€ç®¡ç†å¯¹è±¡çš„æŒ‡é’ˆ</span>
    T<span class="token operator">*</span> <span class="token keyword">operator</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿”å›æ‰€ç®¡ç†å¯¹è±¡çš„æŒ‡é’ˆ</span>
    T<span class="token operator">*</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    T<span class="token operator">*</span> _ptr<span class="token punctuation">;</span> <span class="token comment">// æ‰€ç®¡ç†å¯¹è±¡çš„æŒ‡é’ˆ</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ <code>weak_ptr</code> ç±»çš„å®ç°ï¼Œæä¾›äº†ä¸€äº›åŸºæœ¬çš„åŠŸèƒ½ã€‚</p> 
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>weak_ptr</code> ç±»æœ‰ä¸€ä¸ªé»˜è®¤æ„é€ å‡½æ•°å’Œä¸€ä¸ªæ¥å— <code>shared_ptr</code> å‚æ•°çš„æ„é€ å‡½æ•°ã€‚é»˜è®¤æ„é€ å‡½æ•°å°† <code>_ptr</code> æˆå‘˜æŒ‡é’ˆåˆå§‹åŒ–ä¸º <code>nullptr</code>ï¼Œè€Œæ¥å— <code>shared_ptr</code> å‚æ•°çš„æ„é€ å‡½æ•°å°† <code>_ptr</code> æˆå‘˜æŒ‡é’ˆåˆå§‹åŒ–ä¸º <code>shared_ptr</code> æ‰€ç®¡ç†å¯¹è±¡çš„æŒ‡é’ˆã€‚</p> 
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>weak_ptr</code> é‡è½½äº† <code>*</code> å’Œ <code>-&gt;</code> è¿ç®—ç¬¦ï¼Œä½¿å¾—å¯ä»¥åƒä½¿ç”¨æŒ‡é’ˆä¸€æ ·ï¼Œé€šè¿‡ <code>weak_ptr</code> å¯¹è±¡è®¿é—®æ‰€ç®¡ç†çš„å¯¹è±¡ã€‚<code>operator*()</code> è¿”å›æ‰€ç®¡ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œ<code>operator-&gt;()</code> è¿”å›æ‰€ç®¡ç†å¯¹è±¡çš„æŒ‡é’ˆã€‚</p> 
<p>åŒæ—¶ï¼Œ<code>weak_ptr</code> è¿˜æä¾›äº†ä¸€ä¸ª <code>get()</code> æ–¹æ³•ï¼Œè¿”å› <code>_ptr</code> æŒ‡é’ˆï¼Œå³æ‰€ç®¡ç†å¯¹è±¡çš„æŒ‡é’ˆã€‚è¿™å…è®¸ç”¨æˆ·ç›´æ¥è®¿é—® <code>_ptr</code> æŒ‡é’ˆï¼Œä½†éœ€è¦æ³¨æ„ï¼Œè¿™ç§ç›´æ¥è®¿é—®å¯èƒ½ä¼šå¯¼è‡´æ‚¬ç©ºæŒ‡é’ˆé—®é¢˜ï¼Œå› ä¸º <code>_ptr</code> æŒ‡é’ˆå¯èƒ½å·²ç»æ— æ•ˆï¼ˆæ‰€ç®¡ç†å¯¹è±¡å·²è¢«é‡Šæ”¾ï¼‰ã€‚</p> 
<p>ğŸš¨ğŸš¨<strong>æ³¨æ„ï¼šè¿™ä¸ªç®€åŒ–ç‰ˆçš„ <code>weak_ptr</code> å®ç°æ²¡æœ‰è€ƒè™‘çº¿ç¨‹å®‰å…¨æ€§ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ<code>weak_ptr</code> éœ€è¦ä¸å…¶ä»–æ™ºèƒ½æŒ‡é’ˆå…±åŒä½¿ç”¨ï¼Œæ¯”å¦‚ <code>shared_ptr</code>ã€<code>unique_ptr</code>ï¼Œå¹¶ä¸”éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨æ€§å’Œå¼‚å¸¸å®‰å…¨æ€§</strong>ã€‚</p> 
<h2><a id="_254"></a>æ¸©é¦¨æç¤º</h2> 
<p>æ„Ÿè°¢æ‚¨å¯¹åšä¸»æ–‡ç« çš„å…³æ³¨ä¸æ”¯æŒï¼å¦å¤–ï¼Œæˆ‘è®¡åˆ’åœ¨æœªæ¥çš„æ›´æ–°ä¸­æŒç»­æ¢è®¨ä¸æœ¬æ–‡ç›¸å…³çš„å†…å®¹ï¼Œä¼šä¸ºæ‚¨å¸¦æ¥æ›´å¤šå…³äºC++ä»¥åŠç¼–ç¨‹æŠ€æœ¯é—®é¢˜çš„æ·±å…¥è§£æã€åº”ç”¨æ¡ˆä¾‹å’Œè¶£å‘³ç©æ³•ç­‰ã€‚è¯·ç»§ç»­å…³æ³¨åšä¸»çš„æ›´æ–°ï¼Œä¸è¦é”™è¿‡ä»»ä½•ç²¾å½©å†…å®¹ï¼</p> 
<p>å†æ¬¡æ„Ÿè°¢æ‚¨çš„æ”¯æŒå’Œå…³æ³¨ã€‚æœŸå¾…ä¸æ‚¨å»ºç«‹æ›´ç´§å¯†çš„äº’åŠ¨ï¼Œå…±åŒæ¢ç´¢C++ã€ç®—æ³•å’Œç¼–ç¨‹çš„å¥¥ç§˜ã€‚ç¥æ‚¨ç”Ÿæ´»æ„‰å¿«ï¼Œæ’ä¾¿é¡ºç•…ï¼<br> <img src="https://images2.imgbox.com/cd/95/jfivH8Wh_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/49e69b8574dae735f93d4d560cdd3649/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">RabbitMQè¯¦è§£ä¸å®æˆ˜(ç»å¯¹è¶³å¤ŸæƒŠå–œ)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e1052d3d0abb4dbc1c9fff77622f7f87/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">å¾®ä¿¡æ”¯ä»˜å¯¹æ¥ï¼švueå‰ç«¯è°ƒèµ·æ”¯ä»˜æ—¶ï¼Œæç¤ºerror â€˜WeixinJSBridgeâ€˜ is not definedï¼Œå·²è§£å†³</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å­¦ä¹ è€….
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>