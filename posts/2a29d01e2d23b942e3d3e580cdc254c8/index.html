<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>纯python实现小程序云函数抓包（附完整代码） - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/2a29d01e2d23b942e3d3e580cdc254c8/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="纯python实现小程序云函数抓包（附完整代码）">
  <meta property="og:description" content="纯python实现小程序云函数抓包 原理参数call返回结果call使用frida进行hook结果 原理 其实小程序授权和云函数执行是一回事，和小程序取code也是一回事，调用的call也是同一个，只不过参数不同，而且实际上执行的call和hook结果的call是不一样的，在这里我们使用frida来hook云函数执行的参数和结果。
目前其他功能以开发完成，并编译为DLL，具体文档可以看：个非寻的 wechathook 文档
以上仅供学习交流使用。 参数call 首先确定参数的call，逆向找call的过程就不说了，想要知道怎么找call的私聊就好，这里我们HOOK这个wechatwin.3B4E370，此时可以看到ecx的值就是json格式的参数，但实际上我们从这三个连续的call可以猜到，他可能有3个参数，然后我们在堆栈窗口上也能看到，除了json格式的参数以外，还有两个参数（另外一个是重复的），所以这里我们确切的说应该是要hook三个参数出来，实际的测试中还涉及一个task_id的数据，这个数据不为0的，才是真正的参数。这段json数据的偏移是0。
返回结果call 云函数的返回结果我这里hook的是wmpf_host_export.dll这个模块，可以看到，在这里下断之后，在与esi接近的地址中有一段是返回的云函数结果，偏移的0x24
使用frida进行hook from __future__ import print_function import json import frida import sys def on_message(message, data): conte = json.loads(message[&#39;payload&#39;]) if conte[&#39;task_id&#39;] != 0: print(&#39;返回结果:&#39;,message[&#39;payload&#39;]) def on_parameter(message, data): conte = json.loads(message[&#39;payload&#39;]) if conte.get(&#39;task_id&#39;,None) != 0: print(&#39;参数:&#39;, message[&#39;payload&#39;]) def main(target_process): session = frida.attach(target_process) scriptresult = session.create_script(&#34;&#34;&#34; var ModAddress=Process.findModuleByName(&#39;wmpf_host_export.dll&#39;); //console.log(&#39;ModAdress:&#39; &#43; ModAddress.base); var hookAddress=ModAddress.base.add(&#39;0xA5320&#39;) Interceptor.attach(hookAddress,{ onEnter:function(args) { //console.log(JSON.stringify(this.context)); var esi=this.context.esi; //var esi1=Memory.readPointer(esi&#43;0x24) var result=Memory.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-28T08:20:03+08:00">
    <meta property="article:modified_time" content="2024-03-28T08:20:03+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">纯python实现小程序云函数抓包（附完整代码）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>纯python实现小程序云函数抓包</h4> 
 <ul><li><a href="#_1" rel="nofollow">原理</a></li><li><a href="#call_5" rel="nofollow">参数call</a></li><li><a href="#call_8" rel="nofollow">返回结果call</a></li><li><a href="#fridahook_11" rel="nofollow">使用frida进行hook</a></li><li><a href="#_71" rel="nofollow">结果</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>原理</h2> 
<p>其实小程序授权和云函数执行是一回事，和小程序取code也是一回事，调用的call也是同一个，只不过参数不同，而且实际上执行的call和hook结果的call是不一样的，在这里我们使用frida来hook云函数执行的参数和结果。</p> 
<ul><li>目前其他功能以开发完成，并编译为DLL，具体文档可以看：<a href="https://console-docs.apipost.cn/preview/ddf2d570ad9769aa/2f4d79a1a4b95969" rel="nofollow">个非寻的 wechathook 文档</a><br> 以上仅供学习交流使用。</li></ul> 
<h2><a id="call_5"></a>参数call</h2> 
<p><img src="https://images2.imgbox.com/75/c7/L5Ui7Kx8_o.png" alt="在这里插入图片描述"><br> 首先确定参数的call，逆向找call的过程就不说了，想要知道怎么找call的私聊就好，这里我们HOOK这个wechatwin.3B4E370，此时可以看到ecx的值就是json格式的参数，但实际上我们从这三个连续的call可以猜到，他可能有3个参数，然后我们在堆栈窗口上也能看到，除了json格式的参数以外，还有两个参数（另外一个是重复的），所以这里我们确切的说应该是要hook三个参数出来，实际的测试中还涉及一个task_id的数据，这个数据不为0的，才是真正的参数。这段json数据的偏移是0。</p> 
<h2><a id="call_8"></a>返回结果call</h2> 
<p><img src="https://images2.imgbox.com/c3/19/J8TJGfWI_o.png" alt="在这里插入图片描述"><br> 云函数的返回结果我这里hook的是wmpf_host_export.dll这个模块，可以看到，在这里下断之后，在与esi接近的地址中有一段是返回的云函数结果，偏移的0x24</p> 
<h2><a id="fridahook_11"></a>使用frida进行hook</h2> 
<pre><code class="prism language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function
<span class="token keyword">import</span> json
<span class="token keyword">import</span> frida
<span class="token keyword">import</span> sys

<span class="token keyword">def</span> <span class="token function">on_message</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conte <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">[</span><span class="token string">'payload'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> conte<span class="token punctuation">[</span><span class="token string">'task_id'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'返回结果:'</span><span class="token punctuation">,</span>message<span class="token punctuation">[</span><span class="token string">'payload'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">on_parameter</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conte <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">[</span><span class="token string">'payload'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> conte<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'task_id'</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'参数:'</span><span class="token punctuation">,</span> message<span class="token punctuation">[</span><span class="token string">'payload'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>target_process<span class="token punctuation">)</span><span class="token punctuation">:</span>
    session <span class="token operator">=</span> frida<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>target_process<span class="token punctuation">)</span>
    scriptresult <span class="token operator">=</span> session<span class="token punctuation">.</span>create_script<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
    var ModAddress=Process.findModuleByName('wmpf_host_export.dll');
    //console.log('ModAdress:' + ModAddress.base);
    var hookAddress=ModAddress.base.add('0xA5320')
    Interceptor.attach(hookAddress,{
        onEnter:function(args) {
            //console.log(JSON.stringify(this.context));
            var esi=this.context.esi;
            //var esi1=Memory.readPointer(esi+0x24)
            var result=Memory.readUtf8String(Memory.readPointer(esi.add('0x24')));
            send(result)
        }
    })
"""</span><span class="token punctuation">)</span>

    scriptparameter <span class="token operator">=</span> session<span class="token punctuation">.</span>create_script<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
        var ModAddress=Process.findModuleByName('WeChatWin.dll');
        //console.log('ModAdress:' + ModAddress.base);
        var hookAddress=ModAddress.base.add('0x54A560')
        Interceptor.attach(hookAddress,{
            onEnter:function(args) {
                //console.log(JSON.stringify(this.context));
                var ecx=this.context.ecx;
                //var datapoin=Memory.readPointer(ecx)
                var result=Memory.readUtf8String(Memory.readPointer(ecx));
                send(result)
            }
        })
    """</span><span class="token punctuation">)</span>
    scriptresult<span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> on_message<span class="token punctuation">)</span>
    scriptresult<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    scriptparameter<span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> on_parameter<span class="token punctuation">)</span>
    scriptparameter<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[!] Ctrl+D on UNIX, Ctrl+Z on Windows/cmd.exe to detach from instrumented program.\n\n"</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token string">'wechat.exe'</span><span class="token punctuation">)</span>
</code></pre> 
<p>代码中实际的偏移因版本不同而不同，大家只要把对应版本的偏移计算出来就可以直接运行代码。</p> 
<h2><a id="_71"></a>结果</h2> 
<p><img src="https://images2.imgbox.com/9d/ff/FJI4HUq1_o.png" alt="在这里插入图片描述"><br> 这里之所以参数和返回结果数量不同，是因为有些参数并不会有产生返回结果，即当task_id等于0的参数，一般不会有返回结果。如果想要获取code和sessionid等的参数可以看我的上一篇文章</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f95730ef2038419d27ae023574a791eb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL 8.0 新特性之不可见主键</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4069b7ab0a179852d47954fea219de3b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【JS球球大作战项目实战】&#43;在线体验</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>