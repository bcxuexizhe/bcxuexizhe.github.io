<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>前端实现调用打印机和小票打印(TSPL )功能 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/92e9ad92f48e275d8ed98ea90229c268/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="前端实现调用打印机和小票打印(TSPL )功能">
  <meta property="og:description" content="Ⅰ- 壹 - 使用需求 前端 的方式 点击这个按钮，直接让打印机打印我想要的东西
github地址: https://github.com/whqgo/nodeWebPrint
Ⅱ - 贰 - 小票打印 目前比较好的方式就是直接用 TSPL 标签打印指令集, 基础环境就不多说了,这个功能的实现就是利用usb发送指令,现在缺少个来让我们能够和usb沟通的工具,下面这就是推荐的一个程序驱动,安装通用USB驱动程序.
注: TSPL是一套通用的标签打印指令集，很多主流标签打印机都支持。市面上标签打印机的通讯方式主要有：串口、USB、蓝牙和WIFI，通过上述方式发送相应的TSPL指令，标签打印机就可以依照指令进行打印。 usb 插件需要的 程序驱动（Zadig） https://zadig.akeo.ie/
下载完成后打开，依次操作
勾选这些
选择连接的usb 打印机usb, 一般是 打印机商品名字,我这使用的是佳博打印机
3.安装驱动
编写代码 目录结构
main入口文件
webPrintUtils文件夹 具体的实现
index : 功能实现的逻辑bitmap_nodejs : image转bitmap所用tspl.class : TSPL 指令二次封装一下usb.class: 用于连接 usb数据写入操作 列如我们想画一个条形码
在tspl.class.js文件中添加一个barcode方法, 具体的指令很容易在网上查到
/** * 条码,这里固定为code128 * 单位都为dot * * @param {Number} [x=0] - x * @param {Number} [y=0] - y * @param {Number} [height=80] - height * @param {String} [content=&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-30T10:13:59+08:00">
    <meta property="article:modified_time" content="2023-11-30T10:13:59+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">前端实现调用打印机和小票打印(TSPL )功能</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="____0"></a>Ⅰ- 壹 - 使用需求</h2> 
<p>前端 的方式 点击这个按钮，直接让打印机打印我想要的东西</p> 
<p><strong>github地址: https://github.com/whqgo/nodeWebPrint</strong></p> 
<h2><a id="_____4"></a>Ⅱ - 贰 - 小票打印</h2> 
<p>目前比较好的方式就是直接用 TSPL 标签打印指令集, 基础环境就不多说了,这个功能的实现就是利用usb发送指令,现在缺少个来让我们能够和usb沟通的工具,下面这就是推荐的一个程序驱动,安装通用USB驱动程序.</p> 
<ul><li>注: TSPL是一套通用的标签打印指令集，很多主流标签打印机都支持。市面上标签打印机的通讯方式主要有：串口、USB、蓝牙和WIFI，通过上述方式发送相应的TSPL指令，标签打印机就可以依照指令进行打印。</li></ul> 
<h4><a id="usb__Zadig_12"></a>usb 插件需要的 程序驱动（Zadig）</h4> 
<p>https://zadig.akeo.ie/</p> 
<p>下载完成后打开，依次操作</p> 
<ol><li>勾选这些<br> <img src="https://images2.imgbox.com/66/a2/2sasocMM_o.png" alt="在这里插入图片描述"></li><li>选择连接的usb 打印机usb, 一般是 打印机商品名字,我这使用的是佳博打印机<br> <img src="https://images2.imgbox.com/9f/d7/lMMxVTf7_o.png" alt="在这里插入图片描述"></li></ol> 
<p>3.安装驱动<img src="https://images2.imgbox.com/1a/44/NQPh8hwe_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_26"></a>编写代码</h4> 
<p>目录结构</p> 
<p><img src="https://images2.imgbox.com/db/1c/9bDBzldV_o.png" alt="在这里插入图片描述"></p> 
<p>main入口文件</p> 
<p>webPrintUtils文件夹 具体的实现</p> 
<ul><li>index : 功能实现的逻辑</li><li>bitmap_nodejs : image转bitmap所用</li><li>tspl.class : TSPL 指令二次封装一下</li><li>usb.class: 用于连接 usb数据写入操作</li></ul> 
<p>列如我们想画一个条形码</p> 
<p>在tspl.class.js文件中添加一个barcode方法, 具体的指令很容易在网上查到</p> 
<pre><code>/**
 * 条码,这里固定为code128
 * 单位都为dot
 * 
 * @param {Number} [x=0] - x
 * @param {Number} [y=0] - y
 * @param {Number} [height=80] - height
 * @param {String} [content=""] - 条码内容，请遵循code128的约定，不是啥字符都可以往里边放的
 * @param {Boolean} [label=true] - 是否显示条码的label部分
 * @param {Number} [elementWidth=2] - 条码每位宽度
 * @param {Number} [rotate=0] - 旋转角度，支持0,90,180,270
 * @returns {Tspl}
 * @public
 */
barcode ( 
    x = 0, 
    y = 0,
    height = 80,
    content = "",
    label = true,
    elementWidth = 2,
    rotate = 0
) {
    return this.#append(`BARCODE ${x},${y},"128",${height},${+label},${rotate},${elementWidth},${elementWidth*2},"${content}"`);
}
</code></pre> 
<p>使用只需要在实例化后传参就行了</p> 
<pre><code>const Printer = require('./printer.class')
const Usb = require('./usb.class')
const Tspl = require('./tspl.class')
const { encode } = require('GBKCodec')

// 实例化 一个 80mm, 40mm的画布
const print = new Printer({
    connection: new Usb,
    language: new Tspl({
        size: "80mm, 40mm",
        gap: "2mm, 0mm",
        encoder: encode
    })
});
print.barcode(30, 20, '120', data.c, false, 3)
</code></pre> 
<p>现在这个tspl.class.js中 基本的常用的都添加完了,二维码,条形码,文本.图片,下划线,绘制盒子,绘制色块</p> 
<p>搭配之后就可以打印出来</p> 
<pre><code class="prism language-javascript"><span class="token keyword">await</span> print<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'前端精湛掌握'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'TSS24.BF2'</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> print<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">560</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> print<span class="token punctuation">.</span><span class="token function">qrcode</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token string">"http://weixin.qq.com/r/zRHk-BjEZUUarVyf90Tf"</span><span class="token punctuation">)</span> <span class="token comment">// 二维码</span>
<span class="token keyword">await</span> print<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4b/0e/5xfK6V7P_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="_____106"></a>Ⅲ - 叁 - 普通打印</h3> 
<p>可能想到 的是 , 直接用浏览器打印,通过 `window.print()调用,但是会弹出来操作页面,不行 领导说这样不行不美观不通透 否决.这个需求的重点不是打印的内容,不管是内容添加到iframe里还是将打印内容转为图片 而是想直接打印.无痛的那种,思来想去,也就只有python能这样做了,python写好脚本编译成exe然后用node调用,没办法只好这样曲线救国了.</p> 
<p>这里用到了 python模块 win32com.client 它提供调用 windows 底层组件对 word 、Excel、PPT 等进行操作的功能，只能在 Windows 环境下使用，并且需要安装 office 相关软件才行（WPS也行）</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> win32com<span class="token punctuation">.</span>client


# 打印
def <span class="token function">openRrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    lg <span class="token operator">=</span> <span class="token string">'打印的xlsx文件路径'</span>
    <span class="token keyword">try</span><span class="token operator">:</span>
        xlApp <span class="token operator">=</span> win32com<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Dispatch</span><span class="token punctuation">(</span><span class="token string">"Excel.Application"</span><span class="token punctuation">)</span>
        # UpdateLinks
        # CorruptLoad<span class="token operator">=</span><span class="token number">2</span> 尝试修复损坏的文件
        # xlBook <span class="token operator">=</span> xlApp<span class="token punctuation">.</span>Workbooks<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>lg<span class="token punctuation">,</span> UpdateLinks<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> CorruptLoad<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  # 打印的文件
        xlBook <span class="token operator">=</span> xlApp<span class="token punctuation">.</span>Workbooks<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>lg<span class="token punctuation">,</span> UpdateLinks<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  # 打印的文件
        xlApp<span class="token punctuation">.</span>Visible <span class="token operator">=</span> <span class="token number">0</span>  # 不在后台运行
        xlApp<span class="token punctuation">.</span>DisplayAlerts <span class="token operator">=</span> False  # 显示弹窗
        xlApp<span class="token punctuation">.</span>ActiveWorkbook<span class="token punctuation">.</span><span class="token function">Sheets</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>PageSetup<span class="token punctuation">.</span>Orientation <span class="token operator">=</span> win32com<span class="token punctuation">.</span>client<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>xlLandscape # 设置为横向打印
        xlApp<span class="token punctuation">.</span>ActiveWorkbook<span class="token punctuation">.</span><span class="token function">Sheets</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>PageSetup<span class="token punctuation">.</span>Zoom <span class="token operator">=</span> False
        xlApp<span class="token punctuation">.</span>ActiveWorkbook<span class="token punctuation">.</span><span class="token function">Sheets</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>PageSetup<span class="token punctuation">.</span>FitToPagesWide <span class="token operator">=</span> <span class="token number">1</span>  # 页数范围
        xlApp<span class="token punctuation">.</span>ActiveWorkbook<span class="token punctuation">.</span><span class="token function">Sheets</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>PageSetup<span class="token punctuation">.</span>FitToPagesTall <span class="token operator">=</span> <span class="token number">10</span>
        # xlBook<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> #保存
        ename <span class="token operator">=</span> xlApp<span class="token punctuation">.</span>ActiveWorkbook<span class="token punctuation">.</span>Name  # 获取打开工作表名称
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"正在打印&gt;"</span><span class="token punctuation">,</span> ename<span class="token punctuation">)</span>
        xlBook<span class="token punctuation">.</span><span class="token function">PrintOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>xlApp<span class="token punctuation">,</span> <span class="token string">"名称==="</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>xlBook<span class="token punctuation">,</span> <span class="token string">"打印的文件==="</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>lg<span class="token punctuation">,</span> <span class="token string">"lg==="</span><span class="token punctuation">)</span>
        # xlBook<span class="token punctuation">.</span><span class="token function">PrintOut</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> # 打印页数<span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>
        xlApp<span class="token punctuation">.</span><span class="token function">Quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  # 退出
    except Exception <span class="token keyword">as</span> <span class="token literal-property property">e</span><span class="token operator">:</span>
        <span class="token function">print</span><span class="token punctuation">(</span>f<span class="token string">"打印 Excel 文件时发生错误: {str(e)}"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token operator">:</span>
    # 调用打印机
    <span class="token function">openRrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pass

</code></pre> 
<p>然后打包成exe文件,</p> 
<pre><code class="prism language-javascript">Pyinstaller <span class="token operator">-</span><span class="token constant">F</span> init<span class="token punctuation">.</span>py 打包exe
</code></pre> 
<p>node就可以用child_process模块执行一个文件了</p> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> execFile <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token function">execFile</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
</code></pre> 
<p>就这点代码就实现了 我想要的需求 python 还挺强嘞,不过也有点问题 就这点代码 打包exe竟然高达40MB,相当离谱了也是,留着这个问题把,后续有其他的方式了 在解决, 这可是以后的优化点,算工作量的.</p> 
<p>最后这一步 我寻思 用wasm去做会更好(node直接调用wasm),但是 用c没实现出来这功能,python3不只是转成wasm,有没 大佬帮忙完善这最后一步啊 真的很需要</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/418cadd4d72884c93d734c69f7753e1b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SQL中 JOIN 的两种连接类型：内连接（自然连接、自连接、交叉连接）、外连接（左外连接、右外连接、全外连接）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/191f495d178c28404267f673ea73751a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用 JavaScript 和 TronWeb 库来实现监控TRC20余额</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>