<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>spring boot3登录开发-微信小程序用户登录设计与实现 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/abacef97399d67a1ca1a0be2629342bb/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="spring boot3登录开发-微信小程序用户登录设计与实现">
  <meta property="og:description" content="⛰️个人主页: 蒾酒
🔥系列专栏：《spring boot实战》
目录
写在前面
登录流程
流程解析
具体实现
相关代码
说明
服务端
小程序端
写在最后
写在前面 本文介绍了springboot开发微信小程序后端服务中，用户登录功能的设计与实现，坚持看完相信对你有帮助。
同时欢迎订阅springboot系列专栏，持续分享spring boot的使用经验。
登录流程 如图：
这是微信官方文档中微信小程序登录的流程时序图，我在图中红色序号标注的五步就是完整的微信小程序登录流程。
流程解析 小程序端通过wx.login()获取用户登录凭证code。小程序将code发送到服务端的登录接口。服务端的登录接口使用该code、小程序的AppID和AppSecret向微信服务器发起请求，获取用户的openid。服务端拿到openid后，可以根据业务需求生成用户令牌（Token），通常包括用户信息、权限等，并返回给小程序。小程序在本地缓存该用户令牌。后续小程序发起请求时，在请求头中携带该用户令牌(Token)。服务端接收到请求时，验证用户令牌的有效性，确保用户是经过认证和授权的。 具体实现 登录接口设计思路
接收小程序端传递的code参数。使用code、小程序的AppID和AppSecret向微信服务器发起请求，获取用户的openid。在数据库用户表中查询是否存在该openid。如果存在该openid，则使用查询到的用户信息生成令牌(Token)。如果不存在该openid，则进行用户注册操作，将新用户信息插入数据库用户表，并生成令牌(Token)。返回生成的令牌(Token)给小程序端。 相关代码 说明 下面代码基于jdk17，发请求用的时jdk自带的http工具类，如果你的jdk版本低于11，可以使用okhttp依赖来发请求，然后jwt相关工具类代码在我本专栏的其他文章里面，用到的ORM框架为mybatis-plus整合相关代码也在本专栏。
服务端 登录dto
@Data public class UserLoginDTO { @NotBlank(message = &#34;code不能为空&#34;) private String code; private Map&lt;String,Object&gt; userInfo;//用户完善信息 } 登录返回vo
@Data @Builder public class UserLoginVO implements Serializable { private Long id; //用户id private String openid;//用户在小程序唯一标识 private String token;//用户登录凭证 } 获取openid方法
使用的是jdk17自带的HttpClient,也可以使用okhttp,或者糊涂工具包里面的。
private String getOpenid(String code) { HttpClient httpClient = HttpClient.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-27T16:41:45+08:00">
    <meta property="article:modified_time" content="2024-04-27T16:41:45+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">spring boot3登录开发-微信小程序用户登录设计与实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p> <img alt="" height="68" src="https://images2.imgbox.com/37/3f/zGC294p1_o.jpg" width="68"></p> 
<p><span style="color:#a2e043;">⛰️<a href="https://so.csdn.net/so/search?q=%E4%B8%AA%E4%BA%BA%E4%B8%BB%E9%A1%B5&amp;spm=1001.2101.3001.7020" title="个人主页">个人主页</a>:     <a href="https://blog.csdn.net/qq_62262918?spm=1011.2266.3001.5343" title="蒾酒">蒾酒</a></span></p> 
<p><span style="color:#ed7976;">🔥系列专栏：<a href="https://blog.csdn.net/qq_62262918/category_12571219.html?spm=1001.2014.3001.5482" title="《spring boot实战》">《spring boot实战》</a></span></p> 
<hr> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2-toc" style="margin-left:0px;"><a href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2" rel="nofollow">写在前面</a></p> 
<p id="%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B-toc" style="margin-left:0px;"><a href="#%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B" rel="nofollow">登录流程</a></p> 
<p id="%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-toc" style="margin-left:0px;"><a href="#%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90" rel="nofollow">流程解析</a></p> 
<p id="%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0-toc" style="margin-left:0px;"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0" rel="nofollow">具体实现</a></p> 
<p id="%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81-toc" style="margin-left:40px;"><a href="#%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81" rel="nofollow">相关代码</a></p> 
<p id="%E8%AF%B4%E6%98%8E-toc" style="margin-left:80px;"><a href="#%E8%AF%B4%E6%98%8E" rel="nofollow">说明</a></p> 
<p id="%E6%9C%8D%E5%8A%A1%E7%AB%AF-toc" style="margin-left:80px;"><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF" rel="nofollow">服务端</a></p> 
<p id="%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%AB%AF-toc" style="margin-left:80px;"><a href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%AB%AF" rel="nofollow">小程序端</a></p> 
<p id="%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E-toc" style="margin-left:0px;"><a href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E" rel="nofollow">写在最后</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2>写在前面</h2> 
<p>本文介绍了springboot开发微信小程序后端服务中，用户登录功能的设计与实现，坚持看完相信对你有帮助。</p> 
<p>同时欢迎订阅springboot系列专栏，持续分享spring boot的使用经验。</p> 
<h2></h2> 
<h2 id="%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B">登录流程</h2> 
<p>如图：</p> 
<p><img alt="" height="1099" src="https://images2.imgbox.com/b8/70/rveRb3NX_o.png" width="1126"></p> 
<p>这是微信官方文档中微信小程序登录的流程时序图，我在图中红色序号标注的五步就是完整的微信小程序登录流程。</p> 
<h2></h2> 
<h2 id="%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90">流程解析</h2> 
<blockquote> 
 <ol><li>小程序端通过<code>wx.login()</code>获取用户登录凭证code。</li><li>小程序将code发送到服务端的登录接口。</li><li>服务端的登录接口使用该code、小程序的AppID和AppSecret向微信服务器发起请求，获取用户的openid。</li><li>服务端拿到openid后，可以根据业务需求生成用户令牌（Token），通常包括用户信息、权限等，并返回给小程序。</li><li>小程序在本地缓存该用户令牌。</li><li>后续小程序发起请求时，在请求头中携带该用户令牌(Token)。</li><li>服务端接收到请求时，验证用户令牌的有效性，确保用户是经过认证和授权的。</li></ol> 
</blockquote> 
<p></p> 
<h2 id="%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0">具体实现</h2> 
<p>登录接口设计思路</p> 
<blockquote> 
 <ol><li>接收小程序端传递的code参数。</li><li>使用code、小程序的AppID和AppSecret向微信服务器发起请求，获取用户的openid。</li><li>在数据库用户表中查询是否存在该openid。</li><li>如果存在该openid，则使用查询到的用户信息生成令牌(Token)。</li><li>如果不存在该openid，则进行用户注册操作，将新用户信息插入数据库用户表，并生成令牌(Token)。</li><li>返回生成的令牌(Token)给小程序端。</li></ol> 
</blockquote> 
<h3 id="%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81">相关代码</h3> 
<h4 id="%E8%AF%B4%E6%98%8E">说明</h4> 
<blockquote> 
 <p>下面代码基于jdk17，发请求用的时jdk自带的http工具类，如果你的jdk版本低于11，可以使用okhttp依赖来发请求，然后jwt相关工具类代码在我本专栏的其他文章里面，用到的ORM框架为mybatis-plus整合相关代码也在本专栏。</p> 
</blockquote> 
<h4 id="%E6%9C%8D%E5%8A%A1%E7%AB%AF">服务端</h4> 
<p>登录dto</p> 
<pre><code class="language-java">@Data
public class UserLoginDTO {
    @NotBlank(message = "code不能为空")
    private String code;

    private Map&lt;String,Object&gt; userInfo;//用户完善信息

}</code></pre> 
<p>登录返回vo</p> 
<pre><code class="language-java">@Data
@Builder
public class UserLoginVO implements Serializable {
    private Long id; //用户id

    private String openid;//用户在小程序唯一标识

    private String token;//用户登录凭证
   
}</code></pre> 
<p>获取openid方法</p> 
<p>使用的是jdk17自带的HttpClient,也可以使用okhttp,或者糊涂工具包里面的。</p> 
<pre><code class="language-java"> private String getOpenid(String code) {
        HttpClient httpClient = HttpClient.newHttpClient();
        // 构建请求参数字符串
        String params = String.format("appid=%s&amp;secret=%s&amp;js_code=%s&amp;grant_type=%s",
                URLEncoder.encode(wxMiniConfig.getAppId(), StandardCharsets.UTF_8),
                URLEncoder.encode(wxMiniConfig.getAppSecret(), StandardCharsets.UTF_8),
                URLEncoder.encode(code, StandardCharsets.UTF_8),
                URLEncoder.encode("authorization_code", StandardCharsets.UTF_8));

        // 创建 GET 请求
        String url = "https://api.weixin.qq.com/sns/jscode2session?" + params;
        HttpRequest httpRequest = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .build();

        try {
            // 发送 GET 请求
            HttpResponse&lt;String&gt; httpResponse = httpClient.send(httpRequest, HttpResponse.BodyHandlers.ofString());

            // 获取响应结果
            int statusCode = httpResponse.statusCode();
            String responseBody = httpResponse.body();
            JSONObject responseJson = JSONObject.parseObject(responseBody);
            String openid = responseJson.getString("openid");

            // 处理响应结果
            System.out.println("状态代码: " + statusCode);
            System.out.println("响应正文: " + responseBody);
            return  openid;
        } catch (Exception e) {
           log.error("发送请求时出错: {}", e.getMessage());
           return null;
        }
    }</code></pre> 
<p></p> 
<p>登录逻辑代码</p> 
<p>在判断出是新用户时，进行注册操作还需要将请求携带过来的userInfo完善信息，用户名，头像等一同封装进User对象再插入到数据库这里我就省略了</p> 
<pre><code class="language-java">    @Override
    public UserLoginVO login(UserLoginDTO userLoginDTO) {
        //获取openid
        String openid = getOpenid(userLoginDTO.getCode());
        if(StringUtils.isBlank(openid)){
            throw new GeneralBusinessException(ResultEnum.USER_OPENID_ERROR); // openid获取失败
        }

        User user = new LambdaQueryChainWrapper&lt;&gt;(userMapper).eq(User::getOpenid, openid).one();

        if(Objects.isNull(user)){
            // 用户不存在则注册
            user = new User();
            //获取完善信息，用户呢称、头像url
            userLoginDTO.getUserInfo
            //封装信息。。。。。。
            //。。。。。。。。。。
            
            user.setOpenid(openid);

            // 注册用户
            if(!this.save(user)){
                throw new GeneralBusinessException(ResultEnum.USER_REGISTER_FAIL); // 用户注册失败
            }
        }

        return UserLoginVO.builder()
                .id(user.getUserId())
                .openid(user.getOpenid())
                .token(jwtUtils.generateToken(Map.of("userId", user.getUserId()), "user"))
                .build();
    }</code></pre> 
<p></p> 
<h4 id="%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%AB%AF">小程序端</h4> 
<p><img alt="" height="795" src="https://images2.imgbox.com/52/e5/nLi7I4Cm_o.png" width="470"></p> 
<p>如图点击登录按钮会进行登录（注册）</p> 
<p>wxml:</p> 
<pre><code class="language-html"> &lt;button bindtap="handleLogin"&gt;登录&lt;/button&gt;</code></pre> 
<p>js:</p> 
<pre><code class="language-javascript">// 点击登录按钮时触发的方法
handleLogin: function() {
  // 调用微信登录接口获取 code
  wx.login({
    success: res =&gt; {
      const code = res.code;
      if (code) {
        // 调用微信登录接口获取用户信息
        wx.getUserProfile({
          desc: '用于完善会员资料',
          success: res =&gt; {
            const userInfo = res.userInfo;

            // 将 code 和用户信息发送到后端服务器进行登录验证
            wx.request({
              url: 'http://localhost:8080/user/login',
              method: 'POST',
              data: {
                code: code,
                userInfo: userInfo
              },
              success: res =&gt; {
                const { token } = res.data; // 假设后端返回包含 token 的数据
                if (token) {
                  // 登录成功，保存 token到本地存储
                  wx.setStorageSync('token', token);

                  // 跳转到主页或其他页面
                  wx.navigateTo({
                    url: '/pages/home/home'
                  });
                } else {
                  // 登录失败，显示提示信息
                  wx.showToast({
                    title: '登录失败，请重试',
                    icon: 'none'
                  });
                }
              },
              fail: err =&gt; {
                console.error('登录请求失败', err);
              }
            });
          },
          fail: err =&gt; {
            console.error('获取用户信息失败', err);
          }
        });
      } else {
        console.error('获取登录凭证失败', res.errMsg);
      }
    },
    fail: err =&gt; {
      console.error('调用登录接口失败', err);
    }
  });
}
</code></pre> 
<p>补充：实际开发中不会直接使用wx.request进行登录请求，一般都会进行封装，这里作为演示我就直接使用了，实际发送的post请求，请求体会携带code,和用户昵称、头像路径等信息。</p> 
<p></p> 
<h2 id="%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E">写在最后</h2> 
<p>本文完整的介绍了springboot开发微信小程序服务端中用户登录功能的设计思路,希望对你有帮助。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/176437101e4abc9d6d079afb713de7c8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用LM Studio与Anything LLM基于Llama-3高效构建本地知识库系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1541d08872e037e0be1d52363ffc5dd3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">打水问题（贪心算法）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>