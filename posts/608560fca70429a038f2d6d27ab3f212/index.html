<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Stable Diffusion 本地部署教程 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/608560fca70429a038f2d6d27ab3f212/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="Stable Diffusion 本地部署教程">
  <meta property="og:description" content="1.前言： 最近看Stable Diffusion开源了，据说比Disco Diffusion更快，于是从git上拉取了项目尝试本地部署了，记录分享一下过程~
这里是官网介绍：https://stability.ai/blog/stable-diffusion-public-release
2.必要前提： 科学上网。很多链接都需要用到。显卡的显存需要足够大，至于多大没看到哪有说，反正3g绝对不行 3.部署前准备： 本地化部署运行虽然很好，但是也有一些基本要求
（1）需要拥有NVIDIA显卡，GT1060起，显存4G以上。（已经不需要3080起，亲民不少）
（2）操作系统需要win10或者win11的系统。
MacOS平台本地化请见《如何在mac电脑上运行stable diffusion来做AI绘画》
（3）电脑内存16G或者以上。
（4）最好会魔法上网，否则网络波动，有些网页打不开，有时下载很慢。
（5）耐心，多尝试，多搜索。这个教程我已经重复过2次，因此很多问题基本上都踩坑并写出来了。所以请放心，能跑通的。
我的电脑配置供大家参考，Win10，I7，NVIDIA GT1050 4G，16G
生成一张20step的图大概20-30s（若使用更高性能的电脑，生成速度更快。）
4.使用的项目Stable diffusion WebUI项目 Stable diffusion大家都知道了，是当前最多人使用且效果最好的开源AI绘图软件之一，属于当红炸子鸡了。
不过，stable diffusion项目本地化的部署，是纯代码界面，使用起来对于非程序员没那么友好。
而stable diffusion webui，是基于stable diffusion 项目的可视化操作项目。
通过可视化的网页操作，更方便调试prompt，及各种参数。
同时也附加了很多功能，比如img2img功能，extra放大图片功能等等。
因此stable diffusion webui项目是很多人部署到本地的首选。
我们本教程就是以stable diffusion webui项目为例来操作的。
二、电脑环境配置 1.安装miniconda 这个是用来管理python版本的，他可以实现python的多版本切换。
下载地址：https://docs.conda.io/en/latest/miniconda.html
安装时按默认的一路next就行。
2.用管理员权限打开miniconda，输入conda -V 弹出版本号即为正确安装 3.配置库包下载环境，加快网络速度（替换下载库包地址为国内的清华镜像站） 执行下面
conda config --set show_channel_urls yes 生成.condarc 文件
在我的电脑/此电脑-C盘-users-你的账号名下用记事本打开并修改.condarc文件。（如我的路径是C:\Users\Administrator。）
把下面的内容全部复制进去，全部覆盖原内容，ctrl&#43;s保存，关闭文件。
channels: - defaults show_channel_urls: true default_channels: - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r - https://mirrors.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-05-08T17:21:17+08:00">
    <meta property="article:modified_time" content="2023-05-08T17:21:17+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Stable Diffusion 本地部署教程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_0"></a>1.前言：</h3> 
<p>最近看Stable Diffusion开源了，据说比Disco Diffusion更快，于是从git上拉取了项目尝试本地部署了，记录分享一下过程~<br> 这里是官网介绍：https://stability.ai/blog/stable-diffusion-public-release</p> 
<h3><a id="2_3"></a>2.必要前提：</h3> 
<ol><li>科学上网。很多链接都需要用到。</li><li>显卡的显存需要足够大，至于多大没看到哪有说，反正3g绝对不行</li></ol> 
<h3><a id="3_7"></a>3.部署前准备：</h3> 
<p>本地化部署运行虽然很好，但是也有一些基本要求</p> 
<p>（1）需要拥有NVIDIA显卡，GT1060起，显存4G以上。（已经不需要3080起，亲民不少）</p> 
<p>（2）操作系统需要win10或者win11的系统。</p> 
<p>MacOS平台本地化请见<a rel="nofollow">《如何在mac电脑上运行stable diffusion来做AI绘画》</a></p> 
<p>（3）电脑内存16G或者以上。</p> 
<p>（4）最好会魔法上网，否则网络波动，有些网页打不开，有时下载很慢。</p> 
<p>（5）耐心，多尝试，多搜索。这个教程我已经重复过2次，因此很多问题基本上都踩坑并写出来了。所以请放心，能跑通的。</p> 
<p>我的电脑配置供大家参考，Win10，I7，NVIDIA GT1050 4G，16G</p> 
<p>生成一张20step的图大概20-30s（若使用更高性能的电脑，生成速度更快。）</p> 
<h3><a id="4Stable_diffusion_WebUI_25"></a>4.使用的项目Stable diffusion WebUI项目</h3> 
<p>Stable diffusion大家都知道了，是当前最多人使用且效果最好的开源AI绘图软件之一，属于当红炸子鸡了。</p> 
<p>不过，stable diffusion项目本地化的部署，是纯代码界面，使用起来对于非程序员没那么友好。</p> 
<p>而stable diffusion webui，是基于stable diffusion 项目的可视化操作项目。</p> 
<p>通过可视化的网页操作，更方便调试prompt，及各种参数。</p> 
<p>同时也附加了很多功能，比如img2img功能，extra放大图片功能等等。<br> <img src="https://images2.imgbox.com/33/92/hSmGkBNA_o.png" alt="在这里插入图片描述"><br> 因此stable diffusion webui项目是很多人部署到本地的首选。</p> 
<p>我们本教程就是以stable diffusion webui项目为例来操作的。</p> 
<h2><a id="_39"></a>二、电脑环境配置</h2> 
<h3><a id="1miniconda_40"></a>1.安装miniconda</h3> 
<p>这个是用来管理python版本的，他可以实现python的多版本切换。<br> 下载地址：https://docs.conda.io/en/latest/miniconda.html<br> <img src="https://images2.imgbox.com/92/14/IbC1tSj9_o.png" alt="在这里插入图片描述"><br> 安装时按默认的一路next就行。</p> 
<h3><a id="2minicondaconda_V__45"></a>2.用管理员权限打开miniconda，输入conda -V 弹出版本号即为正确安装</h3> 
<p><img src="https://images2.imgbox.com/16/ee/Qm83D9wf_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3a/51/ndPsXq1H_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_48"></a>3.配置库包下载环境，加快网络速度（替换下载库包地址为国内的清华镜像站）</h3> 
<p>执行下面</p> 
<pre><code class="prism language-bash">conda config --set show_channel_urls <span class="token function">yes</span>
</code></pre> 
<p>生成.condarc 文件</p> 
<p>在我的电脑/此电脑-C盘-users-你的账号名下用记事本打开并修改.condarc文件。（如我的路径是C:\Users\Administrator。）</p> 
<p>把下面的内容全部复制进去，全部覆盖原内容，ctrl+s保存，关闭文件。</p> 
<pre><code class="prism language-bash">channels:
 - defaults
show_channel_urls: <span class="token boolean">true</span>
default_channels:
 - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main
 - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r
 - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2
custom_channels:
 conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
 msys2: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
 bioconda: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
 menpo: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
 pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
 pytorch-lts: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
 simpleitk: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
</code></pre> 
<p>运行conda clean -i 清除索引缓存，以确保使用的是镜像站的地址。<br> <img src="https://images2.imgbox.com/09/67/5uY09o1X_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4python_3106_77"></a>4.创建python 3.10.6版本的环境</h3> 
<p>运行下面语句，创建环境</p> 
<pre><code class="prism language-bash">conda create --name lmd <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.10</span>.6
</code></pre> 
<p>系统可能会提示y/n, 输入y，按回车即可。<br> 显示done，那就完成了。</p> 
<p>在你的C:\ProgramData\Miniconda3\envs\lmd已经创建了一个新的项目。</p> 
<h3><a id="5_86"></a>5.激活环境</h3> 
<p>输入conda activate lmd 回车。</p> 
<h3><a id="6pippip_88"></a>6.升级pip，并设置pip的默认库包下载地址为清华镜像。</h3> 
<p>每一行输入后回车，等执行完再输入下一行，再回车。</p> 
<pre><code class="prism language-bash">python -m pip <span class="token function">install</span> --upgrade pip
pip config <span class="token builtin class-name">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre> 
<p>不报错就是完成了。</p> 
<h3><a id="7gitgithubstable_diffusion_webui_95"></a>7.安装git，用来克隆下载github的项目，比如本作中的stable diffusion webui</h3> 
<p>前往git官网https://git-scm.com/download/win<br> <img src="https://images2.imgbox.com/c3/0a/pcMRhmie_o.png" alt="在这里插入图片描述"><br> 下载好后，一路默认安装，next即可。</p> 
<p>开始菜单找到git cmd。<br> 打开并输入下面指令。</p> 
<pre><code class="prism language-bash"><span class="token function">git</span> --version
</code></pre> 
<p>查看git的版本，显示了版本号即安装成功。<br> <img src="https://images2.imgbox.com/bd/ec/sFML6415_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="8cuda_107"></a>8.安装cuda</h3> 
<p>cuda是NVIDIA显卡用来跑算法的依赖程序，所以我们需要它。</p> 
<p>打开NVIDIA cuda官网，https://developer.nvidia.com/cuda-toolkit-archive<br> （这里有人可能会打不开网页，如果打不开，请用魔法上网。）</p> 
<p>你会发现有很多版本，下载哪个版本呢？<br> <img src="https://images2.imgbox.com/68/90/xAgRhewO_o.png" alt="在这里插入图片描述"><br> 回到一开始的miniconda的小窗，输入nvidia-smi，查看你的cuda版本<br> <img src="https://images2.imgbox.com/d6/d5/w3zgX8Si_o.png" alt="在这里插入图片描述"><br> 比如我的是12.1的版本，我就下载12.1.0的链接</p> 
<p>下载完后安装，这个软件2个G，可以安装在c盘以外的地方。比如D盘。</p> 
<p>好了，完成这步，电脑的基础环境设置终于完事了。</p> 
<p>下面开始正式折腾stable diffusion了。<br> <em><strong>注意：如果提示此命令nvidia-smi，非内部命令时，按以下操作</strong></em><br> 把此路径：C:\Program Files\NVIDIA Corporation\NVIDIA NvDLISR，放入到环境变量中<br> 显卡所在路径：<br> <img src="https://images2.imgbox.com/1b/b2/j0f347zt_o.png" alt="在这里插入图片描述"><br> 环境变量位置：<br> <img src="https://images2.imgbox.com/64/91/Zz8FFZXQ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="stable_diffusion_131"></a>三、stable diffusion环境配置</h2> 
<h3><a id="1stable_diffusion_132"></a>1.下载stable diffusion源码</h3> 
<p>确认你的miniconda黑色小窗显示的是(把stable看成是lmd就行)<br> <img src="https://images2.imgbox.com/e3/aa/WfyLLuZK_o.png" alt="在这里插入图片描述"><br> 如果不是，则输入D: 按回车。</p> 
<p>当然你也可以放在其他你想放的盘的根目录里面。</p> 
<p>不建议放在c盘，因为这个项目里面有一些模型包，都是几个G几个G的，很容易你的C盘就满了，其他盘容量在10G以上的就都行。</p> 
<p>再来克隆stable diffusion webui项目（下面简称sd-webui）</p> 
<p>接着执行</p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
</code></pre> 
<p>注意，现在克隆的本地地址，就是下面经常提到的“项目根目录”。比如，我的项目根目录是D:\stable-diffusion-webui</p> 
<h3><a id="2stable_diffusion_148"></a>2.下载stable diffusion的训练模型</h3> 
<p>地址：https://huggingface.co/CompVis/stable-diffusion-v-1-4-original/tree/main</p> 
<p>点击file and versions选项卡，下载sd-v1-4.ckpt训练模型。</p> 
<p>（需要注册且同意协议，注册并同意协议之后即可下载）<br> <img src="https://images2.imgbox.com/fc/ac/Yh8kD1Jy_o.png" alt="在这里插入图片描述"><br> 注：这个模型是用于后续生成AI绘图的绘图元素基础模型库。</p> 
<p>后面如果要用waifuai或者novelai，其实更换模型放进去sd-webui项目的模型文件夹即可。</p> 
<p>我们现在先用stable diffusion 1.4的模型来继续往下走。</p> 
<h3><a id="3_160"></a>3.更改训练模型名称</h3> 
<p>下载好之后，请把模型更名成model.ckpt,然后放置在sd-webui的models/stable-diffusion目录下。比如我的路径是D:\stable-diffusion-webui\models\Stable-diffusion<br> <img src="https://images2.imgbox.com/dc/1a/MMmpvGSo_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_GFPGAN_163"></a>4. 安装GFPGAN</h3> 
<p>这是腾讯旗下的一个开源项目，可以用于修复和绘制人脸，减少stable diffusion人脸的绘制扭曲变形问题<br> 地址：https://github.com/TencentARC/GFPGAN<br> 把网页往下拉，拉到readme.md部分，找到V1.4 model，点击蓝色的1.4就可以下载。<br> <img src="https://images2.imgbox.com/ed/a4/x2PxBl5x_o.png" alt="在这里插入图片描述"><br> 下载好之后，放在sd-webui项目的根目录下面即可，比如我的根目录是D:\stable-diffusion-webui</p> 
<h3><a id="4minicondaaisdwebui_169"></a>4.在miniconda的黑色小窗，准备开启运行ai绘图程序sd-webui</h3> 
<p>输入</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> stable-diffusion-webui
</code></pre> 
<p>进入项目的根目录。</p> 
<p>切记，一定要进入sd-webui的项目根目录后，才能执行下面的指令，否则会报错。</p> 
<p>接着执行</p> 
<pre><code class="prism language-bash">webui-user.bat
</code></pre> 
<p>然后回车，等待系统自动开始执行。</p> 
<p>直到系统提示，running on local URL: http://127.0.0.1:7860</p> 
<p>这就代表，你可以开始正式使用AI画画啦~<br> <img src="https://images2.imgbox.com/30/f3/igdQNsnc_o.png" alt="在这里插入图片描述"></p> 
<p>注意：</p> 
<p>这一步可能经常各种报错，需要耐心和时间多次尝试。</p> 
<p>不要关闭黑色小窗，哪怕它几分钟没有任何变化。</p> 
<p>如果提示连接错误，可能需要开启或者关闭魔法上网，再重新执行webui-user.bat命令。</p> 
<p>如果不小心退出了黑色窗口，则重新点击：开始菜单-程序-打开miniconda窗口，输入</p> 
<pre><code class="prism language-bash">conda activate lmd
</code></pre> 
<p>并进入sd-webui项目根目录再执行</p> 
<pre><code class="prism language-bash">webui-user.bat
</code></pre> 
<h2><a id="_206"></a>四、开始作画和调试</h2> 
<h3><a id="1http1270017860miniconda_207"></a>1.在浏览器，（比如谷歌浏览器），打开http://127.0.0.1:7860（注意，不要关闭miniconda的黑色窗口）</h3> 
<p><img src="https://images2.imgbox.com/1d/73/5dHaLpj0_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2promptbeautiful_landscapegenerate_209"></a>2.在prompt区域输入相关指令，比如beautiful landscape，然后点击右边的generate，即可生成第一张图片啦。</h3> 
<p><img src="https://images2.imgbox.com/63/21/ih7GcsyV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_211"></a>3.生成的状态和操作</h3> 
<p>网页会显示进度条，miniconda的黑色小窗也会显示进度条。</p> 
<p>等进度条跑满，就能看到你生成的图啦。</p> 
<p>如果不想生成了，可以点击interrupt停止生成，就会返回你目前为止已经生成的图片。（比如你要生成10张，已经生成了3张，点击interrupt，就会返回3张图片）</p> 
<p>如果点击skip，就会跳过本张图片的生成，比如你想生成10张图，现在生成第3张，点击skip，第三张就不生成了，直接开始生成第四张，最后返回9张图片。<br> <img src="https://images2.imgbox.com/ea/25/6SLr5azx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4batch_count_220"></a>4.修改batch count数值，一次性生成多张图片</h3> 
<p>默认是1，一次性生成1张。</p> 
<p>建议一次性生成4张或者以上，这样获得满意的图片概率会大一些，可以最多一次性生成最多100张。<br> <img src="https://images2.imgbox.com/83/ee/tzyhHRtG_o.png" alt="在这里插入图片描述"></p> 
<p>但写得越大，一次性生成花费的时间越长，假设一张图30秒，设置10张就是300s，5分钟，100张则是3000s，50分钟。</p> 
<h3><a id="5_227"></a>5.好了，那现在就本地化部署完毕了，可以开始愉快地玩耍啦，祝你玩得开心~</h3> 
<h2><a id="_229"></a>五、安装过程中的错误处理</h2> 
<h3><a id="1SD_WebUIOpen_Clip_230"></a>1、新版SD WebUI卡安装Open_Clip解决方法</h3> 
<p>https://www.bilibili.com/read/cv21253533</p> 
<h3><a id="2Stable_Diffusion_V2StabilityAI_232"></a>2、Stable Diffusion V2-Stability-AI处理</h3> 
<p>https://gitee.com/jerrylinkun/stable-diffusion-v2-stability-ai?_from=gitee_search</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8aa7e408c6096bee6cd824e9201d0093/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LOAM、Lego-liom、Lio-sam轨迹保存，与Kitti数据集真值进行评估</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3a15b46298d4a450dce00aaece0db138/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何将时间戳转化为年月日时分秒格式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>