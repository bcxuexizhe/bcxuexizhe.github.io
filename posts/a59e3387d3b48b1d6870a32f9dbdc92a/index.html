<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>uniapp前端从零开始搭建一套mqtt服务 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/a59e3387d3b48b1d6870a32f9dbdc92a/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="uniapp前端从零开始搭建一套mqtt服务">
  <meta property="og:description" content="搭建mqtt服务器 参考：【MQTT】| 搭建——在云服务器上搭建MQTT服务器_mqtt服务器搭建-CSDN博客
如果服务器执行命令出现“Error: Failed to synchronize cache for repo ‘AppStream‘”的问题
解决方法：https://www.jianshu.com/p/a95e9d6d22e9
uniapp 使用MQTT连接服务器 npm install mqtt@3.0.0 npm install uuid 使用npm引入3.0.0版本的，最新版会有点小问题，uuid用来生成clientId唯一标识，用同一个标识的话会把其他相同标识的客户端踢下线
uniapp demo，直接拿来就能用 u-popup是uview-ui的弹窗组件uView 2.0 - 全面兼容 nvue 的 uni-app 生态框架 - uni-app UI 框架
mqtt的js文件mqtt (v5.0.5) - A library for the MQTT protocol | BootCDN - Bootstrap 中文网开源项目免费 CDN 加速服务 创建一个mqtt.js文件复制进去就好
真机调试mqtt5会报错，改用mqtt3
&lt;template&gt; &lt;view class=&#34;content&#34;&gt; &lt;button type=&#34;default&#34; v-if=&#34;!client||!client.connected&#34; @click=&#34;connect&#34;&gt;连接&lt;/button&gt; &lt;button type=&#34;default&#34; v-if=&#34;client&amp;&amp;client.connected&#34; @click=&#34;end&#34;&gt;断开&lt;/button&gt; &lt;button type=&#34;default&#34; v-if=&#34;!subscribeStatus&#34; @click=&#34;subscribe&#34;&gt;订阅&lt;/button&gt; &lt;button type=&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-24T15:52:41+08:00">
    <meta property="article:modified_time" content="2024-01-24T15:52:41+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">uniapp前端从零开始搭建一套mqtt服务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>搭建mqtt服务器</h3> 
<p>参考：<a href="https://blog.csdn.net/weixin_43822014/article/details/131364096" title="【MQTT】| 搭建——在云服务器上搭建MQTT服务器_mqtt服务器搭建-CSDN博客">【MQTT】| 搭建——在云服务器上搭建MQTT服务器_mqtt服务器搭建-CSDN博客</a></p> 
<p>如果服务器执行命令出现“Error: Failed to synchronize cache for repo ‘AppStream‘”的问题</p> 
<p>解决方法：https://www.jianshu.com/p/a95e9d6d22e9</p> 
<h3>uniapp 使用MQTT连接服务器</h3> 
<pre><code>npm install mqtt@3.0.0
npm install uuid
</code></pre> 
<p>使用npm引入3.0.0版本的，最新版会有点小问题，uuid用来生成clientId唯一标识，用同一个标识的话会把其他相同标识的客户端踢下线</p> 
<h3>uniapp demo，直接拿来就能用</h3> 
<p>u-popup是uview-ui的弹窗组件<a href="https://www.uviewui.com/" rel="nofollow" title="uView 2.0 - 全面兼容 nvue 的 uni-app 生态框架 - uni-app UI 框架">uView 2.0 - 全面兼容 nvue 的 uni-app 生态框架 - uni-app UI 框架</a></p> 
<p>mqtt的js文件<a href="https://www.bootcdn.cn/mqtt/" rel="nofollow" title="mqtt (v5.0.5) - A library for the MQTT protocol | BootCDN - Bootstrap 中文网开源项目免费 CDN 加速服务">mqtt (v5.0.5) - A library for the MQTT protocol | BootCDN - Bootstrap 中文网开源项目免费 CDN 加速服务</a> 创建一个mqtt.js文件复制进去就好</p> 
<p>真机调试mqtt5会报错，改用mqtt3</p> 
<pre><code class="language-html">&lt;template&gt;
	&lt;view class="content"&gt;
		&lt;button type="default" v-if="!client||!client.connected" @click="connect"&gt;连接&lt;/button&gt;
		&lt;button type="default" v-if="client&amp;&amp;client.connected" @click="end"&gt;断开&lt;/button&gt;
		&lt;button type="default" v-if="!subscribeStatus" @click="subscribe"&gt;订阅&lt;/button&gt;
		&lt;button type="default" v-if="subscribeStatus" @click="unsubscribe"&gt;取消订阅&lt;/button&gt;
		&lt;button type="default" @click="open"&gt;发送&lt;/button&gt;
		&lt;view&gt;状态:{<!-- -->{clientStatus?'已连接':'未连接'}}&lt;/view&gt;
		&lt;view class="string"&gt;
			&lt;view class="string" v-for="(item, index) in stringArr" :key="index"
				style="display:flex;padding: 10rpx;box-sizing: border-box;width: 100%;border-bottom: 1rpx solid #000;justify-content: center;"&gt;
				&lt;text
					style="width:90%;display:inline-block;white-space: pre-wrap; word-wrap: break-word;height: auto;"&gt;{<!-- -->{item}}&lt;/text&gt;
			&lt;/view&gt;
		&lt;/view&gt;
		&lt;u-popup :show="show" @close="close" mode="center"&gt;
			&lt;view style="padding: 20rpx;"&gt;
				&lt;u--input placeholder="请输入数据" border="surround" v-model="writeDataValue"&gt;&lt;/u--input&gt;
				&lt;button @click="publish()"&gt;确定&lt;/button&gt;
			&lt;/view&gt;
		&lt;/u-popup&gt;
	&lt;/view&gt;
&lt;/template&gt;

&lt;script&gt;
	import {
		v4
	} from 'uuid';
	var mqtt = require('mqtt/dist/mqtt.js')
	const MQTT_IP = '192.xxx.x.xxx:8083/mqtt' //mqtt地址端口, 使用emqx时一定要加mqtt
	const MQTT_USERNAME = '' //mqtt用户名
	const MQTT_PASSWORD = '' //密码

	const MQTT_OPTIONS = {
		connectTimeout: 5000,
		clientId: '',
		username: MQTT_USERNAME,
		password: MQTT_PASSWORD,
		clean: true
	}
	export default {
		data() {
			return {
				client: {
					connected: false,
				},
				topic: 'testtopic/', //要订阅的主题
				show: false,
				writeDataValue: "world",
				clientStatus: false,
				subscribeStatus: false,
				stringArr: [],
			}
		},
		methods: {
			open() {
				if (!this.clientStatus) {
					uni.showToast({
						title: "请连接",
						icon: "none"
					})
					return;
				}
				this.show = true;
			},
			close() {
				this.show = false;
			},
			async connect() {
				let status = await uni.getNetworkType();
				if (status.networkType === "none") {
					uni.showToast({
						title: "请检查网络连接是否正常",
						icon: "none"
					})
					return;
				}
				uni.showLoading({
					title: 'Loading...'
				});
				MQTT_OPTIONS.clientId = v4();
				var that = this;
				// #ifdef H5
				that.client = mqtt.connect('ws://' + MQTT_IP, MQTT_OPTIONS)
				// #endif
				// #ifdef MP-WEIXIN||APP-PLUS
				that.client = mqtt.connect('wx://' + MQTT_IP, MQTT_OPTIONS)
				// #endif
				that.stringArr = [];
				that.clientStatus = false;
				that.subscribeStatus = false;
				that.client.on('connect', function() {
					uni.showToast({
						title: "连接成功",
						icon: "none"
					})
					console.log('连接成功');
					uni.hideLoading();
					that.clientStatus = true;
					that.subscribe();
				});
				that.client.on('reconnect', function(error) {
					console.log('正在重连...', that.topic)
					uni.getNetworkType({
						success: function(res) {
							console.log(res
								.networkType); //网络类型 wifi、2g、3g、4g、ethernet、unknown、none
							if (res.networkType === "none") {
								console.log("当前无网络");
								that.end();
							} else {
								console.log("有网络");
								uni.showToast({
									title: "正在重连...",
									icon: "none"
								})
								uni.showLoading({
									title: 'Loading...'
								});
							}
						}
					})
				});
				// 掉线
				that.client.on('offline', (msg) =&gt; {
					console.log('掉线', msg);
					uni.showToast({
						title: '掉线',
						icon: 'none',
					})
				});
				that.client.on('error', function(error) {
					console.log('连接失败...', error);
					uni.showToast({
						title: "连接失败...",
						icon: "none"
					})
					uni.hideLoading();
				});
				that.client.on('end', function() {
					console.log('连接断开')
					uni.showToast({
						title: "连接断开",
						icon: "none"
					})
					uni.hideLoading();
					that.client = {};
					that.stringArr = [];
					that.clientStatus = false;
					that.subscribeStatus = false;
				});
				that.client.on('message', function(topic, message) {
					console.log('接收推送信息：', message.toString())
					that.stringArr.unshift(message.toString());
				})
			},
			// 发布
			publish() {
				var that = this;
				if (!this.clientStatus) {
					uni.showToast({
						title: "请连接",
						icon: "none"
					})
					return;
				}
				that.client.publish(that.topic, that.writeDataValue, {}, function(err) {
					if (!err) {
						console.log('发送成功');
						that.close();
						uni.showToast({
							title: "发送成功",
							icon: "none"
						})
					}
				})
			},
			// 订阅
			subscribe() {
				var that = this;
				if (!this.clientStatus) {
					uni.showToast({
						title: "请连接",
						icon: "none"
					})
					return;
				}
				that.client.subscribe(that.topic, function(err) {
					if (!err) {
						console.log('订阅成功');
						uni.showToast({
							title: "订阅成功",
							icon: "none"
						})
						that.subscribeStatus = true;
					}
				})
			},
			// 取消订阅
			unsubscribe() {
				var that = this;
				if (!this.clientStatus) {
					uni.showToast({
						title: "请连接",
						icon: "none"
					})
					return;
				}
				that.client.unsubscribe(that.topic, function(err) {
					if (!err) {
						console.log('取消订阅成功');
						uni.showToast({
							title: "取消订阅成功",
							icon: "none"
						})
						that.subscribeStatus = false;
					}
				})
			},
			// 断开
			end() {
				var that = this;
				that.client.connected = false;// 移动端不加这个关闭回调不会触发
				that.client.end(true, (err) =&gt; {
					if (err) {
						that.client.connected = true;
					} else {
						console.log('断开成功')
						that.stringArr = [];
					}
				});
			}
		}
	}
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
	.content {
		height: 100%;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;

		button {
			margin-top: 10px;
		}
	}

	.string {
		width: 100%;
		flex: 1;
		overflow-y: scroll;
	}

	.list {
		padding: 20rpx;

		view {
			display: flex;
			justify-content: space-around;
		}
	}
&lt;/style&gt;</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8ce4cbd023bb6b171b10a1807a543805/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【idea插件开发】idea插件访问浏览器web地址</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9a3088a5645d9166f777cb4f7a698ddf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JSON-handle工具安装及使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>