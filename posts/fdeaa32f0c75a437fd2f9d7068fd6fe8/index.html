<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Stable Diffusion 跑通总结 - 编程学习者</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcxuexizhe.github.io/posts/fdeaa32f0c75a437fd2f9d7068fd6fe8/">
  <meta property="og:site_name" content="编程学习者">
  <meta property="og:title" content="Stable Diffusion 跑通总结">
  <meta property="og:description" content="记录了自己跑通Stable Diffusion的过程和踩过的坑，目前只是初步跑了一下，没有很深入的使用代码，希望能有一些参考价值。
在Windows系统运行，需要提前装好Conda
一、下载代码和模型 1、下载代码： 代码下载：代码地址
或者
git clone https://github.com/CompVis/stable-diffusion.git 2、下载预训练模型： a.下载sd-v1-4.ckpt模型 地址：模型地址
按照下列顺序点击下载模型
红圈模型有4G，下面的模型有7G，自行选择下载
在stable-diffusion-main\models\ldm路径下创建文件夹stable-diffusion-v1，将模型放在里面将模型名称改为model.ckpt b.下载clip-vit-large-patch14模型 模型地址
下载红框内文件。
放置在路径stable-diffusion-main\openai\clip-vit-large-patch14下，自己创建路径。 c.下载safety_checker模型 模型地址
依旧下载红框内文件
文件存放在stable-diffusion-main\CompVis\stable-diffusion-safety-checker下，自行创建路径。将这次下载的safety_checker_config文件命名为config.json将上一块中下载的preprocessor_config.json文件粘贴过来 二、配置环境 使用conda配置环境，在Anaconda Prompt下指向stable-diffusion-main文件夹，运行：
conda env create -f environment.yaml 报错：
Installing pip dependencies: - Ran pip subprocess with arguments: [&#39;C:\Users\neals\.conda\envs\ldm\python.exe&#39;, &#39;-m&#39;, &#39;pip&#39;, &#39;install&#39;, &#39;-U&#39;, &#39;-r&#39;, &#39;I:\tmp\sd\stable-diffusion-main\condaenv.wws0680u.requirements.txt&#39;, &#39;--exists-action=b&#39;] Pip subprocess output: Obtaining taming-transformers from git&#43;https://github.com/CompVis/taming-transformers.git@master#egg=taming-transformers (from -r I:\tmp\sd\stable-diffusion-main\condaenv.wws0680u.requirements.txt (line 17)) Cloning https://github.com/CompVis/taming-transformers.git (to revision master) to i:\tmp\sd\stable-diffusion-main\src\taming-transformers Pip subprocess error: ERROR: Command errored out with exit status 128: git clone -q https://github.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-09T21:04:40+08:00">
    <meta property="article:modified_time" content="2023-12-09T21:04:40+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程学习者" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程学习者</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Stable Diffusion 跑通总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>记录了自己跑通Stable Diffusion的过程和踩过的坑，目前只是初步跑了一下，没有很深入的使用代码，希望能有一些参考价值。</p> 
<p> 在Windows系统运行，需要提前装好Conda</p> 
<h2>一、下载代码和模型</h2> 
<h3>1、下载代码：</h3> 
<p>代码下载：<a href="https://github.com/CompVis/stable-diffusion" title="代码地址">代码地址</a></p> 
<p>或者</p> 
<pre><code class="hljs">git clone https://github.com/CompVis/stable-diffusion.git</code></pre> 
<h3>2、下载预训练模型：</h3> 
<h4>a.下载sd-v1-4.ckpt模型</h4> 
<p>地址：<a href="https://huggingface.co/CompVis/stable-diffusion" rel="nofollow" title="模型地址">模型地址</a></p> 
<p>按照下列顺序点击下载模型</p> 
<p><img alt="" height="277" src="https://images2.imgbox.com/9d/50/SDCBMIWA_o.png" width="408"></p> 
<p><img alt="" height="226" src="https://images2.imgbox.com/80/21/aUDpLjFb_o.png" width="409"></p> 
<p>红圈模型有4G，下面的模型有7G，自行选择下载</p> 
<ul><li>在stable-diffusion-main\models\ldm路径下创建文件夹stable-diffusion-v1，将模型放在里面</li><li>将模型名称改为model.ckpt</li></ul> 
<p><img alt="" height="100" src="https://images2.imgbox.com/85/e5/WCRCzeRc_o.png" width="268"></p> 
<h4></h4> 
<h4>b.下载clip-vit-large-patch14模型</h4> 
<p><a href="https://huggingface.co/openai/clip-vit-large-patch14/tree/main" rel="nofollow" title="模型地址">模型地址</a></p> 
<p><img alt="" height="345" src="https://images2.imgbox.com/24/13/m1oey91q_o.png" width="436"></p> 
<p>下载红框内文件。</p> 
<ul><li>放置在路径stable-diffusion-main\openai\clip-vit-large-patch14下，自己创建路径。</li></ul> 
<p><img alt="" height="224" src="https://images2.imgbox.com/a8/a5/HlAq7fEu_o.png" width="274"></p> 
<p></p> 
<h4>c.下载safety_checker模型</h4> 
<p><a href="https://huggingface.co/CompVis/stable-diffusion-v1-4/tree/main/safety_checker" rel="nofollow" title="模型地址">模型地址</a></p> 
<p><img alt="" height="188" src="https://images2.imgbox.com/59/5b/6n08tK2T_o.png" width="396"></p> 
<p>依旧下载红框内文件</p> 
<ul><li>文件存放在stable-diffusion-main\CompVis\stable-diffusion-safety-checker下，自行创建路径。</li><li>将这次下载的safety_checker_config文件命名为config.json</li><li>将上一块中下载的preprocessor_config.json文件粘贴过来</li></ul> 
<p><img alt="" height="148" src="https://images2.imgbox.com/1b/d0/CAF8PtRL_o.png" width="300"></p> 
<h2>二、配置环境</h2> 
<p>使用conda配置环境，在Anaconda Prompt下指向stable-diffusion-main文件夹，运行：</p> 
<pre><code class="hljs">conda env create -f environment.yaml</code></pre> 
<p>报错：</p> 
<pre><code class="hljs">Installing pip dependencies: - Ran pip subprocess with arguments:
['C:\Users\neals\.conda\envs\ldm\python.exe', '-m', 'pip', 'install', '-U', '-r', 'I:\tmp\sd\stable-diffusion-main\condaenv.wws0680u.requirements.txt', '--exists-action=b']
Pip subprocess output:
Obtaining taming-transformers from git+https://github.com/CompVis/taming-transformers.git@master#egg=taming-transformers (from -r I:\tmp\sd\stable-diffusion-main\condaenv.wws0680u.requirements.txt (line 17))
Cloning https://github.com/CompVis/taming-transformers.git (to revision master) to i:\tmp\sd\stable-diffusion-main\src\taming-transformers
Pip subprocess error:
ERROR: Command errored out with exit status 128: git clone -q https://github.com/CompVis/taming-transformers.git 'I:\tmp\sd\stable-diffusion-main\src\taming-transformers' Check the logs for full command output.
failed
CondaEnvException: Pip failed</code></pre> 
<p>将environment.yaml中的这两行删掉：</p> 
<pre><code class="hljs">- -e git+https://github.com/CompVis/taming-transformers.git@master#egg=taming-transformers
- -e git+https://github.com/openai/CLIP.git@main#egg=clip</code></pre> 
<p>改用pip命令自己手动配置这两个包：</p> 
<pre><code class="hljs">pip install taming-transformers
pip install clip</code></pre> 
<p>但是environment.yaml总是报错或者conda总是卡住，把文件里pip后的部分用一个requirements.txt存储，使用pip安装：（如果pytorch这些没装上就手动安装一下）</p> 
<pre><code class="hljs">pip install -r requirements.txt</code></pre> 
<p>下载太慢就给pip配上清华源，<a href="https://mirrors.tuna.tsinghua.edu.cn/help/pypi/" rel="nofollow" title="教程">教程</a></p> 
<h2>三、运行代码</h2> 
<p>我运行的是文本生成图像任务，在终端中输入指令：</p> 
<pre><code class="hljs">python scripts/txt2img.py --prompt "a photograph of an astronaut riding a horse" --plms </code></pre> 
<p>运气好的话直接就能生成图像，生成的图像存储在outputs\txt2img-samples\samples下。</p> 
<p></p> 
<h3>报错 ModuleNotFoundError: No module named ‘ldm’：</h3> 
<p>这里报错的ldm是指stable-diffusion-main文件夹下的ldm文件夹。</p> 
<p>解决方法：</p> 
<p>将scripts文件夹下的所有内容复制到stable-diffusion-main文件夹下，指令改为：</p> 
<pre><code class="hljs">python txt2img.py --prompt "a photograph of an astronaut riding a horse" --plms </code></pre> 
<p></p> 
<h3>报错 ImportError: cannot import name '<a href="https://so.csdn.net/so/search?q=VectorQuantizer2&amp;spm=1001.2101.3001.7020" title="VectorQuantizer2">VectorQuantizer2</a>' from 'taming.modules.vqvae.quantize'</h3> 
<p>原因：taming库的版本问题</p> 
<p>解决方法：</p> 
<p>将stable-diffusion-main\ldm\models下的autoencoder.py中的：</p> 
<pre><code class="hljs">from taming.modules.vqvae.quantize import VectorQuantizer2 as VectorQuantizer</code></pre> 
<p>改为：</p> 
<pre><code class="hljs">from taming.modules.vqvae.quantize import VectorQuantizer</code></pre> 
<p></p> 
<h3>报错：RuntimeError: CUDA out of memory.</h3> 
<p>原因：显卡的内存不够</p> 
<p>可能的解决方法：</p> 
<p>在终端里使用指令：</p> 
<pre><code class="hljs">python txt2img.py --prompt "a photograph of an astronaut riding a horse" --plms --n_samples 1</code></pre> 
<p>设置n_samples=1运行，或者在txt2img.py文件中修改这个参数为1。</p> 
<p>n_samples的注释是：how many samples to produce for each given prompt. A.k.a. batch size</p> 
<p>如果更改后还是内存不够，可以去看看有没有什么其他的参数可以修改，试试能不能减少显卡用量。</p> 
<p></p> 
<h3>报错couldn't connect to 'https://huggingface.co'</h3> 
<p>原因：没有搜索到本地下载好的模型，试图连接https://huggingface.co失败</p> 
<p>检查模型是否下好了，位置和命名是否正确。</p> 
<p></p> 
<h3></h3> 
<h3>跑通后的生成的一些图像：</h3> 
<p><img alt="" height="140" src="https://images2.imgbox.com/1e/bf/xvjjOwRh_o.png" width="604"></p> 
<p></p> 
<p>参考链接，感谢大佬们的指点：</p> 
<p><a href="https://blog.csdn.net/lsb2002/article/details/131534772" title="AIGC：文生图模型Stable Diffusion-CSDN博客">AIGC：文生图模型Stable Diffusion-CSDN博客</a></p> 
<p><a href="https://blog.csdn.net/weixin_42570231/article/details/130913736" title="latent diffusion model 复现问题记录-CSDN博客">latent diffusion model 复现问题记录-CSDN博客</a></p> 
<p><a href="https://blog.csdn.net/fovever_/article/details/131926163" title="Diffusion程序调试相关问题汇总-CSDN博客">Diffusion程序调试相关问题汇总-CSDN博客</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/24f2dc07c61abc76d82c192518d8ea74/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL：1118 - Row size too large（行大小不能超过 65535 问题）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/052380db598c1523484a1a0ce37cf81e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">头歌实践教学平台Python-Python第七章集合与字典作业</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程学习者.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>